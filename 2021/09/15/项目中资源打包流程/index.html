<!DOCTYPE html><meta name="viewport" content="height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cwhisme"><meta name="author" content="CWHISME"><meta property="og:title" content="项目中资源打包流程"><meta property="og:description" content="cwhisme"><meta property="og:site_name" content="WangJiaYing"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>项目中资源打包流程 - WangJiaYing</title><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/DateTimeAfeterCalc.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/particles-bg.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/script.js"></script><link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/css/style.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="WangJiaYing" type="application/atom+xml">
</head><body><canvas id="hackEffectCanvas" style="position:fixed;z-index:-1;pointer-events:none"></canvas><canvas class="fireworks" style="position:fixed;z-index:10;pointer-events:none"></canvas><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="WangJiaYing"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/logo.svg" class="dib h3" alt="WangJiaYing"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags" title="Tags">Tags </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/categories" title="Categories">Categories </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/bookmark" title="Bookmark">Bookmark </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="About">About</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">项目中资源打包流程</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2021-09-15&nbsp&nbsp <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="dateTimeAfter">2021-09-15</span></p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-snowflake-o"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><div class="tags-container-vertical"><div class="tags-sub-container"><a class="fw3 ph1 dib" href="/tags/AssetBundle/">#AssetBundle</a></div></div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在我们项目中，资源打包主要通过 AssetLable 的功能对需要打包的对象进行搜集：</p><p>按照指定规则设置资源的 AssetLable ，然后通过 AssetLable 再分类搜集资源，采用自定义容器管理资源引用，设置 AssetBundleName，最终出包。</p><p>在对代码走了一个流程后，将流程大概流程记一下，做做记录。</p><h2 id="标签功能"><a href="#标签功能" class="headerlink" title="标签功能"></a>标签功能</h2><ol><li>在Unity搜索栏输入『l:Name』可以直接查找到所有指定标记的资源<br>例如：<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-09-15/m_557d8a3e3609e83c7a39eae318995b8a_r.png"></li><li>代码中通过 AssetDatabase.FindAssets 获取所有指定标签资源<br>例如通过该功能获取所有标签为 “Name” 的资源：<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AssetDatabase.FindAssets(<span class="string">&quot;l:Name&quot;</span>, <span class="keyword">new</span> <span class="built_in">string</span>[<span class="number">1</span>] &#123; <span class="string">&quot;Assets/Resources&quot;</span> &#125;);</span><br></pre></td></tr></table></figure></li><li>对指定资源的标签操作：<ul><li>AssetDatabase.GetLabels：获取</li><li>AssetDatabase.SetLabels: 设置</li><li>AssetDatabase.ClearLabels: 清除</li></ul></li></ol><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>目前我们项目实际使用流程如下：</p><ul><li>按照指定规则设置对应的 AssetLabel(可称为初始化资源环境，如果有设置过，该步骤其实可跳过)</li><li>获取所有打上标签资源</li><li>然后获取文件列表(包括列表中每个资源对应的引用[AssetDatabase.GetDependencies])，转化为自定义引用管理容器(EditorAssetData)存放，各种依赖信息</li><li>上述步骤每个资源都已通过 AssetDatabase.GetDependencies 获取到了自己的引用资源，这些生成的 EditorAssetData 目前统一存放于一个字典中，此时设置每个资源引用实际对应的 EditorAssetData 上下级依赖<blockquote><p>注：这里 GetDependencies 获取后会剔除自身，因此相当于在这打断了下级资源造成的循环引用。</p></blockquote>如下代码所示：循环所有搜集资源，首先将每个资源的所有下级(即包括下级的下级)引用加入自身，然后循环直接下级，将自身设置为下一级的父引用<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">EditorAssetData[] _array = dic.Values.ToArray();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; _count; ++i)</span><br><span class="line">&#123;</span><br><span class="line">	EditorAssetData _info = _array[i];</span><br><span class="line">	<span class="built_in">int</span> _listCount = _info.DownDependentPathList.Count;</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; _listCount; ++j)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">string</span> _downPath = _info.DownDependentPathList[j];</span><br><span class="line">		<span class="keyword">if</span> (dic.ContainsKey(_downPath))</span><br><span class="line">		&#123;</span><br><span class="line">			_info.AddDownDependence(dic[_downPath]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	_listCount = _info.NoRecursiveDownDependentPathList.Count;</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; _listCount; ++j)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">string</span> _downPath = _info.NoRecursiveDownDependentPathList[j];</span><br><span class="line">		<span class="keyword">if</span> (dic.ContainsKey(_downPath))</span><br><span class="line">		&#123;</span><br><span class="line">			dic[_downPath].AddUpDependence(_info);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>所以，实际上我们项目加载一个资源，是会同时帮忙加载下一级，以及下级资源的引用的(平级加载所有依赖)。</p></blockquote></li><li>按照一定规则整理资源，如一个资源最顶级对其的引用(递归上级资源)、上级依赖大于1的当做公共资源单独打包</li><li>重复名提示</li><li>在引用管理容器中命名逻辑上 AssetBundleName，并剔除无效资源(如父级没有被引用)<ul><li>指定了 IsBuildSingle 标签的，直接用自己的 AssetBundleName 单打</li><li>只有一个上级资源的，资源的 AssetBundleName 直接设置为上级资源同名(与上级打一块)</li></ul></li><li>使用所有需打包的文件列表生成 ManiFestText：这是所有资源的描述<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-09-15/m_dadc8e2227fdd9cc1eaac0eaff87d040_r.png"></li><li>使用所有需打包的文件列表生成 AssetBundleText：这是所有资源的数据<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-09-15/m_bf7196dc3ced405940bad30444f4b17a_r.png"></li><li>将 ManiFestText 与 AssetBundleText 合并为一个自定义的 ScriptableObject 描述对象，并创建对应 Prefab，设置 AssetBundleName<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-09-15/m_a14ce43444c43fc8b4e2dd721116e99f_r.png"></li><li>调用 Unity AssetImporter 接口将所有逻辑 AssetBundleName 进行实际资源设置</li><li>调用 BuildPipeline.BuildAssetBundles 接口，打包最终 AssetBundle 资源</li></ul><p>后续实际加载流程同理，在 FResourcesManager 首先加载 ManiFestText、AssetBundleText 资源引用、描述数据，再次形成 打包时处理生成的 『引用管理结构』，然后再依次加载公共资源(Shader、初始配置等)，进入正式流程。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整个流程理下来，可以看出，我们项目的资源管理，完全是自己实现的一套：包括打包、加载、引用管理等。</p><p>除了打包时调用 UnityEditor 接口获取某资源的引用外，都采用了一套自定义资源管理流程封装，没有使用 Unity 内置接口如 AssetBundleManifest 等。</p><p>所以对于我们项目，打包资源时与 assetbundle 同步生成的 『.manifest』其实可以直接删掉，包括热更也是没用的，数据都是统一存在我们自定义结构中了。</p><div class="tags-container-bottom"><i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/AssetBundle/">#AssetBundle</a></div><br><br><hr><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MsaVbSzIr9cIfikihDExdun9-gzGzoHsz",appKey:"Bj6SEFUBomrLOTWx9B8S6zQH",placeholder:"请输入评论内容~",avatar:"mp",visitor:!1})</script></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l site-author"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/photo.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="CWHISME"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">悲观主义的末日</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>分类</h3><p><a href="/categories/Unity3D/">Unity3D</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>近期文章</h3><p><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/">协变和逆变</a></p><p><a href="/2022/12/06/Unity%E7%9A%84%E9%98%B4%E5%BD%B1%E4%B8%8E%E5%85%89%E7%85%A7%E7%83%98%E7%84%99/">Unity 的阴影与光照烘焙</a></p><p><a href="/2022/11/23/%E6%89%93%E5%8C%85AssetBundle%E5%9F%BA%E7%A1%80%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86/">打包 AssetBundle 的基础规则整理</a></p><p><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/">StringBuilder 扩容规则研究</a></p><p><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">简单测试手动垃圾回收</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/CWHISME" target="_blank"><i class="fa fa-github"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="mailto:cwhisme@126.com" target="_blank"><i class="fa fa-envelope"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">Copyright © 2021 | Design & Hexo <a class="link dim white" target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-anodyne/">Jonathan Klughertz</a> | Modify By CWHISME</div></div></div></body></html>