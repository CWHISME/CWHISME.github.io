<!DOCTYPE html><meta name="viewport" content="height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cwhisme"><meta name="author" content="CWHISME"><meta property="og:title" content="『锁』帧同步的简单实现"><meta property="og:description" content="cwhisme"><meta property="og:site_name" content="WangJiaYing"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>『锁』帧同步的简单实现 - WangJiaYing</title><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/DateTimeAfeterCalc.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/particles-bg.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/script.js"></script><link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/css/style.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="WangJiaYing" type="application/atom+xml">
</head><body><canvas id="hackEffectCanvas" style="position:fixed;z-index:-1;pointer-events:none"></canvas><canvas class="fireworks" style="position:fixed;z-index:10;pointer-events:none"></canvas><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="WangJiaYing"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/logo.svg" class="dib h3" alt="WangJiaYing"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags" title="Tags">Tags </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/categories" title="Categories">Categories </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/bookmark" title="Bookmark">Bookmark </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="About">About</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">『锁』帧同步的简单实现</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2021-07-23&nbsp&nbsp <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="dateTimeAfter">2021-07-23</span></p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-snowflake-o"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>锁帧同步，据说是以前局域网联机游戏常用的一种同步方式，其原理是每帧(或者指定间隔)同步同一个『房间』的玩家操作指令，由于玩家们的初始状态相同，后续操作变化相同即可实现一致性表现。</p><p>缺点是由于每次都必须等待所有玩家指定都收集完成，才算这一帧(次)完成，然后将指令列表同步给所有玩家，因此网络不好的情况下会导致一人卡顿而众人卡顿——因为就算不卡的人，也得等待网络最差的人指令上传完毕，才能进行下一次更新。</p><p>本次使用到的工具主要有：</p><ul><li>Unity2020.1.0</li><li>Box2DSharp</li><li>KCPSharp</li><li>C#</li></ul><p>服务器同样采用C#，.NET Core3.1，物理系统为 Box2DSharp，玩家匹配之前使用 TCP 协议，匹配成功后以基于 UDP 的 KCP 进行数据同步。</p><p>虽然说是简单实现，不过前置条件还是有的，例如：一个能用的网络框架</p><p>这里个人使用了 CrySimpleNet，这是之前就提到过的，当初想搞个远程打包工具而写的。后面抽象出来形成了一个个人小框架。</p><blockquote><p>注：并未对物理引擎作定点数改造，暂未测试物理引擎的浮点数误差问题。</p></blockquote><h2 id="表现"><a href="#表现" class="headerlink" title="表现"></a>表现</h2><p>由于这次并非一边实现一边写，在写本篇文章的时候，已经实现了个样子了，因此就先贴个表现：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-23/1.gif"></p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-23/2.gif"></p><p>帧同步设计到同步的就只有玩家相关指令，其它都由本地计算。</p><p>例如：其中，子弹不属于玩家，而是通过玩家『指令』而被实例化，因此这种基本上没有所谓同步数量限制，算是帧同步的一个好处。</p><h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><p>这里直接以上述表现为例：</p><ul><li>在服务器启动后，等待客户端连接</li><li>客户端连接成功，发送匹配请求：包括匹配需求人数，客户端 UDP 端口等信息</li><li>服务器接收到匹配情况，根据客户端请求匹配人数将其放入相应的匹配队列</li><li>若匹配人数达到需求，创建一个新的『房间』，将申请匹配的几个客户端放进去</li><li>『房间』中，服务器创建一个锁帧同步『世界』，并初始化对应数据，然后根据客户端 UDP 端口创建 KCP 连接，将服务器对应 UDP 端口及初始化数据同过 TCP 协议发给客户端</li><li>客户端接收到数据后，创建『世界』，并使用服务器传入初始数据初始化，注册相关事件(如『世界』生成新对象)</li><li>客户端一切准备就绪：初始化、加载、或者创建模型，直接以 KCP 向后台发送 C2S_PrepareComplete 准备就绪协议</li><li>服务器判断所有客户端准备就绪，向客户端发送『开始』协议</li><li>客户端接收协议，发送一个空操作给服务器</li><li>服务器接收到客户端操作，若所有客户端操作都已接收到，则将操作列表同步给所有客户端，并更新服务器存在的『世界』(该世界可以用于最终结果的验证)</li><li>循环上一步操作，不停更新使世界前进</li></ul><p>这里个人画了个草图：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-23/3.png"></p><p>大概这么个流程。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>在个人的网络小框架中，采用反射支持类的自动序列化，因此相对来说数据通信会比较简单(虽然这里其实也没涉及到几个数据通信就是了)。</p><h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><p>首先是用于匹配的：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 战斗房间-匹配组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BattleMatchingComponent</span> : <span class="title">Component</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BattleLockStepComponent _battle;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Dictionary</span>&lt;<span class="title">int</span>, <span class="title">List</span>&lt;<span class="title">MatchingData</span>&gt;&gt; _matchingData</span> = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, List&lt;MatchingData&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStart</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnStart();</span><br><span class="line">        _battle = AddComponent&lt;BattleLockStepComponent&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReqireMatch</span>(<span class="params">MatchingData data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">lock</span> (<span class="keyword">this</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Log.Debug(<span class="string">$&quot;开始执行 <span class="subst">&#123;data.Channel.RemoteAddress&#125;</span> 申请的匹配...&quot;</span>);</span><br><span class="line">            List&lt;MatchingData&gt; list;</span><br><span class="line">            <span class="keyword">if</span> (!_matchingData.ContainsKey(data.MaxNum))</span><br><span class="line">                _matchingData[data.MaxNum] = <span class="keyword">new</span> List&lt;MatchingData&gt;();</span><br><span class="line">            list = _matchingData[data.MaxNum];</span><br><span class="line">            list.Add(data);</span><br><span class="line">            <span class="comment">//达到匹配人数</span></span><br><span class="line">            <span class="keyword">if</span> (list.Count &gt;= data.MaxNum)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//判断是否正式匹配成功</span></span><br><span class="line">                list.RemoveAll((x) =&gt; !x.Channel.IsConnect);</span><br><span class="line">                <span class="keyword">if</span> (list.Count == data.MaxNum)</span><br><span class="line">                &#123;</span><br><span class="line">                    _battle.Create(list.ToArray());</span><br><span class="line">                    list.Clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>已匹配完成的对象及『房间』管理：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BattleLockStepComponent</span> : <span class="title">Component</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">List</span>&lt;<span class="title">BattleScene</span>&gt; _battleSceneList</span> = <span class="keyword">new</span> List&lt;BattleScene&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">List</span>&lt;<span class="title">BattleScene</span>&gt; _remvoeScene</span> = <span class="keyword">new</span> List&lt;BattleScene&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStart</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        EventSystemDispacher.GetInstance.RegisterEvent(EventSystemDispacher.EventOnDisconnect, OnDisconnect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDisconnect</span>(<span class="params"><span class="built_in">object</span>[] obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        BaseChannel c = obj[<span class="number">0</span>] <span class="keyword">as</span> BaseChannel;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> _battleSceneList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (item.CheckDisconnect(c))</span><br><span class="line">            &#123;</span><br><span class="line">                _remvoeScene.Add(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Create</span>(<span class="params">MatchingData[] dataList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _battleSceneList.Add(<span class="keyword">new</span> BattleScene(dataList));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnUpdate</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//移除该移除的</span></span><br><span class="line">        <span class="keyword">if</span> (_remvoeScene.Count &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> _remvoeScene)</span><br><span class="line">            &#123;</span><br><span class="line">                _battleSceneList.Remove(item);</span><br><span class="line">            &#125;</span><br><span class="line">            _remvoeScene.Clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//更新</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> _battleSceneList)</span><br><span class="line">        &#123;</span><br><span class="line">            item.Update();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中的 BattleScene，就代表维护着一个完整『房间』的场景，并负责协议的接收、处理及分发。</p><p>当然，由于为了简单起见，这里直接通过一个 Switch 判断客户端协议(客户端也差不多)，数据也非常简单。</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">BattleScene</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> MatchingData[] _matchingDataList;</span><br><span class="line">    <span class="comment">//战斗世界</span></span><br><span class="line">    <span class="keyword">private</span> BattleLockStepWorld _world;</span><br><span class="line">    <span class="comment">//连接列表</span></span><br><span class="line">    <span class="keyword">private</span> KcpChannel[] _channels;</span><br><span class="line">    <span class="comment">//准备列表，当玩家场景加载完毕时，发回对应协议后置为true，全部准备完成才能开始战斗</span></span><br><span class="line">    <span class="comment">//后续则用于判断当前帧是否接收完所有玩家命令，下标可使用PlayerID，PlayerID被下标所初始化</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span>[] _prepareList;</span><br><span class="line">    <span class="comment">//是否准备完成，当_prepareList全部为true时，该值置为true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> _isPrepareSuccess = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//当前阶段当前帧，等待的玩家命令列表</span></span><br><span class="line">    <span class="keyword">private</span> FrameExternalActionData _playerAction = <span class="keyword">new</span> FrameExternalActionData();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BattleScene</span>(<span class="params">MatchingData[] dataList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _matchingDataList = dataList;</span><br><span class="line">        _world = <span class="keyword">new</span> BattleLockStepWorld();</span><br><span class="line">        _channels = <span class="keyword">new</span> KcpChannel[dataList.Length];</span><br><span class="line">        _prepareList = <span class="keyword">new</span> <span class="built_in">bool</span>[_channels.Length];</span><br><span class="line">        _playerAction.ActionList = <span class="keyword">new</span> ExternalAction[_channels.Length];</span><br><span class="line">        <span class="comment">//_stepList = new C2S_BattleStep[_prepareList.Length];</span></span><br><span class="line">        <span class="comment">//随便初始化一下初始数据</span></span><br><span class="line">        BattleRawData battleData = <span class="keyword">new</span> BattleRawData();</span><br><span class="line">        <span class="comment">//玩家数据</span></span><br><span class="line">        BattleRawRole[] roles = <span class="keyword">new</span> BattleRawRole[dataList.Length];</span><br><span class="line">        battleData.Seed = <span class="keyword">new</span> Random().Next();</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; roles.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            roles[i] = <span class="keyword">new</span> BattleRawRole() &#123; PlayerID = i, Power = <span class="keyword">new</span> Random().Next(<span class="number">300</span>, <span class="number">800</span>), PosX = i * <span class="number">2</span>, PosY = <span class="number">18</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        battleData.RoleList = roles;</span><br><span class="line">        _world.InitData(battleData);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; dataList.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//创建 对应 KCP连接通道</span></span><br><span class="line">            KcpChannel channel = <span class="keyword">new</span> KcpChannel();</span><br><span class="line">            channel.OnReceiveProto = OnReceiveProto;</span><br><span class="line">            _channels[i] = channel;</span><br><span class="line">            <span class="comment">//KCP 连接客户端</span></span><br><span class="line">            channel.Connect(dataList[i].Channel.RemoteAddress.Address, dataList[i].ClientUdpPort);</span><br><span class="line">            <span class="comment">//表示服务器匹配机制处理完毕</span></span><br><span class="line">            S2C_BattleMatchingSuccess res = ProtocolFactor.GetInstance.Get&lt;S2C_BattleMatchingSuccess&gt;();</span><br><span class="line">            res.BattleData = battleData;</span><br><span class="line">            res.SelfPlayerID = i;</span><br><span class="line">            res.ServerUdpPort = channel.LocalAddress.Port;</span><br><span class="line">            dataList[i].Channel.Send(res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">CheckDisconnect</span>(<span class="params">BaseChannel c</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> _matchingDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (item.Channel.RemoteAddress == c.RemoteAddress)</span><br><span class="line">            &#123;</span><br><span class="line">                _world.Destroy();</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> channel <span class="keyword">in</span> _channels)</span><br><span class="line">                &#123;</span><br><span class="line">                    CryToolUtility.DisposeTarget(channel);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//未准备好</span></span><br><span class="line">        <span class="keyword">if</span> (!_isPrepareSuccess)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//全部准备好了</span></span><br><span class="line">            _isPrepareSuccess = Array.FindAll(_prepareList, x =&gt; x).Length == _prepareList.Length;</span><br><span class="line">            <span class="keyword">if</span> (_isPrepareSuccess)</span><br><span class="line">            &#123;</span><br><span class="line">                SendAll(ProtocolFactor.GetInstance.Get&lt;S2C_BattleStart&gt;());</span><br><span class="line">                _world.Start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (_playerAction.IsComplete())</span><br><span class="line">        &#123;</span><br><span class="line">            _world.Update(_playerAction);</span><br><span class="line">            S2C_BattleStep step = ProtocolFactor.GetInstance.Get&lt;S2C_BattleStep&gt;();</span><br><span class="line">            step.FrameAction = _playerAction;</span><br><span class="line">            _playerAction = <span class="keyword">new</span> FrameExternalActionData();</span><br><span class="line">            _playerAction.ActionList = <span class="keyword">new</span> ExternalAction[_channels.Length];</span><br><span class="line">            SendAll(step);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//SendAll(new S2C_BattleStep() &#123; FrameAction = new FrameExternalActionData() &#123; ActionList = new ExternalNullAction[0] &#125; &#125;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnReceiveProto</span>(<span class="params">BaseChannel channel, CryProtocol proto</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        C2S_BattleProtoBase pb = proto <span class="keyword">as</span> C2S_BattleProtoBase;</span><br><span class="line">        <span class="keyword">switch</span> (pb.GetType().Name)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;C2S_PrepareComplete&quot;</span>:</span><br><span class="line">                _prepareList[pb.PlayerID] = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;C2S_BattleStep&quot;</span>:</span><br><span class="line">                _playerAction.ActionList[pb.PlayerID] = (proto <span class="keyword">as</span> C2S_BattleStep).Action;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SendAll</span>(<span class="params">CryProtocol proto</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> _channels)</span><br><span class="line">        &#123;</span><br><span class="line">            item.Send(proto);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>在客户端这里，同样是简单直接的处理：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ProtoEventDispacher.GetInstance.RegisterEvent&lt;S2C_BattleMatchingSuccess&gt;(OnMatchingSuccess);</span><br><span class="line">    <span class="keyword">if</span> (GameManager.GetInstance.ConnectToServer())</span><br><span class="line">    &#123;</span><br><span class="line">        _kcpChannel = <span class="keyword">new</span> KcpChannel();</span><br><span class="line">        _kcpChannel.OnReceiveProto = OnReceiveProto;</span><br><span class="line"></span><br><span class="line">        C2S_RequreMatching mt = ProtocolFactor.GetInstance.Get&lt;C2S_RequreMatching&gt;();</span><br><span class="line">        mt.MaxNum = <span class="number">1</span>;</span><br><span class="line">        mt.ClientUdpPort = _kcpChannel.LocalAddress.Port;</span><br><span class="line">        ClientNetManager.GetInstance.Send(mt);</span><br><span class="line"></span><br><span class="line">        Log.Debug(<span class="string">&quot;Start Matching.....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (Input.GetKey(KeyCode.A) || Input.GetKey(KeyCode.LeftArrow))</span><br><span class="line">    &#123;</span><br><span class="line">        _moveActionTmp.DirectionX = <span class="number">-1f</span>;</span><br><span class="line">        _playerAction = _moveActionTmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Input.GetKey(KeyCode.D) || Input.GetKey(KeyCode.RightArrow))</span><br><span class="line">    &#123;</span><br><span class="line">        _moveActionTmp.DirectionX = <span class="number">1f</span>;</span><br><span class="line">        _playerAction = _moveActionTmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Input.GetKey(KeyCode.W) || Input.GetKey(KeyCode.UpArrow))</span><br><span class="line">    &#123;</span><br><span class="line">        _moveActionTmp.DirectionY = <span class="number">1f</span>;</span><br><span class="line">        _playerAction = _moveActionTmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Input.GetKey(KeyCode.S) || Input.GetKey(KeyCode.DownArrow))</span><br><span class="line">    &#123;</span><br><span class="line">        _moveActionTmp.DirectionY = <span class="number">-1f</span>;</span><br><span class="line">        _playerAction = _moveActionTmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.Space))</span><br><span class="line">    &#123;</span><br><span class="line">        _playerAction = _attackActionTmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//战斗开始，还未初始化</span></span><br><span class="line">    <span class="keyword">if</span> (_world != <span class="literal">null</span> &amp;&amp; !_world.IsStart &amp;&amp; _lastStep != <span class="literal">null</span>)</span><br><span class="line">        _world.Start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正常更新逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (_world != <span class="literal">null</span> &amp;&amp; _world.IsStart)</span><br><span class="line">    &#123;</span><br><span class="line">        _world.DebugDraw();</span><br><span class="line">        _lastDeltaTime += FrameTime;</span><br><span class="line">        <span class="keyword">if</span> (_lastDeltaTime &gt; FrameTimeMis &amp;&amp; _lastStep != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//更新一波</span></span><br><span class="line">            <span class="keyword">if</span> (_lastStep.FrameAction != <span class="literal">null</span>)</span><br><span class="line">                UpdateBattleWorld(_lastStep.FrameAction);</span><br><span class="line">            <span class="comment">//定时发送操作，若操作为空，则发送空操作</span></span><br><span class="line">            <span class="keyword">if</span> (_playerAction == <span class="literal">null</span>)</span><br><span class="line">                _playerAction = _nullActionTmp;</span><br><span class="line">            SendBattleStep(_playerAction);</span><br><span class="line">            _playerAction = <span class="literal">null</span>;</span><br><span class="line">            _lastDeltaTime = <span class="number">0</span>;</span><br><span class="line">            _lastStep = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateBattleWorld</span>(<span class="params">FrameExternalActionData frameAction</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _world.Update(frameAction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnReceiveProto</span>(<span class="params">BaseChannel arg1, CryProtocol arg2</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (arg2.GetType().Name)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;S2C_BattleStart&quot;</span>:</span><br><span class="line">            Debug.Log(<span class="string">&quot;战斗开始了！&quot;</span>);</span><br><span class="line">            _lastStep = <span class="keyword">new</span> S2C_BattleStep();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;S2C_BattleStep&quot;</span>:</span><br><span class="line">            _lastStep = arg2 <span class="keyword">as</span> S2C_BattleStep;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="literal">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnMatchingSuccess</span>(<span class="params">S2C_BattleMatchingSuccess obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Log.Debug(<span class="string">&quot;匹配成功&quot;</span>);</span><br><span class="line">    _selfPlayerID = obj.SelfPlayerID;</span><br><span class="line">    _nullActionTmp.PlayerID = _selfPlayerID;</span><br><span class="line">    _moveActionTmp.PlayerID = _selfPlayerID;</span><br><span class="line">    _attackActionTmp.PlayerID = _selfPlayerID;</span><br><span class="line"></span><br><span class="line">    _world = <span class="keyword">new</span> BattleLockStepWorld();</span><br><span class="line">    _world.OnCreateBody = OnCreateBody;</span><br><span class="line">    _world.InitData(obj.BattleData);</span><br><span class="line">    _world.Drawer = <span class="keyword">this</span>;</span><br><span class="line">    _kcpChannel.Connect(ClientNetManager.GetInstance.Connection.RemoteAddress.Address, obj.ServerUdpPort);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化表现层</span></span><br><span class="line">    <span class="comment">//InitBattleView(() =&gt;</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    _kcpChannel.Send(GetProto&lt;C2S_PrepareComplete&gt;());</span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上述处理过程中，相信都看到服务器、客户端会创建的一个叫 World 的类：<strong>BattleLockStepWorld</strong></p><p>BattleLockStepWorld 位于另一个程序集，代表了一个『真正』的最底层场景逻辑层，保证这个场景每帧命令一致，只要逻辑层更新情况一致，表现层就不会出现差异。</p><h3 id="关于Box2D调试"><a href="#关于Box2D调试" class="headerlink" title="关于Box2D调试"></a>关于Box2D调试</h3><p>由于Box2D不同于Unity的物理，甚至是看不到实际大小、形状，所以在此还为其碰撞问题纠结了些时间。<br>实际Box2D提供了接口，用于调试绘制形状.</p><p>让类实现 Box2DSharp.Common.IDrawer 接口即可：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DrawFlag IDrawer.Flags &#123; <span class="keyword">get</span> =&gt; DrawFlag.DrawShape | DrawFlag.DrawAABB; <span class="keyword">set</span> =&gt; <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> IDrawer.DrawPolygon(Span&lt;System.Numerics.Vector2&gt; vertices, <span class="built_in">int</span> vertexCount, <span class="keyword">in</span> Box2DSharp.Common.Color color)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; vertices.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Vector2 nowPos = ToUVector(vertices[i]);</span><br><span class="line">        Vector2 nextPos = ToUVector(vertices[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span> &lt; vertices.Length) </span><br><span class="line">            nextPos = ToUVector(vertices[i + <span class="number">1</span>]);</span><br><span class="line">        Debug.DrawLine(nowPos, nextPos, UnityEngine.Color.red);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-23/4.png"></p><br><br><hr><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MsaVbSzIr9cIfikihDExdun9-gzGzoHsz",appKey:"Bj6SEFUBomrLOTWx9B8S6zQH",placeholder:"请输入评论内容~",avatar:"mp",visitor:!1})</script></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l site-author"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/photo.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="CWHISME"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">悲观主义的末日</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>分类</h3><p><a href="/categories/网络开发/">网络开发</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>近期文章</h3><p><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/">协变和逆变</a></p><p><a href="/2022/12/06/Unity%E7%9A%84%E9%98%B4%E5%BD%B1%E4%B8%8E%E5%85%89%E7%85%A7%E7%83%98%E7%84%99/">Unity 的阴影与光照烘焙</a></p><p><a href="/2022/11/23/%E6%89%93%E5%8C%85AssetBundle%E5%9F%BA%E7%A1%80%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86/">打包 AssetBundle 的基础规则整理</a></p><p><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/">StringBuilder 扩容规则研究</a></p><p><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">简单测试手动垃圾回收</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/CWHISME" target="_blank"><i class="fa fa-github"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="mailto:cwhisme@126.com" target="_blank"><i class="fa fa-envelope"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">Copyright © 2021 | Design & Hexo <a class="link dim white" target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-anodyne/">Jonathan Klughertz</a> | Modify By CWHISME</div></div></div></body></html>