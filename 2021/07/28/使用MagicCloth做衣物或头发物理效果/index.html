<!DOCTYPE html><meta name="viewport" content="height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cwhisme"><meta name="author" content="CWHISME"><meta property="og:title" content="使用MagicCloth做衣物或头发物理效果"><meta property="og:description" content="cwhisme"><meta property="og:site_name" content="WangJiaYing"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>使用MagicCloth做衣物或头发物理效果 - WangJiaYing</title><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/DateTimeAfeterCalc.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/particles-bg.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/script.js"></script><link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/css/style.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="WangJiaYing" type="application/atom+xml">
</head><body><canvas id="hackEffectCanvas" style="position:fixed;z-index:-1;pointer-events:none"></canvas><canvas class="fireworks" style="position:fixed;z-index:10;pointer-events:none"></canvas><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="WangJiaYing"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/logo.svg" class="dib h3" alt="WangJiaYing"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags" title="Tags">Tags </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/categories" title="Categories">Categories </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/bookmark" title="Bookmark">Bookmark </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="About">About</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">使用MagicCloth做衣物或头发物理效果</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2021-07-28&nbsp&nbsp <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="dateTimeAfter">2021-07-28</span></p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-snowflake-o"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇文章 “<a href="https://cwhisme.github.io/2021/07/23/%E3%80%8E%E9%94%81%E3%80%8F%E5%B8%A7%E5%90%8C%E6%AD%A5%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/">『锁』帧同步的简单实现</a>“ 写了实现一个简单『帧锁定同步』的过程。</p><p>下一步按照正常流程来说，应该是整一个 『乐观帧锁定同步』，不过在选择继续使用个人网络小框架，还是使用开源的ET框架的选择上出现了一点点分歧：</p><p>如果使用个人网络小框架，那么就跟上一篇文章的 锁帧同步 实现流程类似，反正主要就是把这个『功能』实现，而不会去考虑其他。<br>『其它』是指什么呢？角色、场景、以及好一点的『表现』。</p><p>最后差不多也就是一个简单的 Demo，几个方块『人』受玩家操作，在场景走一走，打一打之类的。</p><p>而如果采用 ET 呢，则是冲着实现一个完整流程『游戏』过程走，主要有一下几点：</p><ul><li>在未进入匹配环节的表现，使用TCP协议以状态同步方式可以在一个场景中跑动或交互</li><li>好看的(或可以看的)资源——角色、人物模型</li><li>研究研究状态同步MMO的实现(因为此前个人都是做手游卡牌、SLG，还没涉及过这种类型)</li><li>研究研究ET(虽然以前也看过代码，不过并不深入)</li><li>可能的话，把一个『MMO网游元素』都实现一下</li></ul><p>限于上述几点，个人做的网络小框架就不大好用了——如果要说做Demo而已强行用，也不是不行，就是性能和扩展性肯定比不上开源了数年的 ET 了。看名字 CrySimpleNet 就知道，而且为了方便使用，反射之类的用的都不少。</p><p>于是后续就倾向于使用 ET 整了。</p><p>如此，这几天就开始搜集了下相关资源和插件(可惜由于现在Unity反盗版严重， 想学习使用以前收藏的论坛都找不到几个好的插件了)</p><h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><p>关于这个，上次写 <a href="https://cwhisme.github.io/2021/06/13/%E4%B8%BA%E5%8D%9A%E5%AE%A2%E6%B7%BB%E5%8A%A0Live2D%E7%9C%8B%E6%9D%BF%E5%A8%98/">为博客添加Live2D看板娘</a> 那篇文章的时候，就感觉，如果有『兴趣』的话，效率会更高。</p><p>于是打算采用卡通渲染风格作表现。</p><p>首先，关于人物模型，个人收集了几个<a target="_blank" rel="noopener" href="https://ys.biligame.com/gczj/">原神</a> MMD 模型，使用 Blender <a target="_blank" rel="noopener" href="https://github.com/GiveMeAllYourCats/cats-blender-plugin.git">MMD插件cats</a> 导出为 FBX 格式，然后放进Unity使用。</p><p>然后为了好看一点，在 Github 上拉了 <a target="_blank" rel="noopener" href="https://github.com/ColinLeung-NiloCat/UnityURPToonLitShaderExample#why-creating-this-simplified-version-toon-lit-shader">UnityURPToonLitShaderExample</a> 来暂且用着，后面有时间再考虑自己搞搞——毕竟发现原神这个模型，就算使用内置的 UnlitShader 都有不错的表现了…也就是说美术画的挺好。</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/Snipaste_2021-07-28_22-24-20.png" alt="图片"><br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/Snipaste_2021-07-29_11-55-32.png" alt="图片"></p><p>(说到这里，就想起以前拿Unity素体做 demo 的时候了，太丑了)</p><p>其实 MagicCloth 仅仅只是常规使用是非常简单的，唯一能引起一点障碍的就是英文文档了，不过过一遍再试试也差不多了。</p><h2 id="MagicCloth"><a href="#MagicCloth" class="headerlink" title="MagicCloth"></a>MagicCloth</h2><p>MagicCloth 是 Unity3D 的一个插件，采用 Unity Job System + Burst compiler 进行工作，因此据说性能上来说，肯定比以前那些单纯C#实现的好。</p><p>其可以同时支持 骨骼 和 Mesh 模拟，当然性能上来说官方还是推荐使用骨骼模拟。</p><p>由于整个本身是个付费插件，个人整着玩就直接找的论坛，使用的插件是论坛上找的 Magica Cloth 1.9.4，当然，最新版本早就到 1.10.3 了。</p><p>介绍的话说这么多，现在进入正题。</p><h3 id="关于组件"><a href="#关于组件" class="headerlink" title="关于组件"></a>关于组件</h3><p>这里主要涉及到最终表现 生效 的组件有四种：</p><ul><li>Bone Cloth：以『骨骼』为最小单位进行物理模拟，效果与骨骼位置、蒙皮有关，适合头发、带骨骼的衣物</li><li>Bone Spring：以『骨骼』为最小单位进行物理模拟，适用于仅一个节点的配饰、小物件</li><li>Mesh Cloth：以『Mesh』为最小单位进行物理模拟，MagicCloth内建了Mesh转换代码，会先将Unity的常规 Mesh 转化为 MagicaVirtualDeformer 再行使用，不过相比骨骼模拟来说，性能消耗依然不是一个量级的。</li><li>Mesh Spring：同上，适用于没有『骨骼』控制的小物件，例如，官方推荐可以作为胸部摇晃使用</li></ul><p>总体来说，Bone 相关组件适用于分离物理层级，或具有骨骼蒙皮的角色。Mesh 相关组件适用于单个物体部分模拟控制，例如角色不带骨骼的部位就只能用 Mesh 进行模拟。</p><p><font color="green">注：这里的骨骼特指 tranform 变换层级，就算用 Cube 组合的层级也是可以一用的</font></p><p>因此，虽然上面已经说了个人找了不少好康的模型，不过在这里，本文毕竟是以介绍 MagicCloth 使用为主，就先以 Cube 搭建的一个简单层级为开始吧（官方实例场景就是这样整过的）</p><h3 id="Bone-Cloth"><a href="#Bone-Cloth" class="headerlink" title="Bone Cloth"></a>Bone Cloth</h3><h4 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h4><p>首先，将 /MagicaCloth/Res/Prefab/MagicaPhysicsManager.prefab 放在场景中，该组件为 MagicaCloth 物理管理器，是个单例，负责执行实际物理更新。</p><p>在每个对象挂载的 Cloth 相关组件初始化时会调用 MagicaPhysicsManager.Instance.Team.CreateTeam 将自身注册进去，因此每个场景必须有一个。</p><p>然后，创建了四个球体，并形成子父级，每个子节点的 Position 都是 (0,-1.5,0)，于是形成如下排列：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/Snipaste_2021-07-30_11-22-02.png" alt="图片"></p><p>点击第一个球体，创建 BoneCloth，然后把它的引用放在 RootList：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/m_a3076efc8ec555669c88df997b5330c5_r.png" alt="图片"></p><p>点击 StartPointPosition 检查可移动节点：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/m_76cc1e40d430c5873173e08398d22d89_r.png" alt="图片"></p><p>此时可能会发现 “全绿”，代表全部可以被模拟移动，这样是不行的，作为 BoneCloth，至少需要一个 固定节点，以使其不会无限往下掉。</p><p>点击 Fixed Point，然后点击根节点的球体处，可以将其设置为固定点，如上图所示。</p><p>最后点击最下方的红色 Create 按钮，MagicBoneCloth 就会根据当前设置生成数据，可以在组件最上方看到：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/m_c39354e7e58fd366609490c2671a8402_r.png" alt="图片"></p><p>然后运行游戏，可以看到：</p><p>什么都没发生！</p><p>原因很简单：Magica Bone Cloth 貌似是不能放在被控制的骨骼层级下的，刚才我们创建的 Magica Bone Cloth 组件直接就是 Sphere 的一个子级了。</p><p>正规来说，应当建立一个作为父级的空物体来装载，不过此时可以简单地将该物体拉出来：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/m_108609c69ab216e23685138dfcfff537_r.png" alt="图片"></p><p>再运行，表现就出来了：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/GIF2021-7-29-15-45-47.gif" alt="图片"></p><h4 id="头发模拟"><a href="#头发模拟" class="headerlink" title="头发模拟"></a>头发模拟</h4><p>步骤与上述基本一致，不过由于其模拟复杂一些，可能需要额外的配置项。</p><p>不过 MagicaCloth 直接提供了一些常用的参数的预制项，若感觉麻烦，直接加载使用即可。</p><p>不过正规使用的时候，一般还需要添加碰撞体，以防止物理模拟下导致的『穿模』，MagicCloth 同样提供了两种碰撞体：胶囊碰撞体及球形碰撞体。</p><p>这里以原神角色 刻晴 为例：<br>(因为她的头发看起来比较合适)</p><ol><li>右键角色，创建 Magica Bone Cloth</li><li>将两根作为头发的骨骼根节点节点放入 RootList</li><li>确认初始固定点正确<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/c1.png" alt="图片"></li><li>为了效果好一点，可以加点碰撞，右键角色，Create Magica Sphere Collider，然后调整好大小<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/c2.png" alt="图片"></li><li>点击面板上的 Collider 项目下 All Select 可以自动加载所有该对象下的 Collider<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/c3.png" alt="图片"></li><li>手动配置参数或点击下方的设置处的Preset按钮，加载一个合适的预设配置<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/c4.png" alt="图片"></li><li>点击 Create 创建模拟数据</li><li>运行场景查看效果</li></ol><p>其中，如果是环形封闭的裙子，则需要注意将 ConnectMode 设置为 Mesh：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/c5.png" alt="图片"></p><p>最后效果如下：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/GIF2021-7-29-18-43-46.gif" alt="图片"></p><p>(有同学可能会好奇为什么角色会眨眼睛？因为 MMD 模型自带 表情的 BlendShape，于是就简单用脚本控制了一下眼睛，加了个眨眼睛的动作，让她好康一点 (✪ω✪))</p><h3 id="Mesh-Cloth"><a href="#Mesh-Cloth" class="headerlink" title="Mesh Cloth"></a>Mesh Cloth</h3><p>Mesh Cloth 与上述 Bone Cloth 使用方式类似，区别只是前置准备的差异。<br>例如：Mesh Cloth 需求额外的 VirtualMesh 组件等。</p><p>还是以一个 Cube 为例，下面说一下需要额外准备的差异步骤：</p><ol><li>创建一个空物体，这里命名为 MeshClothObj，并在其下级创建一个 Cube</li><li>在 Cube 上挂载 MagicaRenderDeformer</li><li>Create MagicaVirtualDeformer</li><li>将 Cube 上的 MagicaRenderDeformer 引用至 MagicaVirtualDeformer RenderDeformer 参数</li><li>创建 MagicaMeshCloth，并将上一步创建 MagicaVirtualDeformer 引用设置过来</li><li>点击 StartPointPosition，设置固定点与可移动点，最后如图所示：<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/m1.png" alt="图片"></li><li>点击 Create 创建数据，运行即可看到效果了</li></ol><p>最后效果如下：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-30/GIF2021-7-30-11-05-19.gif" alt="图片"></p><p>这里由于采用了 Cube 作为示例，因此看起来相比布料更像『果冻』。</p><p>如果采用面数更高的模型就可以看到并调整类似布料效果了。</p><hr><p>参考文章：</p><ul><li><a target="_blank" rel="noopener" href="https://magicasoft.jp/en/magica-cloth-install-2/">官方文档</a></li></ul><br><br><hr><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MsaVbSzIr9cIfikihDExdun9-gzGzoHsz",appKey:"Bj6SEFUBomrLOTWx9B8S6zQH",placeholder:"请输入评论内容~",avatar:"mp",visitor:!1})</script></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l site-author"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/photo.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="CWHISME"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">悲观主义的末日</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>分类</h3><p><a href="/categories/Unity3D/">Unity3D</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>近期文章</h3><p><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/">协变和逆变</a></p><p><a href="/2022/12/06/Unity%E7%9A%84%E9%98%B4%E5%BD%B1%E4%B8%8E%E5%85%89%E7%85%A7%E7%83%98%E7%84%99/">Unity 的阴影与光照烘焙</a></p><p><a href="/2022/11/23/%E6%89%93%E5%8C%85AssetBundle%E5%9F%BA%E7%A1%80%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86/">打包 AssetBundle 的基础规则整理</a></p><p><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/">StringBuilder 扩容规则研究</a></p><p><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">简单测试手动垃圾回收</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/CWHISME" target="_blank"><i class="fa fa-github"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="mailto:cwhisme@126.com" target="_blank"><i class="fa fa-envelope"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">Copyright © 2021 | Design & Hexo <a class="link dim white" target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-anodyne/">Jonathan Klughertz</a> | Modify By CWHISME</div></div></div></body></html>