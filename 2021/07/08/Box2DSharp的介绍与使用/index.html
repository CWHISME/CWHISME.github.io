<!DOCTYPE html><meta name="viewport" content="height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cwhisme"><meta name="author" content="CWHISME"><meta property="og:title" content="Box2DSharp的介绍与使用"><meta property="og:description" content="cwhisme"><meta property="og:site_name" content="WangJiaYing"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>Box2DSharp的介绍与使用 - WangJiaYing</title><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/DateTimeAfeterCalc.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/particles-bg.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/script.js"></script><link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/css/style.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="WangJiaYing" type="application/atom+xml">
</head><body><canvas id="hackEffectCanvas" style="position:fixed;z-index:-1;pointer-events:none"></canvas><canvas class="fireworks" style="position:fixed;z-index:10;pointer-events:none"></canvas><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="WangJiaYing"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/logo.svg" class="dib h3" alt="WangJiaYing"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags" title="Tags">Tags </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/categories" title="Categories">Categories </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/bookmark" title="Bookmark">Bookmark </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="About">About</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">Box2DSharp的介绍与使用</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2021-07-08&nbsp&nbsp <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="dateTimeAfter">2021-07-08</span></p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-snowflake-o"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上文 <a href="/2021/07/07/%E6%88%98%E6%96%97%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">关于手游战斗系统</a> 提到了作为一个独立的战斗系统，前后端可能都是需要运行的，因此物理系统自然不能使用前端引擎自带的，本文介绍了一下 Box2DSharp —— 一个Box2D的C#版本。</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在Box2D中，一个 World 代表一个物理世界。</p><p>其中，一个完整物体，分为 Body、Shape、Fixture</p><ul><li>Body：代表一个对象</li><li>Shape：形状</li><li>Fixture：负责将形状Shape与对象Body连接</li></ul><p>一个 World 需要实际『动』起来，就需要调用其 Step 进行更新，Step方法接收三个参数，分别为：</p><ul><li>timeStep：物理更新间隔，类似于Unity的 Time.deltaTime</li><li>velocityIterations：速度迭代解算值</li><li>positionIterations：位置迭代解算值</li></ul><p><a target="_blank" rel="noopener" href="https://box2d.org/documentation/md__d_1__git_hub_box2d_docs_hello.html#autotoc_md21">参考-Simulating the World</a></p><blockquote><p>The suggested iteration count for Box2D is 8 for velocity and 3 for position. You can tune this number to your liking, just keep in mind that this has a trade-off between performance and accuracy. Using fewer iterations increases performance but accuracy suffers. Likewise, using more iterations decreases performance but improves the quality of your simulation. For this simple example, we don’t need much iteration. Here are our chosen iteration counts.</p></blockquote><p>官方推荐 velocityIterations 为 8，positionIterations 为 3，更小的值会减少模拟精度，但有更好的性能，反之亦然。这个值可以取决于使用者对精度与性能的需求，进行调整。</p><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>一个最基础的动态对象创建如下：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> World _world;</span><br><span class="line"><span class="keyword">private</span> Body _body;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _world = <span class="keyword">new</span> World(<span class="keyword">new</span> System.Numerics.Vector2(<span class="number">0</span>, <span class="number">-10</span>));</span><br><span class="line">    _body = _world.CreateBody(<span class="keyword">new</span> BodyDef()</span><br><span class="line">    &#123;</span><br><span class="line">        Position = <span class="keyword">new</span> System.Numerics.Vector2(<span class="number">0</span>, <span class="number">100</span>),</span><br><span class="line">        BodyType = BodyType.DynamicBody,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> shape = <span class="keyword">new</span> PolygonShape();</span><br><span class="line">    shape.SetAsBox(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    _body.CreateFixture(shape, <span class="number">0.1f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _world.Step(<span class="number">1</span> / <span class="number">60f</span>, <span class="number">8</span>, <span class="number">3</span>);</span><br><span class="line">    Console.WriteLine(_body.GetPosition());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/1.png" alt="效果"></p><p>上述代码在 (0,100) 处创建了一个1x1大小的Box对象，质量 0.1，运行时将会以 -10 的重力加速度往下掉，由于此处我们并未创建地板，因此对象会一直往下掉，表现在打印的字符串上，值就会越来越小。</p><p>此外，这里在更新线程中，并未将 时间与执行间隔 对应起来，相当于white类型的一直更新。</p><p>所以可以将实际时间间隔加进去：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">float</span> FrameTime = <span class="number">1</span> / <span class="number">60f</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> FrameTimeMis = (<span class="built_in">int</span>)(FrameTime * <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> VelocityIterations = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> PositionIterations = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> World _world;</span><br><span class="line"><span class="keyword">private</span> Body _body;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">double</span> _time;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _world = <span class="keyword">new</span> World(<span class="keyword">new</span> System.Numerics.Vector2(<span class="number">0</span>, <span class="number">-10</span>));</span><br><span class="line">    _body = _world.CreateBody(<span class="keyword">new</span> BodyDef()</span><br><span class="line">    &#123;</span><br><span class="line">        Position = <span class="keyword">new</span> System.Numerics.Vector2(<span class="number">0</span>, <span class="number">100</span>),</span><br><span class="line">        BodyType = BodyType.DynamicBody,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> shape = <span class="keyword">new</span> PolygonShape();</span><br><span class="line">    shape.SetAsBox(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    _body.CreateFixture(shape, <span class="number">0.1f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _time += FrameTime;</span><br><span class="line">    _world.Step(FrameTime, VelocityIterations, PositionIterations);</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;_time&#125;</span>: <span class="subst">&#123;_body.GetPosition()&#125;</span>&quot;</span>);</span><br><span class="line">    Thread.Sleep(FrameTimeMis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/2.gif"></p><p>如此，运行频率就跟现实的实际的时间挂钩了。</p><h3 id="带属性物理对象"><a href="#带属性物理对象" class="headerlink" title="带属性物理对象"></a>带属性物理对象</h3><p>例如，带 弹性 物体。</p><p>在 Box2D 中，物体属性设置位于创建 Fixture 传参 FixtureDef 中：</p><ul><li>Restitution：弹性</li><li>Friction：摩擦力</li></ul><p>这两个值都是 0~1 之间。另外还有 Density(密度)、IsSensor(类似Unity的IsTrigger)、RestitutionThreshold(弹性阀值，超出阀值才会反弹)等。</p><p>为了测试这一点，接下来，可以创建一个地板，并对上述创建的对象增加一点弹性。</p><p>为了方便起见，我将创建物体封装为了一个 单独方法：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">float</span> FrameTime = <span class="number">1</span> / <span class="number">60f</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> FrameTimeMis = (<span class="built_in">int</span>)(FrameTime * <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> VelocityIterations = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> PositionIterations = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> World _world;</span><br><span class="line"><span class="keyword">private</span> Body _body;</span><br><span class="line"><span class="keyword">private</span> Body _grounder;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">double</span> _time;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _world = <span class="keyword">new</span> World(<span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">-10</span>));</span><br><span class="line"></span><br><span class="line">    _body = CreateBody(<span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">10</span>), <span class="number">1</span>, <span class="number">1</span>, BodyType.DynamicBody);</span><br><span class="line">    _grounder = CreateBody(Vector2.Zero, <span class="number">10</span>, <span class="number">1</span>, BodyType.StaticBody);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _time += FrameTime;</span><br><span class="line">    _world.Step(FrameTime, VelocityIterations, PositionIterations);</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;_time&#125;</span>: <span class="subst">&#123;_body.GetPosition()&#125;</span>&quot;</span>);</span><br><span class="line">    Thread.Sleep(FrameTimeMis);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Body <span class="title">CreateBody</span>(<span class="params">Vector2 pos, <span class="built_in">float</span> sizeX, <span class="built_in">float</span> sizeY, BodyType bodyType</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Body body = _world.CreateBody(<span class="keyword">new</span> BodyDef()</span><br><span class="line">    &#123;</span><br><span class="line">        Position = pos,<span class="comment">//new Vector2(0, 100),</span></span><br><span class="line">        BodyType = bodyType,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> shape = <span class="keyword">new</span> PolygonShape();</span><br><span class="line">    shape.SetAsBox(sizeX, sizeY);</span><br><span class="line">    body.CreateFixture(<span class="keyword">new</span> FixtureDef()</span><br><span class="line">    &#123;</span><br><span class="line">        Shape = shape,</span><br><span class="line">        Density = <span class="number">1f</span>,</span><br><span class="line">        Restitution = <span class="number">0.5f</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/3.png"></p><p>可以看到，该物体在与地面接触之后，被反弹上去，而后又掉下来。</p><p>另外的属性例如：根据物体掉落速度到地面的最大速度(12.5)，若将 RestitutionThreshold(弹性阀值) 修改为 13，则该物体就会出现不再反弹的情况：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/4.png"></p><h2 id="在Unity3D中使用"><a href="#在Unity3D中使用" class="headerlink" title="在Unity3D中使用"></a>在Unity3D中使用</h2><p>上述只是在控制台程序中进行了一下简单的使用，因为没有可视化，因此也只能看看数值而已，作为物理模拟，若想实际看到效果，就得将其与渲染引擎 链接 起来。</p><p>这里直接选择 Unity3D</p><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>因为不是直接使用 Box2D 原始C语言版本，作为C#的库，直接将上述代码生成类库，编译成 DLL 放进引擎即可。</p><p>这里个人在项目中创建了 Plugins 目录，将编译好的 DLL 放入。</p><hr><p>中间稍微还是有些坑的：</p><ul><li><p>首先是平台问题，上面测试时，个人直接创建的 DotNetCore 控制台项目，Box2DSharp 放进来没问题，可以直接使用。但是Unity3D不支持 DotNetCore 库，因此创建的库项目必须为 .Net 平台。而 Box2DSharp 中使用到的一些引用，例如 System.Buffers、System.Memery 就必须额外安装模块了：<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/5.png"></p></li><li><p>此外 Box2DSharp 使用过指针代码，因此必须开启『不安全代码选项』，不管是 DLL 项目还是 Unity 设置都是如此。<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/6.png"><br>其中，不安全代码可能会与Unity本身产生冲突，导致编译失败且无法继续进行：<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/7.png"><br>个人升级了一下 Collections 版本至 0.14.0 解决了这个问题：<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/8.png"></p></li></ul><hr><p>新版 Unity 若出现报错，无法加载pdb的调试信息，需要修改一下生成设置：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/9.png"></p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>然后创建了一个普通的 Box2DTest.cs 测试脚本：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BattleWorld _battle;</span><br><span class="line"></span><br><span class="line">System.Threading.CancellationTokenSource _token = <span class="keyword">new</span> System.Threading.CancellationTokenSource();</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">List</span>&lt;<span class="title">BodyObject</span>&gt; _bodyList</span> = <span class="keyword">new</span> List&lt;BodyObject&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _battle = <span class="keyword">new</span> BattleWorld();</span><br><span class="line">    _battle.Start();</span><br><span class="line">    Task.Run(PhysicsWorldUpdate);</span><br><span class="line">    StartCoroutine(UpdatePositon());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (Input.GetMouseButtonDown(<span class="number">0</span>) &amp;&amp; !_battle.IsWorldLocked)</span><br><span class="line">    &#123;</span><br><span class="line">        _bodyList.Add(<span class="keyword">new</span> BodyObject(_battle.CreateBody(<span class="keyword">new</span> System.Numerics.Vector2(Random.Range(<span class="number">0</span>, <span class="number">10</span>), <span class="number">10</span>), <span class="number">0.5f</span>, <span class="number">0.5f</span>, BodyType.DynamicBody)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _token.Cancel();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> IEnumerator <span class="title">UpdatePositon</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> _bodyList)</span><br><span class="line">        &#123;</span><br><span class="line">            item.Update();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PhysicsWorldUpdate</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_token.IsCancellationRequested)</span><br><span class="line">        &#123;</span><br><span class="line">            _battle.Destroy();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        _battle.Update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">BodyObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Body _body;</span><br><span class="line">    <span class="keyword">private</span> GameObject _obj;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BodyObject</span>(<span class="params">Body body</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _body = body;</span><br><span class="line">        _obj = GameObject.CreatePrimitive(PrimitiveType.Cube);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _obj.transform.position = <span class="keyword">new</span> Vector3(_body.GetPosition().X, _body.GetPosition().Y, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2021/2021-07-08/10.gif"></p><p>如此，就是一个最简单的链接使用了。</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>本文简单介绍了一下 Box2D 结构与使用流程，并将其挪到 Unity 中进行了一个可视化观察。</p><p>当然，后续实际使用的话，代码自然还需要进行更好的设计，例如设计中介者将物理系统的相关属性适配出来，而非直接 Unity 脚本就直接读取物理系统内属性，以及优化表现层与物理层物体的更新方式等。</p><p>不过本文目的应该是达到了：即个人对 Box2D 使用方式及其概念的熟悉，为后续做帧同步战斗做个前置。</p><p>虽然这个物理引擎也不是定点数物理引擎，不过胜在简单，且定点数必然会导致性能下降，个人就在考虑先使用普通物理引擎进行试验，有情况的话后续再看需不需要做改造。<br>另外 Box2D 作为2D物理引擎也有所局限性，后续或许还会研究下3D类型的物理引擎。</p><br><br><hr><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MsaVbSzIr9cIfikihDExdun9-gzGzoHsz",appKey:"Bj6SEFUBomrLOTWx9B8S6zQH",placeholder:"请输入评论内容~",avatar:"mp",visitor:!1})</script></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l site-author"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/photo.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="CWHISME"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">悲观主义的末日</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>分类</h3><p><a href="/categories/Unity3D/">Unity3D</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>近期文章</h3><p><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/">协变和逆变</a></p><p><a href="/2022/12/06/Unity%E7%9A%84%E9%98%B4%E5%BD%B1%E4%B8%8E%E5%85%89%E7%85%A7%E7%83%98%E7%84%99/">Unity 的阴影与光照烘焙</a></p><p><a href="/2022/11/23/%E6%89%93%E5%8C%85AssetBundle%E5%9F%BA%E7%A1%80%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86/">打包 AssetBundle 的基础规则整理</a></p><p><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/">StringBuilder 扩容规则研究</a></p><p><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">简单测试手动垃圾回收</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/CWHISME" target="_blank"><i class="fa fa-github"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="mailto:cwhisme@126.com" target="_blank"><i class="fa fa-envelope"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">Copyright © 2021 | Design & Hexo <a class="link dim white" target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-anodyne/">Jonathan Klughertz</a> | Modify By CWHISME</div></div></div></body></html>