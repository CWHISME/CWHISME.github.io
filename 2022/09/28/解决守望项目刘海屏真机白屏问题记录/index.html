<!DOCTYPE html><meta name="viewport" content="height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cwhisme"><meta name="author" content="CWHISME"><meta property="og:title" content="解决守望项目刘海屏真机白屏问题记录"><meta property="og:description" content="cwhisme"><meta property="og:site_name" content="WangJiaYing"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>解决守望项目刘海屏真机白屏问题记录 - WangJiaYing</title><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/DateTimeAfeterCalc.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/particles-bg.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/script.js"></script><link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/css/style.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="WangJiaYing" type="application/atom+xml">
</head><body><canvas id="hackEffectCanvas" style="position:fixed;z-index:-1;pointer-events:none"></canvas><canvas class="fireworks" style="position:fixed;z-index:10;pointer-events:none"></canvas><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="WangJiaYing"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/logo.svg" class="dib h3" alt="WangJiaYing"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags" title="Tags">Tags </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/categories" title="Categories">Categories </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/bookmark" title="Bookmark">Bookmark </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="About">About</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">解决守望项目刘海屏真机白屏问题记录</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2022-09-28&nbsp&nbsp <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="dateTimeAfter">2022-09-28</span></p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-snowflake-o"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><div class="tags-container-vertical"><div class="tags-sub-container"><a class="fw3 ph1 dib" href="/tags/问题解决记录/">#问题解决记录</a></div></div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>注：该问题可能仅适用于项目，或者公司该项目衍生版本(该是没有了)</strong></p><p>在给对面出了新包之后，由于我方测试都只有低端机，连刘海都没有，因此没有测出该问题。</p><p>后续由运营同步过来，显示效果如下：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_a67c42c71cc70838d1f8a1081d9ec448_r.png"></p><p>描述的服务器问题可以忽略，那个是因为后台没开外网测试服导致。</p><p>然后我就看了下以前<font color="red">上一个项目组</font>出给对面的白包效果：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_b8f77ca2faa524d65d5da4d97b76443e_r.png"></p><p>这旧版本的刘海更大了！所以还是感觉新版如果把刘海也渲染进去，表现效果会更好一点，稍微查了一下，就得知刘海没有被渲染的原因是因为出包工程 Unity2018.4.36 这个版本没勾 『Render outside safe area』选项导致的，于是勾上重新出包。</p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>这时候真的问题就来了：</p><p>在我自己的刘海屏(红米K50G)真机安装后，会正常执行初始的 Loading 界面，后续立刻白屏！</p><p>表现效果如下：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_cf7b1733e5867c699e36082f5a3cb43f_r.gif"></p><p>看着这个表现，最开始怀疑过是Unity的问题：因为我拿到项目时，版本虽然是 Unity2018，但并不是 Unity2018 最新版本，后来给它升级到 Unity2018.4.36 了，就猜测是不是 Unity 出啥事了？</p><p>项目设置如下：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_c53c356eab861de7f5b7b9a6ba011e48_r.png"></p><p>2018.4 官方说明文档：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_05c3ec910acdc69b5899d43ad7cd8e72_r.png"></p><p>如上图所示，查询文档显示 Unity2018 文档上并没有 Render outside safe area 这选项，跟项目实际设置表现并不一致，该选项是否是 Unity2018 后续才更新上去的？导致出现了什么兼容性问题。</p><p>不过后边根据表现情况一想，也不对。</p><p>毕竟最开始 Loading 都能正常显示出来，那么说明 Render outside safe area 并没有让我们的真机整体的渲染出现问题。</p><p>根据发生情况地点：初始 Loading 界面完毕，UI框架接管之后——问题恐怕只可能出现在我们自己的 UI 框架作适配性的地方。</p><p>还有一个信息可以使得 100% 确定是项目的适配而非 Unity 的问题：</p><p>—— 可以打开日志界面！</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_68a9dc72678952c375016e2d306ca555_r.png"></p><p>日志界面是可以正常显示的，因此出问题的只可能是项目 AorUISystem 中适配问题。</p><h2 id="尝试解决"><a href="#尝试解决" class="headerlink" title="尝试解决"></a>尝试解决</h2><p>对于项目中适配的地方，根据代码引用一步一步查询，大概可以找出两个可能会比较影响点：</p><ul><li>Main.cs 中 AdapteFullScreen() 判断刘海方法</li><li>AorUIManager.cs 中 ScaleMode-&gt;changeScaleMode()-&gt;updateStageSize()</li></ul><p>开始虽然基本可以定位是这两块的问题，但是并没有更详细的头绪。</p><p>并猜测：</p><ul><li>是否是 Stage 缩放大小被错误设置为0？因为 Stage scale 其实很小，而且根据分辨率不同还可能更小<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_debc641d73c783234617782f0234fb8f_r.png"></li><li>是否由于读取到刘海，Stage 发生了严重的错误偏移？</li><li>是否是 MainLayer 层级有遮挡？</li></ul><h4 id="出包测试"><a href="#出包测试" class="headerlink" title="出包测试"></a>出包测试</h4><p>为了对上述猜测进验证，且由于是真机、特定机型问题，为了测试，基本上都是改一次代码，出一个包，导致时间消耗更加拉长。</p><h4 id="Injectfix-远程热更测试"><a href="#Injectfix-远程热更测试" class="headerlink" title="Injectfix 远程热更测试"></a>Injectfix 远程热更测试</h4><p>后来想着这样可不是办法，于是我把 Injectfix 远程热更调试功能给它整合了进去，然后才变得方便起来。</p><p>找到游戏点击屏幕处理方法，直接热更输出需要的详细信息，并操作对猜测进试验：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_a2038f3d25baa22c262b0fadcf7b7d68_r.png"></p><p>Loading 结束，进入正式 UI 管理后，其基本结构如下：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_4affba82fd8aabee3e1d63ae7452a1d6_r.png"></p><p>尝试使用排除法，操作结果反馈如下：</p><ul><li>隐藏 MainLayer：无变化</li><li>隐藏 AorUIStage# 所有子节点：无变化</li><li>隐藏 AorUIStage#：无变化</li><li>隐藏 AorUICanvas#：有明显变化，白屏变成黑屏</li><li>隐藏 AorUICanvas#所有子节点：同隐藏父类，有明显变化，白屏变成黑屏</li><li>在 AorUICanvas#、AorUIStage# 子节点动态创建色块，无变化</li><li>隐藏 AorUICanvas# 所有子节点，创建动态色块，能看到色块显示</li></ul><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>结合上面一通测试结果，以及输出信息。</p><p>可以基本确认，是 AorUICanvas# 下的某个子节点出了问题。</p><p>于是尝试：</p><ul><li>隐藏 AorUICanvas# 除 AorUIStage# 以外的所有子节点，登录界面正常展示！</li></ul><p>在 AorUIStage# 层级更高的节点中，ipx 这个节点就比较可疑，再次进行测试，仅隐藏 ipx，登录界面也正常显示，白屏消失。</p><p>此时基本可以定位问题原因。</p><p>于是查看代码，我很快在 AdapteFullScreen() 方法中发现了这么些处理方法：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Application.platform == RuntimePlatform.Android &amp;&amp; Screen.width == <span class="number">2400</span> &amp;&amp; Screen.height == <span class="number">1080</span>)</span><br><span class="line">&#123;</span><br><span class="line">	isTest = <span class="literal">true</span>;<span class="comment">//关键就这里！！！！！！</span></span><br><span class="line">	YKApplication.Instance.IsIphoneX = <span class="literal">true</span>;</span><br><span class="line">	CommonModel.Inst.IsLandscapeLeft = <span class="literal">true</span>;</span><br><span class="line">	mIsFullAdapter = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//=====代码省略=======</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译器测试</span></span><br><span class="line"><span class="keyword">if</span> (isTest &amp;&amp; <span class="literal">null</span> == uiManger.mCanvasT.Find(<span class="string">&quot;ipx&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//创建 ipx 组件，该组件模拟 iphone 边框进显示</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-09-28/m_39da789ee4d022ce3dac2872115e7849_r.png"></p><p>大家看到了吗？</p><h5 id="EditorOnly！"><a href="#EditorOnly！" class="headerlink" title="EditorOnly！"></a>EditorOnly！</h5><p>也就是说，这张图片根本不会打进真机包里——然而代码却在实例化它？！</p><p>导致图片丢失，直接整个屏幕就是一块白色覆盖。</p><p>问题就是这样：代码执行了不应该真机生效的代码，错误地创建了一个根本不应该创建的东西，导致出现了这么一个很难让人一眼看出问题的问题。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>问题是解决了，但是花了一天多时间调试。</p><p>造成的根本原因是，<font color="red">项目代码里面直接强行判断若『当前为安卓平台，且分辨率为 2400x1080』，就会实例化测试边框，看起来完全是为了测试用(特别是注释都写了编辑器测试的)，且图片又是被标记为 EditorOnly ——而真机执行，测试边框的图通常情况下根本不会打出去，那就坏了！</font><br>注：我拿到项目这张图片就是 EditorOnly，代码也是这个样子，出包工程也并不存在 Resources 中图片的软链接</p><p>看注释还写着『编译器测试』，测试代码，如果只是想测试生效，就不应该这样加入正常代码流程，再不济用完也应该注释吧？或者再加个编辑器生效判断也好。</p><p>折腾这么大一通，倒也也不算没有收获：为守望项目整合了远程代码热更调试工具用，并详细测了一波热更代码，拿到守望项目代码之后，热更结构我也是做过改动的，因此测试一波也是也有必要。</p><h3 id="另一种解决方案"><a href="#另一种解决方案" class="headerlink" title="另一种解决方案"></a>另一种解决方案</h3><p>但实际上还有另一个方法，要是使用的话，一开始就能很快定位并解决问题：</p><h4 id="FrameDebugger"><a href="#FrameDebugger" class="headerlink" title="FrameDebugger"></a>FrameDebugger</h4><p>虽然 Unity2018 的 FrameDebugger 连接真机并不怎么好用，渲染对象跟随真机老是闪来闪去。</p><p>不过使用 FrameDebugger 连接真机后，还是可以大概查询渲染目标，可以清晰看出来：原本登录界面是正常渲染了的，只是登录界面上更上一层，被白色的东西直接盖了个彻彻底底。</p><p>进而定位渲染没问题，而是覆盖问题导致。</p><p>可惜我也是在查出问题后，才想起用这个连接真机试试的，要不然肯定会少许多麻烦了。</p><p>除此之外 Renderdoc 应该也可以。</p><div class="tags-container-bottom"><i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/问题解决记录/">#问题解决记录</a></div><br><br><hr><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MsaVbSzIr9cIfikihDExdun9-gzGzoHsz",appKey:"Bj6SEFUBomrLOTWx9B8S6zQH",placeholder:"请输入评论内容~",avatar:"mp",visitor:!1})</script></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l site-author"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/photo.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="CWHISME"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">悲观主义的末日</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>分类</h3><p><a href="/categories/Unity3D/">Unity3D</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>近期文章</h3><p><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/">协变和逆变</a></p><p><a href="/2022/12/06/Unity%E7%9A%84%E9%98%B4%E5%BD%B1%E4%B8%8E%E5%85%89%E7%85%A7%E7%83%98%E7%84%99/">Unity 的阴影与光照烘焙</a></p><p><a href="/2022/11/23/%E6%89%93%E5%8C%85AssetBundle%E5%9F%BA%E7%A1%80%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86/">打包 AssetBundle 的基础规则整理</a></p><p><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/">StringBuilder 扩容规则研究</a></p><p><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">简单测试手动垃圾回收</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/CWHISME" target="_blank"><i class="fa fa-github"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="mailto:cwhisme@126.com" target="_blank"><i class="fa fa-envelope"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">Copyright © 2021 | Design & Hexo <a class="link dim white" target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-anodyne/">Jonathan Klughertz</a> | Modify By CWHISME</div></div></div></body></html>