<!DOCTYPE html><meta name="viewport" content="height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cwhisme"><meta name="author" content="CWHISME"><meta property="og:title" content="音效资源设置测试与总结"><meta property="og:description" content="cwhisme"><meta property="og:site_name" content="WangJiaYing"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>音效资源设置测试与总结 - WangJiaYing</title><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/DateTimeAfeterCalc.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/particles-bg.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/script.js"></script><link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/css/style.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="WangJiaYing" type="application/atom+xml">
</head><body><canvas id="hackEffectCanvas" style="position:fixed;z-index:-1;pointer-events:none"></canvas><canvas class="fireworks" style="position:fixed;z-index:10;pointer-events:none"></canvas><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="WangJiaYing"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/logo.svg" class="dib h3" alt="WangJiaYing"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags" title="Tags">Tags </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/categories" title="Categories">Categories </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/bookmark" title="Bookmark">Bookmark </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="About">About</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">音效资源设置测试与总结</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2022-11-08&nbsp&nbsp <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="dateTimeAfter">2022-11-08</span></p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-snowflake-o"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><div class="tags-container-vertical"><div class="tags-sub-container"><a class="fw3 ph1 dib" href="/tags/性能优化/">#性能优化</a></div></div><h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>之前虽然有用过，但是并没有对其做个人的整理与总结，只大概知道哪个选项会造成什么情况，此处进行一次详尽的实际测试并总结。</p><h2 id="0x02-工具"><a href="#0x02-工具" class="headerlink" title="0x02 工具"></a>0x02 工具</h2><ul><li>Unity2021.3.6f1</li><li>UnityProfiler</li><li>音效：<img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_2c999f422afd7de75758f0b6ae7a97c5_r.png"></li></ul><h2 id="0x03-设置选项"><a href="#0x03-设置选项" class="headerlink" title="0x03 设置选项"></a>0x03 设置选项</h2><h3 id="1-LoadType"><a href="#1-LoadType" class="headerlink" title="1. LoadType"></a>1. LoadType</h3><p>分为三个选项，这个选择比较重要：直接决定音效在内存中的大小。</p><h4 id="1-加载即解压-Decompress-On-Load"><a href="#1-加载即解压-Decompress-On-Load" class="headerlink" title="1). 加载即解压(Decompress On Load)"></a>1). 加载即解压(Decompress On Load)</h4><p>性能最好，不过会占用更多内存。</p><p>在内存中的大小至少是选择 PCM 压缩格式在 ImportedSize 的预览大小——因为在选择 Vorbis 后，再选择解压到内存会多一些。</p><p>分别查看设置对应压缩格式后，Imported Size 以及利用 Profiler 查看运行时内存大小。<br>对比如下：</p><ul><li>PCM：<br>Imported Size：306KB<br>运行时内存：309.6KB(+3.6KB)</li><li>ADPCM：<br>Imported Size：86.2KB<br>运行时内存：310.1KB(+4KB)</li><li>Vorbis(1%质量)：<br>Imported Size：13.9KB<br>运行时内存：343.2KB(+37.2KB)</li><li>Vorbis(70%质量)：<br>Imported Size：16.6KB<br>运行时内存：345.7KB(+39.7KB)</li><li>Vorbis(100%质量)：<br>Imported Size：22.9KB<br>运行时内存：348.1KB(+42KB)</li></ul><p>采样率设置为 <strong>22050Hz</strong>：</p><ul><li>PCM：<br>Imported Size：153.1KB<br>运行时内存：156.7KB(+3.6KB)</li><li>ADPCM：<br>Imported Size：43.1KB<br>运行时内存：157.1KB(+4KB)</li><li>Vorbis(1%质量)：<br>Imported Size：7.6KB<br>运行时内存：192.9KB(+40KB)</li><li>Vorbis(70%质量)：<br>Imported Size：9.5KB<br>运行时内存：192.9KB(+40KB)</li><li>Vorbis(100%质量)：<br>Imported Size：12KB<br>运行时内存：192.9KB(+40KB)</li></ul><p>Decompress On Load 模式下，在内存中的音效大小与 PCM 的 ImportedSize 显示的大小差不多，其中 PCM 和 ADPCM 在这个基础上多了几KB，可能是其它数据。</p><p>而当 Vorbis 压缩格式采用 Decompress On Load 则会导致更多的额外内存消耗，平均 40KB 左右。<br><del>且会随着质量设置越高而增加。</del>，见下方『注1』，推测为音效源文件 44100Hz 有不一致的地方，手动设置为更低采样率后保存一致。</p><h4 id="2-压缩格式存放在内存-Compressed-In-Memory"><a href="#2-压缩格式存放在内存-Compressed-In-Memory" class="headerlink" title="2). 压缩格式存放在内存(Compressed In Memory)"></a>2). 压缩格式存放在内存(Compressed In Memory)</h4><p>播放时会额外消耗CPU解压，内存情况测试如下：</p><p>Original Size：<strong>32.8KB</strong></p><ul><li>PCM：<br>Imported Size：306KB<br>运行时内存：309.7KB(+3.7KB)</li><li>ADPCM：<br>Imported Size：86.2KB<br>运行时内存：90.7KB(+4.5KB)</li><li>Vorbis(1%质量)：<br>Imported Size：13.9KB<br>运行时内存：39.1KB(+25.2KB)</li><li>Vorbis(70%质量)：<br>Imported Size：16.6KB<br>运行时内存：44.1KB(+27.5KB)</li><li>Vorbis(100%质量)：<br>Imported Size：22.9KB<br>运行时内存：52.9KB(+30KB)</li></ul><p>采样率设置为 <strong>22050Hz</strong>：</p><ul><li>PCM：<br>Imported Size：306KB<br>运行时内存：309.7KB(+3.7KB)</li><li>ADPCM：<br>Imported Size：86.2KB<br>运行时内存：90.7KB(+4.5KB)</li><li>Vorbis(1%质量)：<br>Imported Size：7.6KB<br>运行时内存：35.3KB(+27.7KB)</li><li>Vorbis(70%质量)：<br>Imported Size：9.5KB<br>运行时内存：37.3KB(+27.7KB)</li><li>Vorbis(100%质量)：<br>Imported Size：12KB<br>运行时内存：39.8KB(+27.7KB)</li></ul><p>通过测试可以看出：</p><p>Compressed In Memory 模式下，PCM 和 ADPCM 下内存占用情况为预览面板的 ImportedSize + 几KB，总体上差不多。</p><p>Vorbis 压缩模式会额外占用更多内存(大概多了 30KB 左右)。<br><del>且会随着质量设置越高而增加。</del>，见下方『注1』，推测为音效源文件 44100Hz 有不一致的地方，手动设置为更低采样率后保存一致。</p><h4 id="3-流式播放-Streaming"><a href="#3-流式播放-Streaming" class="headerlink" title="3). 流式播放(Streaming)"></a>3). 流式播放(Streaming)</h4><p>流式播放占用内存相对整个文件来说比较少——前提是音效文件本身大于 200KB，根据官方文档介绍，就算小于200KB的音效，采用流式播放也会产生 200KB 左右的缓存消耗。</p><p>坏处是播放的时候对 IO、CPU 都会有额外开销。</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_8a5a8185e25aa508822013b2229e98e0_r.png"></p><p>以上述两个音效文件为例，当设置一致(SampleRateSetting为PreserveSampleRate[44100Hz])，并采用流式播放时结果如下：</p><ul><li>PCM：197.7KB</li><li>ADPCM：198KB</li><li>Vorbis(1%质量)：231.3KB</li><li>Vorbis(70%质量)：233.8KB</li><li>Vorbis(100%质量)：236.2KB</li></ul><p>Vorbis 下会多 30KB 左右，且受质量设置影响(比较小)</p><p>质量影响量太小了，尝试手动设置一下 Sample Rate 为 <strong>44100Hz</strong>：</p><ul><li>PCM：197.7KB</li><li>ADPCM：198KB</li><li>Vorbis(1%质量)：231.3KB</li><li>Vorbis(70%质量)：233.8KB</li><li>Vorbis(100%质量)：236.2KB</li></ul><p>发现同一采样率下，缓存内存占用量没有变化，另外选择 <strong>Optimiz SampleRate</strong> 也是同样的内存占用结果。</p><p>依然以上述两个音效为例，将 Sample Rate 手动设置为 <strong>22050Hz</strong>：</p><ul><li>PCM：163.7KB</li><li>ADPCM：164KB</li><li>Vorbis(1%质量)：199.9KB</li><li>Vorbis(70%质量)：199.9KB</li><li>Vorbis(100%质量)：199.9KB</li></ul><p>可以看到，Vorbis下依然会多 30KB 左右，但是质量选择已经没有影响了。</p><p>接着缓存 <strong>8000Hz</strong> 的 Sample Rate：</p><ul><li>PCM：141.7KB</li><li>ADPCM：142KB</li><li>Vorbis(1%质量)：167.9KB</li><li>Vorbis(70%质量)：167.9KB</li><li>Vorbis(100%质量)：167.9KB</li></ul><p>可以得出结论：Streaming 播放音效时，至少会产生 140KB(最低8000Hz采样率) 左右的内存缓存，Vorbis 压缩格式下会额外增加 30KB 左右的消耗。</p><p>采样率(越低内存占用越低)、强制单声道也会统一影响到三种设置在流式的缓存占用)，</p><p><font color="red">注1：上述 <strong>44100Hz</strong> 采样率时，Vorbis 压缩下内存占用会有微小差异，同样适用于 Decompress On Load、Compressed In Memory，推测是音效源文件的采样率部分不一致导致，因为手动设置为更低采样率后就保持一致了。</font></p><h3 id="2-Compression-Format-压缩格式"><a href="#2-Compression-Format-压缩格式" class="headerlink" title="2. Compression Format(压缩格式)"></a>2. Compression Format(压缩格式)</h3><ul><li>PCM：不压缩，效果最好文件最大，试过甚至比导入音效本身文件都还大<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_53f9ea44065a5a44a00872836c0c4db6_r.png"></li><li>ADPCM：有一定压缩效果，压缩率视情况音效源文件而定，经过测试一般在 50%~80% 浮动，也可能比源文件大小更大。<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_d5e6f3117362ddf0191c81fc14ff473d_r.png"></li><li>Vorbis/Mp3：压缩率最高的方式，唯一确定一定能压缩大小的选项，该选项还可以额外设置 Quality，值越小，压缩越厉害，大小也越小<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_b9d67a27160a7a123e41e7187626c837_r.png"></li></ul><h3 id="3-Force-To-Mono"><a href="#3-Force-To-Mono" class="headerlink" title="3. Force To Mono"></a>3. Force To Mono</h3><p>强制单声道，例如下图：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_6b48857f690b8f651eb8298e484f2393_r.png"></p><p>这个音效就包含了 ch1、ch2 两个声道，若勾选该项，两个声道将会合并为一个，并减少一部分大小。</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_e5634eac0a5337c2917083632be16d38_r.png"></p><p>测试结果：</p><p><strong>文件1：</strong></p><ul><li>PCM：153.1KB-&gt;76.6KB(50%)</li><li>ADPCM：43.1KB-&gt;21.6KB(50%)</li><li>Vorbis(1%)：7.6KB-&gt;6.4KB(15%)</li><li>Vorbis(100%)：12KB-&gt;9.8KB(18%)</li></ul><p><strong>文件2：</strong></p><ul><li>PCM：9.6MB-&gt;4.8MB(50%)</li><li>ADPCM：2.7MB-&gt;1.4MB(50%)</li><li>Vorbis(1%)：0.6MB-&gt;426.3KB(30%)</li><li>Vorbis(100%)：2.8MB-&gt;0.6MB(80%)</li></ul><p>通过对两个音效文件：一个大文件及一个小文件对比，可以得出结论：</p><p>强制单声道选项中，PCM 和 ADPCM 的格式可以减少 50% 大小，Vorbis 视压缩质量及音效本身大小而定——这个应该跟音效本身两个通道数据量有关，文件2实测双通道声音会有更大的差异。</p><p>注：单声道并不是说只有一个喇叭会播放声音，而是两个喇叭播放同样的声音。</p><h3 id="4-Sample-Rate"><a href="#4-Sample-Rate" class="headerlink" title="4. Sample Rate"></a>4. Sample Rate</h3><p>采样率，在不影响效果的情况，还可以考虑设置统一的更低的采样率，也会影响大小。</p><p>对于影响效果，测试结果如下：</p><ul><li>PCM(44100Hz)：306KB-&gt;153.1KB(22050Hz)-&gt;76.6KB(11025Hz)-&gt;55.6KB(8000Hz)</li><li>ADPCM(44100Hz)：86.2KB-&gt;43.1KB(22050Hz)-&gt;21.6KB(11025Hz)-&gt;15.7KB(8000Hz)</li><li>Vorbis(1%)(44100Hz)：13.9KB-&gt;7.6KB(22050Hz)-&gt;8.7KB(11025Hz)-&gt;6.1KB(8000Hz)</li><li>Vorbis(100%)(44100Hz)：22.9KB-&gt;12KB(22050Hz)-&gt;11.8KB(11025Hz)-&gt;8.8KB(8000Hz)</li></ul><p>从上述测试结果可以看出，采样率对内存占用影响成比例关系：减少多少采样率，相对就减少多少空间。</p><p>我们游戏音效导入默认是 44100Hz ，就是统一将其设置为 22050Hz，相比初始默认的 44100Hz，减少一半占用，Vorbis 压缩有部分浮动，不过也大体符合规则。</p><h3 id="5-Preload-Audio-Data"><a href="#5-Preload-Audio-Data" class="headerlink" title="5. Preload Audio Data"></a>5. Preload Audio Data</h3><p>根据说明，是会在场景加载时预先加载，默认开启的，适用于那种直接拖到 GameObject 上的音效，过多估计会影响场景加载速度。</p><p>一般最好关了，因为我们都是代码动态加载播放，场景不会直接挂。所以这个选项实际上没用。</p><h3 id="6-Load-In-Background"><a href="#6-Load-In-Background" class="headerlink" title="6. Load In Background"></a>6. Load In Background</h3><p>在单独线程延迟加载，不卡主线程，但是这个选项或许会造成音画不同步。</p><h2 id="0x04-总体资源消耗测试"><a href="#0x04-总体资源消耗测试" class="headerlink" title="0x04 总体资源消耗测试"></a>0x04 总体资源消耗测试</h2><p>上面在单项设置中，分别对比过各自会在内存中的占用量，此处将对 内存、CPU 消耗作一个总体对比。</p><p>对于如何测试 CPU 性能的消耗，由于单个音效的播放时很不明显，因此我在测试时采用 20 份播放同一个音效的 AudioSource，并对比总消耗、使用 Profiler 检查每个设置对 CPU 消耗造成的影响，取平均出现最多的值。</p><p>同时为了减少内存误差，测试文件更换了一个更大的音效，OriginalSize 为 2.8MB。</p><p>其默认测试设置如下：<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_8ffecf7064f644e1473a9626eb88d393_r.png"></p><h4 id="1-压缩格式：Vorbis-1-质量"><a href="#1-压缩格式：Vorbis-1-质量" class="headerlink" title="1) 压缩格式：Vorbis(1%质量)"></a>1) 压缩格式：Vorbis(1%质量)</h4><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_e427525c6a80e39dc0ecddc990751942_r.png"></p><p>从左自右 LoadType 分别为： Decompress On Load、Compress In Memery、Streaming</p><p>CPU消耗：1%-&gt;2.5%-&gt;2.8%<br>内存消耗：7.3MB-&gt;2.8MB-&gt;5.9MB</p><h4 id="2-压缩格式：Vorbis-100-质量"><a href="#2-压缩格式：Vorbis-100-质量" class="headerlink" title="2) 压缩格式：Vorbis(100%质量)"></a>2) 压缩格式：Vorbis(100%质量)</h4><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_fcd8822723b729b78904dfc82246b15c_r.png"></p><p>从左自右 LoadType 分别为： Decompress On Load、Compress In Memery、Streaming</p><p>CPU消耗：1%-&gt;4.9%-&gt;5%<br>内存消耗：7.3MB-&gt;3.7MB-&gt;5.9MB</p><h4 id="3-压缩格式：ADPCM"><a href="#3-压缩格式：ADPCM" class="headerlink" title="3) 压缩格式：ADPCM"></a>3) 压缩格式：ADPCM</h4><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_2c08a89d388540ae8df5de75acd03a33_r.png"></p><p>从左自右 LoadType 分别为： Decompress On Load、Compress In Memery、Streaming</p><p>CPU消耗：1%-&gt;1.8%-&gt;2.1%<br>内存消耗：7.2MB-&gt;3.8MB-&gt;5.6MB</p><h4 id="4-压缩格式：PCM"><a href="#4-压缩格式：PCM" class="headerlink" title="4) 压缩格式：PCM"></a>4) 压缩格式：PCM</h4><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_531b2b0591cf77c7e75377e99be059ec_r.png"></p><p>从左自右 LoadType 分别为： Decompress On Load、Compress In Memery、Streaming</p><p>CPU消耗：1%-&gt;1.1%-&gt;1.4%<br>内存消耗：7.2MB-&gt;7.2MB-&gt;5.6MB</p><h4 id="5-总结"><a href="#5-总结" class="headerlink" title="5) 总结"></a>5) 总结</h4><p>上述测试结果中，感觉其中 Streaming Vorbis 内存占用与预计的有点不符，于是使用单 AudioSource 额外进行测试：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_8ea6c5c446af60829b7e9b32c492c26b_r.png"></p><p>Streaming 播放模式，从左自右分别为：Vorbis(100%质量)-&gt;Vorbis(1%质量)-&gt;ADPCM-&gt;PCM</p><p>CPU消耗：0.5%-&gt;0.5%-&gt;0.4%-&gt;0.3%<br>内存消耗：2.6MB-&gt;2.6MB-&gt;2.5MB-&gt;2.5MB</p><p>Vorbis 压缩格式，在 Streaming 下 Taotal Audio Memery 消耗多了 100KB 的样子，而在上面使用 Take Sample 单个查看时只额外多了 30KB 内存占用。</p><p>这里只能推测两个原因：</p><ul><li>要么 Taotal Audio Memery 还计算了其它数据</li><li>要么由于统计没有显示具体 KB 消耗值导致的误认(例如 PCM 原本为 2.57MB 一类，加上 30KB 左右就到 2.6MB 了)。</li></ul><p>另外需要注意的是，Streaming 播放模式下，会随着通同一个文件的反复加载，而叠加文件流及解码内存消耗——例如上述单个播放为 124KB-&gt;20个=124KBx20=2.4MB</p><h5 id="总体内存消耗："><a href="#总体内存消耗：" class="headerlink" title="总体内存消耗："></a>总体内存消耗：</h5><p>Decompress On Load：Vorbis 额外 30KB 左右内存消耗，总体差不多<br>Compress In Memery：PCM-&gt;ADPCM-&gt;Vorbis(100%质量)-&gt;Vorbis(1%质量)<br>Streaming：Vorbis 额外几十KB内存消耗，总体差不多</p><h5 id="总体CPU消耗："><a href="#总体CPU消耗：" class="headerlink" title="总体CPU消耗："></a>总体CPU消耗：</h5><p>Decompress On Load：CPU消耗基本一致<br>Compress In Memery：Vorbis(100%质量)-&gt;Vorbis(1%质量)-&gt;ADPCM-&gt;PCM<br>Streaming：Vorbis(100%质量)-&gt;Vorbis(1%质量)-&gt;ADPCM-&gt;PCM</p><h4 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h4><blockquote><p>对于总体内存消耗，或许会有疑问（比如说我自己）：在测试单个音效播放时，Profiler Audio 面板中的 Total Audio Memery 的内存数值，比 Profiler Memery 面板中 Take Sample 获取到的单个音效内存占用更大，这个是每个音效实际都比 TakeSample 大些，还是说仅仅因为 Total Audio Memery 计算了其它额外内存？</p></blockquote><p>于是进行测试，首先是空场景 Audio 信息统计：<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_c1482d2c86711e3b82d23fed6e922ae3_r.png"></p><p>接着使用三个不同大小的音效，使用 PCM(Decompress On Load) 格式进行播放，查看 Total Audio Memery 数值：<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_62f502a630dccf7903d280cd34439677_r.png"></p><p>可以发现 Total Audio Memery 数值是根据 PCM Imported Size 大小增加的，Sample Sound Memery(Decompress On Load 解压内存占用量) 亦是按照实际大小跟随递增。</p><h5 id="补充-PCM-Compressed-In-Memory-模式："><a href="#补充-PCM-Compressed-In-Memory-模式：" class="headerlink" title="补充 PCM(Compressed In Memory) 模式："></a>补充 PCM(Compressed In Memory) 模式：</h5><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_93c42e0ec47651dd4433f781999ed190_r.png"><br>DSP CPU：项目在加载类型为 Compressed In Memory 的非流式声音的混音、音频效果和解压缩中使用的 CPU 量。<br>Sample Sound Memory：加载类型为 Decompress On Load 的音频文件用于所有已解压缩样本数据的内存量。</p><p>也就是可以得出结论：</p><ul><li>Total Audio Memery 是所有内存总量，确实是计算了额外消耗内存的。</li><li>Profiler Memery 面板中 Take Sample 获取到的单个音效内存就是实际占用量，与总消耗内存可以表现出一种递增的对应关系。</li><li>PCM 虽然是无压缩格式，但若是选择 Compressed In Memory ，虽然单个音效内存跟选择与否没有变化，但对总体内存也会有一定影响(测试表现是增加了一点)。</li></ul><h2 id="0x05-压缩格式对最终-AssetBunle-资源影响"><a href="#0x05-压缩格式对最终-AssetBunle-资源影响" class="headerlink" title="0x05 压缩格式对最终 AssetBunle 资源影响"></a>0x05 压缩格式对最终 AssetBunle 资源影响</h2><h4 id="1-默认设置、SampleRate-22050Hz、PCM-格式："><a href="#1-默认设置、SampleRate-22050Hz、PCM-格式：" class="headerlink" title="1) 默认设置、SampleRate 22050Hz、PCM 格式："></a>1) 默认设置、SampleRate 22050Hz、PCM 格式：</h4><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_0d325cddd386fb945373c5d125e95248_r.png"><br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_0d75a39f780213b3007ecbd23f996ac8_r.png"></p><h4 id="2-默认设置、SampleRate-22050Hz、ADPCM-格式："><a href="#2-默认设置、SampleRate-22050Hz、ADPCM-格式：" class="headerlink" title="2) 默认设置、SampleRate 22050Hz、ADPCM 格式："></a>2) 默认设置、SampleRate 22050Hz、ADPCM 格式：</h4><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_de861340a651647f686105eb35f7fb16_r.png"><br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_16d83cb95231207d45e0362af6914021_r.png"></p><h4 id="3-默认设置、SampleRate-22050Hz、Vorbis-压缩，质量-70-："><a href="#3-默认设置、SampleRate-22050Hz、Vorbis-压缩，质量-70-：" class="headerlink" title="3) 默认设置、SampleRate 22050Hz、Vorbis 压缩，质量 70%："></a>3) 默认设置、SampleRate 22050Hz、Vorbis 压缩，质量 70%：</h4><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_7eea0eda7f26befe6ca6567c999d3493_r.png"><br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-11-08/m_a22fc28a39eb76fc140d69a392fd0928_r.png"></p><p>可以看出，跟图片压缩一样，压缩格式对最终出包的 AssetBunle 资源大小也会有影响，除压缩方式选择外，Vorbis 压缩质量数值也会影响。</p><p>最终 AssetBundle 包大小基本与音效面板上的 ImportedSize 差不多(+部分AssetBundle额外数据)。</p><h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><p>测试结果有些与之前预想的一致，也有部分预想被『推翻』。</p><p>在<font color="blue">内存占用量</font>上，对于 Decompress On Load、Compressed In Memory、Streaming 三种 LoadType 方式：</p><ul><li>Decompress On Load 是以 <font color="red">PCM 格式下 ImportedSize 大小</font>为基准，PCM、ADPCM 格式下在内存解压后占用量基本一致，Vorbis 多占用 40KB 左右</li><li>Compressed In Memory：压缩模式存放内存，Vorbis 压缩会比 <font color="red">自身 ImportedSize</font> 大 30KB 左右</li><li>Streaming 以 200KB 缓存为基准，Vorbis 压缩后加载相比另外两种会额外占用 30KB 左右的内存。<br><font color="red">注1：关于内存占用比较基准，需要注意的是比较基准对象是不同的，这篇文章写完了，我脑袋就混乱了几天才反应过来</font><br><font color="red">注2：大的音效也满足该标准，上述 OriginalSize 为 2.8MB、32.8KB 的音效 Profiler 表现基本一致</font></li></ul><p>在 <font color="blue">CPU 资源消耗</font>上，对于 Decompress On Load、Compressed In Memory、Streaming 三种 LoadType 方式：</p><ul><li>Decompress On Load：CPU 消耗差不多</li><li>Compressed In Memory：压缩存放内存时，以 PCM-&gt;ADPCM-&gt;Vorbis(质量越高消耗越多)</li><li>Streaming：流式播放时，以 PCM-&gt;ADPCM-&gt;Vorbis(质量越高消耗越多)</li></ul><p>在<font color="blue">音效质量</font>上：</p><ul><li>主要受压缩格式影响。PCM 不压缩效果最好，ADPCM 其次，Vorbis 最后。</li><li>对此可以在预览面板看出，更换压缩格式后，振幅会有轻微变动——不过从实际听起来的效果看，PCM、ADPCM 和 Vorbis 高质量压缩下的效果差不多，至少个人没听出太大差别。</li><li>经过测试，如果源音效质量就不大行，PCM 和 Vorbis 效果是一样，修改该项音效振幅不会发生任何改动——甚至 Vorbis 1%~100% 质量都没有差别，比如测试所用的 『lvbu』 音效。</li></ul><p>另外 Force To Mono、Sample Rate 统一影响上述表现(CPU、内存消耗、表现质量)</p><p>经过上面的测试，可以发现音效设置主要是质量换效率、或者空间换时间、或者时间换空间，总有一定取舍。</p><p>因此最后再说一下个人总结：</p><ul><li>可以使用 PCM 模式下的 Imported Size 预估实际解压消耗内存量</li><li>没有绝对的最好设置，这个设置可能需要平衡 包体、内存、CPU 消耗得出结论，前期可以选择一个合适的格式统一设置，后续完整了再进行具体优化</li><li>以 PCM ImportedSize 为基准，一两百KB、比较频繁使用的小音效，例如按钮声音、战斗中的技能音效，可以考虑使用 ADPCM 压缩格式<br>普通小音效选择 Compress In Memery、非常频繁的音效选择 Decompress On Load</li><li>大一点或者比较少用的音效，不至于常影响到 CPU，采用 Vorbis 压缩，LoadType 采用 Compress In Memery。</li><li>采用 Vorbis 压缩可以调节质量滑块减少内存及 CPU 消耗(当然这样音效质量也会受到影响)</li><li>十几兆或者几十兆的，如果直接放在内存会很影响的情况下再考虑是否用流式播放(感觉手游应该也不至于，对于手游来说还是有点奢侈了)，采用流式播放最好采用 ADPCM 或 PCM 格式了，省一些播放时的 CPU 解压消耗。</li><li>另外在可以接受的情况下， Sample Rate 可以设置为 22050Hz，比默认 44100Hz 减少一半的占用</li><li>Force To Mono 在小音效上应该也可以勾上，例如按钮点击音效总不能也是真的立体声吧，也可以省下一半资源。不过在音效源文件本身就是纯单通道的时候，勾选与否都没有影响</li></ul><p>在我们游戏中，都是采用前两种 LoadType+Vorbis 压缩方式，质量70%、压缩模式存放(Compressed In Memory)、SampleRate 22050Hz。</p><p>注：选择压缩同时也会影响打包资源大小，最终 AssetBundle 包大小基本与音效面板上的 ImportedSize 差不多(+部分AssetBundle额外数据)。最终设置得权衡质量、包体和内存及性能。</p><div class="tags-container-bottom"><i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/性能优化/">#性能优化</a></div><br><br><hr><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MsaVbSzIr9cIfikihDExdun9-gzGzoHsz",appKey:"Bj6SEFUBomrLOTWx9B8S6zQH",placeholder:"请输入评论内容~",avatar:"mp",visitor:!1})</script></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l site-author"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/photo.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="CWHISME"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">悲观主义的末日</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>分类</h3><p><a href="/categories/Unity3D/">Unity3D</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>近期文章</h3><p><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/">协变和逆变</a></p><p><a href="/2022/12/06/Unity%E7%9A%84%E9%98%B4%E5%BD%B1%E4%B8%8E%E5%85%89%E7%85%A7%E7%83%98%E7%84%99/">Unity 的阴影与光照烘焙</a></p><p><a href="/2022/11/23/%E6%89%93%E5%8C%85AssetBundle%E5%9F%BA%E7%A1%80%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86/">打包 AssetBundle 的基础规则整理</a></p><p><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/">StringBuilder 扩容规则研究</a></p><p><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">简单测试手动垃圾回收</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/CWHISME" target="_blank"><i class="fa fa-github"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="mailto:cwhisme@126.com" target="_blank"><i class="fa fa-envelope"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">Copyright © 2021 | Design & Hexo <a class="link dim white" target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-anodyne/">Jonathan Klughertz</a> | Modify By CWHISME</div></div></div></body></html>