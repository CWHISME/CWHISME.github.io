<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="WangJiaYing" href="https://cwhisme.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="WangJiaYing" href="https://cwhisme.github.io/atom.xml"><link rel="alternate" type="application/json" title="WangJiaYing" href="https://cwhisme.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="问题记录"><link rel="canonical" href="https://cwhisme.github.io/2022/07/20/%E5%85%B3%E4%BA%8E%E6%B1%89%E5%AE%A4%E5%A4%8D%E5%85%B4%E5%8D%87%E7%BA%A7Unity2021%E7%9A%84%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"><title>关于汉室复兴升级 Unity2021 的问题记录 - 问题 - Unity3D | Jiaying's Note = WangJiaYing = 人不能没有梦想，也要有足够的敬畏</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">关于汉室复兴升级 Unity2021 的问题记录</h1><div class="meta"><span class="item" title="创建时间：2022-07-20 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-07-20T00:00:00+08:00">2022-07-20</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>22k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>20 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Jiaying's Note</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="/images/coverimages/large/6833939bly1gipevgoki5j20zk0m84qp.webp"></li><li class="item" data-background-image="/images/coverimages/large/6833939bly1gicitht3xtj20zk0m8k5v.webp"></li><li class="item" data-background-image="/images/coverimages/large/6833939bly1gipevarprfj20zk0m8npd.webp"></li><li class="item" data-background-image="/images/coverimages/large/006gkh44ly1fw6amsexm3j31hc0xc7lx.webp"></li><li class="item" data-background-image="/images/coverimages/large/6833939bly1giclfdu6exj20zk0m87hw.webp"></li><li class="item" data-background-image="/images/coverimages/large/0072Vf1pgy1foxk6xtxhrj31hc0u07o0.webp"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Unity3D/" itemprop="item" rel="index" title="分类于 Unity3D"><span itemprop="name">Unity3D</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Unity3D/%E9%97%AE%E9%A2%98/" itemprop="item" rel="index" title="分类于 问题"><span itemprop="name">问题</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://cwhisme.github.io/2022/07/20/%E5%85%B3%E4%BA%8E%E6%B1%89%E5%AE%A4%E5%A4%8D%E5%85%B4%E5%8D%87%E7%BA%A7Unity2021%E7%9A%84%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/../img/avator"><meta itemprop="name" content="CWHISME"><meta itemprop="description" content="人不能没有梦想，也要有足够的敬畏, ✧⁺˚⁺ପ(๑･ω･)੭ु⁾⁾ 好好学习天天向上"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="WangJiaYing"></span><div class="body md" itemprop="articleBody"><h2 id="一-ugui"><a class="anchor" href="#一-ugui">#</a> 一、UGUI</h2><ol><li><h3 id="超链接"><a class="anchor" href="#超链接">#</a> 超链接</h3><p><font color="blue">已解决</font>，超链接点击返回剔除富文本信息</p><p>详细可见另一篇文档：<a href="">处理 Unity2019 的 UGUI 顶点数据更新后的图文混排问题</a></p></li><li><h3 id="图文混排"><a class="anchor" href="#图文混排">#</a> 图文混排</h3><p><font color="blue">已解决</font>，计算表情绘制下标时剔除表情标签、剔除富文本信息</p><p>详细可见另一篇文档：<a href="">处理 Unity2019 的 UGUI 顶点数据更新后的图文混排问题</a></p></li><li><h3 id="竖行排版"><a class="anchor" href="#竖行排版">#</a> 竖行排版</h3><p>由于 Unity 本身提供的 UILineInfo 包含了换行符信息、而顶点数据并不包括导致。</p><p><font color="blue">已解决</font>，自行通过『\n』 分割文本，并剔除富文本信息再作计算。</p><p>详细可见另一篇文档：<a href="">处理 Unity2019 的 UGUI 顶点数据更新后的图文混排问题</a></p></li><li><h3 id="aortextincsprites-缺少最后一位内容"><a class="anchor" href="#aortextincsprites-缺少最后一位内容">#</a> AorTextIncSprites 缺少最后一位内容</h3><p><img data-src="/blogimages/2022/2022-07-20/m_439c7a477ded75b326cac421a41d65fd_r.png" alt=""></p><p>查看代码，并经过调试，最后发现是因为绘制时手动减掉了最后 4 位顶点，关键代码如下：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//Last 4 verts are always a new line...</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token keyword">int</span></span> vertCount <span class="token operator">=</span> verts<span class="token punctuation">.</span>Count<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这里根据注释，就可以明白了，最后一位以前是当换行符去掉了，新版顶点并无这些信息，不再减去 4 个顶点即可。</p></li><li><h3 id="行军线绘制"><a class="anchor" href="#行军线绘制">#</a> 行军线绘制</h3><p>使用 UGUI + 自定义 Shader 实现</p><p>由于自定义 UGUI 顶点绘制，新版 Unity 无法正常工作，通过禁用 raycastTarget 可以避免报错，走上正常逻辑，但不可见。</p><ul><li>2022.7.22 打出来真机包可见，此时暂时可排除顶点绘制函数本身逻辑不兼容嫌疑</li><li>后进行调试，发现新新军线绘制代码 OnPopulateMesh 无调用</li><li>后查询 UGUI Graphic 源码，得知更新条件需要 CanvasRender<br><img data-src="/blogimages/2022/2022-07-20/m_d50be37f3cd0c49e815f66e70b787669_r.png" alt=""></li><li>并经调试查询，发现内部有缺失 CanvasRender 报错<br><img data-src="/blogimages/2022/2022-07-20/m_c943e0bf3357ca87f645cd426145353d_r.png" alt=""></li><li>由此可知 CanvasRender 是一个关键点</li><li>尝试运行时手动添加，无效</li><li>尝试按照源码规则调用，发现获取失败<br><img data-src="/blogimages/2022/2022-07-20/m_7ecd4aafe84f4752c9fe73b537f8d171_r.png" alt=""></li><li>且修改调用方式 <code>gameObject.GetComponent&lt;CanvasRenderer&gt;()</code> 可以获取<br><img data-src="/blogimages/2022/2022-07-20/m_d85b58ad27084a3c2efae6d069e95f63_r.png" alt=""></li><li>该类直接放置于另一个类脚本中，按理说挂载的脚本都是单独一个类，且类名需与代码文件名一致，怀疑是否因此问题导致 (<font color="red">尝试后表明于此无关</font>)</li><li>试图添加此绘制组件前，先添加 CanvasRender，cull 置为 false</li></ul><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>obj<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CanvasRenderer<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cull <span class="token operator">=</span> <span class="token boolean">false</span></pre></td></tr></table></figure><p><font color="blue">已解决</font><br><img data-src="/blogimages/2022/2022-07-20/m_33c2313e54dd4d1f7cb1dc921dec1a06_r.png" alt=""></p><p>注：其实 UGUI 源代码中，对于 CanvasRenderer 的获取，也是做了额外判断的，若获取空则会添加，不清楚是什么条件造成了添加代码无效的。<br><img data-src="/blogimages/2022/2022-07-20/m_b47fe4fe20e60f187a188c892533a313_r.png" alt=""></p></li><li><h3 id="aoruistage-自适应子节点长宽为-nan"><a class="anchor" href="#aoruistage-自适应子节点长宽为-nan">#</a> AorUIStage# 自适应子节点长宽为 NaN</h3><p>可确定由 AorUiRuntimeUtility 动态创建 AorUIStage# 后，再动态创建可自适应大小的 MainLayer 子容器导致</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//AorUIStage</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">GameObject</span> stage <span class="token operator">=</span> <span class="token function">CreatePrefab_UIBase</span><span class="token punctuation">(</span>canv<span class="token punctuation">.</span>transform<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">512f</span><span class="token punctuation">,</span> <span class="token number">512f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>stage<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"AorUIStage#"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//AorUIStage.mainLayer</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token class-name">GameObject</span> ml <span class="token operator">=</span> <span class="token function">CreatePrefab_UIBase</span><span class="token punctuation">(</span>stage<span class="token punctuation">.</span>transform<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>ml<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"MainLayer"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name">GameObject</span> tl <span class="token operator">=</span> <span class="token function">CreatePrefab_UIBase</span><span class="token punctuation">(</span>stage<span class="token punctuation">.</span>transform<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>tl<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"TopLayer"</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>修改 AorUIManager updateStageSize 方法，增加重置计算</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">updateStageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>Application<span class="token punctuation">.</span>isEditor <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Application<span class="token punctuation">.</span>isPlaying<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAwakeInit <span class="token operator">||</span> <span class="token operator">!</span>isInit<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">switch</span> <span class="token punctuation">(</span>_scaleMode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token keyword">case</span> ScaleModeType<span class="token punctuation">.</span>widthBase<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token function">set2WidthBaseMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token keyword">case</span> ScaleModeType<span class="token punctuation">.</span>heightBase<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token function">set2HeightBaseMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">case</span> ScaleModeType<span class="token punctuation">.</span>fitScreen<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>			<span class="token function">set2FitScreenMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		<span class="token keyword">case</span> ScaleModeType<span class="token punctuation">.</span>envelopeScreen<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>			<span class="token function">set2EnvelopeScreenMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		<span class="token keyword">default</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token comment">// 升级 2019 后，自适应子节点会出现问题，这里强制重设一次</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Stage<span class="token punctuation">.</span>childCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token class-name">RectTransform</span> rt <span class="token operator">=</span> Stage<span class="token punctuation">.</span><span class="token function">GetChild</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">RectTransform</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		rt<span class="token punctuation">.</span>anchoredPosition <span class="token operator">=</span> Vector2<span class="token punctuation">.</span>zero<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		rt<span class="token punctuation">.</span>sizeDelta <span class="token operator">=</span> Vector2<span class="token punctuation">.</span>zero<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><font color="blue">已解决</font><br>注：解决方式应当不止这种。</p></li></ol><h2 id="二-socket-连接"><a class="anchor" href="#二-socket-连接">#</a> 二、Socket 连接</h2><p>在编辑器 / 真机包 返回登录界面时触发。</p><p><img data-src="/blogimages/2022/2022-07-20/m_ed85e95c10d4bbb8684ab4b6b7720062_r.png" alt=""></p><p>查询是由于调用 <code>socket.Disconnect(true);</code> 导致，估计是以前想复用 Socket 实例，不过查了下代码，每次 open 实际上都是重新创建的一个，将 Disconnect 的调用替换为如下代码解决：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">try</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    socket<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>SocketShutdown<span class="token punctuation">.</span>Both<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">//Do Nothing</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>socket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>socket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="三-自定义dll的库文件引用"><a class="anchor" href="#三-自定义dll的库文件引用">#</a> 三、自定义 DLL 的库文件引用</h2><p><font color="blue">已解决</font></p><p>DLL 框架版本设置为 4.0 以上 (我是 4.5)</p><p>并重新分散引用 Unity 内部 DLL，路径位于对应 Unity 安装目录</p><p><a href="">Unity 2021.3.0f1\Editor\Data\Managed\UnityEngine</a></p><p>注：重新引用后注意修改 DLL 复制本地 为 false</p><h2 id="四-打-assetbundle-包出现资源反复import问题"><a class="anchor" href="#四-打-assetbundle-包出现资源反复import问题">#</a> 四、打 Assetbundle 包出现资源反复 Import 问题</h2><p>表现为初始化环境时，还没轮到正式打 Assetbundle，每个 prefab 皆出现 Import 提示</p><p>经过调试，发现新版 Unity 在每次打包之前重设标签时，都会导致重新导入一次资源，增加大量额外时间消耗。</p><p>例如：</p><p><img data-src="/blogimages/2022/2022-07-20/m_84ff6d5065eaba746ae2036b355a1e39_r.png" alt=""></p><p><font color="blue">已解决</font>，重设标签时，判断旧标签是否与新标签一致。</p><p>代码位于 AssetBundleTool AddLabel</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddLabel</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> label<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">//ClearLabel(obj);</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">UnityEngine<span class="token punctuation">.</span>Object</span> _object <span class="token operator">=</span> obj<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> _object<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> _labelList <span class="token operator">=</span> AssetDatabase<span class="token punctuation">.</span><span class="token function">GetLabels</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// 对象目前已有标签与设置标签不一致，或者对象拥有多个标签 (不合法)，则重设标签</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_labelList<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span> <span class="token operator">||</span> _labelList<span class="token punctuation">.</span>Count <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token function">ClearLabel</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            AssetDatabase<span class="token punctuation">.</span><span class="token function">SetLabels</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> label <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 如果这个物体本来就有指定的 label，就不需要重复处理了</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">//AssetDatabase.SetLabels(obj, _labelList.ToArray());</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>注：方法开口有调用 ClearLabel，可知一个对象只会存在一个标签，因此此处直接判断设置标签是否相等即可。</p><h2 id="五-打-assetbundle-包崩溃"><a class="anchor" href="#五-打-assetbundle-包崩溃">#</a> 五、打 Assetbundle 包崩溃</h2><p>查询日志得出为栈溢出：</p><pre><code>Couldn't extract exception string from exception of type StackOverflowException (another exception of class 'StackOverflowException' was thrown while processing the stack trace)

StackOverflowException: The requested operation caused a stack overflow.
  at (wrapper managed-to-native) System.String.FastAllocateString(int)
  at System.String.CreateStringFromEncoding (System.Byte* bytes, System.Int32 byteLength, System.Text.Encoding encoding) [0x00013] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 
  at System.Text.Encoding.GetString (System.Byte* bytes, System.Int32 byteCount) [0x00033] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 
  at System.Text.Encoding.GetString (System.ReadOnlySpan`1[T] bytes) [0x00013] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 
  at System.String.Ctor (System.SByte* value, System.Int32 startIndex, System.Int32 length, System.Text.Encoding enc) [0x0006d] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 
  at System.String.CreateString (System.SByte* value, System.Int32 startIndex, System.Int32 length, System.Text.Encoding enc) [0x00000] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 
  at (wrapper managed-to-managed) System.String..ctor(sbyte*,int,int,System.Text.Encoding)
  at UnityEngine.StackTraceUtility.ExtractStackTrace () [0x0002c] in &lt;1332c534a8a44623b2e5cc943a0b790e&gt;:0 
  at (wrapper managed-to-native) UnityEngine.DebugLogHandler.Internal_Log(UnityEngine.LogType,UnityEngine.LogOption,string,UnityEngine.Object)
  at UnityEngine.DebugLogHandler.LogFormat (UnityEngine.LogType logType, UnityEngine.Object context, System.String format, System.Object[] args) [0x0000b] in &lt;1332c534a8a44623b2e5cc943a0b790e&gt;:0 
  at UnityEngine.Logger.Log (UnityEngine.LogType logType, System.Object message) [0x00027] in &lt;1332c534a8a44623b2e5cc943a0b790e&gt;:0 
  at UnityEngine.Debug.Log (System.Object message) [0x00006] in &lt;1332c534a8a44623b2e5cc943a0b790e&gt;:0 
  at EditorAssetData.caculateTop () [0x00123] in D:\[Works]\sanguo_release\Unity\Assets\Scripts\Editor\AssetBundleTool\EditorAssetData.cs:184 
  at EditorAssetData.caculateTop () [0x0013a] in D:\[Works]\sanguo_release\Unity\Assets\Scripts\Editor\AssetBundleTool\EditorAssetData.cs:185 
  at EditorAssetData.caculateTop () [0x0013a] in D:\[Works]\sanguo_release\Unity\Assets\Scripts\Editor\AssetBundleTool\EditorAssetData.cs:185 
//余下省略========================================================
//余下省略========================================================
//余下省略========================================================
</code></pre><p>查询代码可知为递归获取上级引用问题。</p><p>经过调试可发现出现问题者，皆为名称与本身不一致的对象。</p><p>如图所示：</p><p><img data-src="/blogimages/2022/2022-07-20/m_139eb538f8271f47380e2d84617d883e_r.png" alt=""></p><p>出现问题的原因，多为美术 (特效)，原因想来很简单，美术直接单纯复制对象，未做正确操作。</p><p>由此可以得出结论，老版本 Unity 可能直接有一套兼容机制处理，新版 Unity 直接崩掉了。</p><p><font color="blue">已解决</font>，通过检测递归层数，人为限制，数量超出上限则打印错误信息，以便修复：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">int</span></span> _stackOverflowCheck <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">/// 一直向上递归，直到上级资源的上级资源数为 0 或上级资源为 BuildSingle</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>EditorAssetData<span class="token punctuation">></span></span> <span class="token function">caculateTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>        _stackOverflowCheck<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>_stackOverflowCheck <span class="token operator">></span> <span class="token number">50</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            Debug<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>LoadPath<span class="token operator">+</span> <span class="token string">" 超出递归限制上限，可能已经出现了问题！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">return</span> TopUpDependenceList<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>效果：</p><p><img data-src="/blogimages/2022/2022-07-20/m_bf2570478c346c0d6c1a2d47ee5f736b_r.png" alt=""></p><h2 id="六-报-load-il2cpp-失败"><a class="anchor" href="#六-报-load-il2cpp-失败">#</a> 六、报 load IL2CPP 失败</h2><p><img data-src="/blogimages/2022/2022-07-20/m_8762aae7da2cb29ab3583dabea704121_r.png" alt=""></p><p>通过 ADB 拉取的日志查看，一堆 Could not load symbol XXX 的错误</p><p><img data-src="/blogimages/2022/2022-07-20/m_e8ed695b5fa9785369ba71cb85935c29_r.png" alt=""></p><p>经过对 Unity 导出资源的目录的对比，发现新版资源路径都已经不一样了，多了为两个目录 『Il2CppOutputProject』、『jniStaticLibs』, 且 jniLibs 目录中少了 <span class="exturl" data-url="aHR0cDovL2xpYmlsMmNwcC5zbw==">libil2cpp.so</span>，</p><p><img data-src="/blogimages/2022/2022-07-20/m_96b794a490972af66945b171a97c4079_r.png" alt=""><br><img data-src="/blogimages/2022/2022-07-20/m_549ebbffb5d4210739a18c17ccf60f91_r.png" alt=""></p><p>经过查询信息表示，新版 Unity 导出的 AndroidStudio 工程，不再编译 <span class="exturl" data-url="aHR0cDovL2xpYmlsMmNwcC5zbw==">libil2cpp.so</span> ，而是直接提供源码，得自己处理编译的功能。</p><p>打开导出的资源 unityLibrary 目录下的 build.gradle，其中就有编译的代码：</p><p>// 省略</p><p>将其复制到我们的 SDK 下 build.gradle 中对应位置，并依照我们项目作出部分修改：</p><pre><code>android &#123;
	//已有代码
	//省略
	//省略

    aaptOptions &#123;
        noCompress = ['.unity3d', '.ress', '.resource', '.obb', '.bundle', '.unityexp','.assetbundle']
    &#125;

    packagingOptions &#123;
        doNotStrip '*/armeabi-v7a/*.so'
        doNotStrip '*/arm64-v8a/*.so'
    &#125;

    task BuildIl2CppTask &#123;
        doLast &#123;
            BuildIl2Cpp(project(':UnitySdk').projectDir.toString().replaceAll('\\\\', '/'), 'Release', 'armv7', 'armeabi-v7a', [  ] as String[]);
            BuildIl2Cpp(project(':UnitySdk').projectDir.toString().replaceAll('\\\\', '/'), 'Release', 'arm64', 'arm64-v8a', [  ] as String[]);
        &#125;
    &#125;
    afterEvaluate &#123;
        if (project(':UnitySdk').tasks.findByName('mergeDebugJniLibFolders'))
            project(':UnitySdk').mergeDebugJniLibFolders.dependsOn BuildIl2CppTask
        if (project(':UnitySdk').tasks.findByName('mergeReleaseJniLibFolders'))
            project(':UnitySdk').mergeReleaseJniLibFolders.dependsOn BuildIl2CppTask
    &#125;
    sourceSets &#123;
        main &#123;
            jni.srcDirs = [&quot;src/main/Il2CppOutputProject&quot;]
        &#125;
    &#125;
&#125;

def getSdkDir() &#123;
    Properties local = new Properties()
    local.load(new FileInputStream(&quot;$&#123;rootDir&#125;/local.properties&quot;))
    return local.getProperty('sdk.dir')
&#125;

def BuildIl2Cpp(String workingDir, String configuration, String architecture, String abi, String[] staticLibraries) &#123;
    def commandLineArgs = []
    commandLineArgs.add(&quot;--compile-cpp&quot;)
    commandLineArgs.add(&quot;--platform=Android&quot;)
    commandLineArgs.add(&quot;--architecture=&quot; + architecture)
    commandLineArgs.add(&quot;--outputpath=&quot; + workingDir + &quot;/src/main/jniLibs/&quot; + abi + &quot;/libil2cpp.so&quot;)
    commandLineArgs.add(&quot;--libil2cpp-static&quot;)
    commandLineArgs.add(&quot;--baselib-directory=&quot; + workingDir + &quot;/src/main/jniStaticLibs/&quot; + abi)
    commandLineArgs.add(&quot;--incremental-g-c-time-slice=3&quot;)
    commandLineArgs.add(&quot;--configuration=&quot; + configuration)
    commandLineArgs.add(&quot;--dotnetprofile=unityaot-linux&quot;)
    commandLineArgs.add(&quot;--profiler-report&quot;)
    commandLineArgs.add(&quot;--profiler-output-file=&quot; + workingDir + &quot;/build/il2cpp_&quot;+ abi + &quot;_&quot; + configuration + &quot;/il2cpp_conv.traceevents&quot;)
    commandLineArgs.add(&quot;--print-command-line&quot;)
    commandLineArgs.add(&quot;--generatedcppdir=&quot; + workingDir + &quot;/src/main/Il2CppOutputProject/Source/il2cppOutput&quot;)
    commandLineArgs.add(&quot;--cachedirectory=&quot; + workingDir + &quot;/build/il2cpp_&quot;+ abi + &quot;_&quot; + configuration + &quot;/il2cpp_cache&quot;)
    commandLineArgs.add(&quot;--tool-chain-path=&quot; + android.ndkDirectory)
    staticLibraries.eachWithIndex &#123;fileName, i-&gt;
        commandLineArgs.add(&quot;--additional-libraries=&quot; + workingDir + &quot;/src/main/jniStaticLibs/&quot; + abi + &quot;/&quot; + fileName)
    &#125;
    def executableExtension = &quot;&quot;
    if (org.gradle.internal.os.OperatingSystem.current().isWindows())
        executableExtension = &quot;.exe&quot;
    exec &#123;
        executable workingDir + &quot;/src/main/Il2CppOutputProject/IL2CPP/build/deploy/il2cpp&quot; + executableExtension
        args commandLineArgs
        environment &quot;ANDROID_SDK_ROOT&quot;, getSdkDir()
    &#125;
    delete workingDir + &quot;/src/main/jniLibs/&quot; + abi + &quot;/libil2cpp.sym.so&quot;
    ant.move(file: workingDir + &quot;/src/main/jniLibs/&quot; + abi + &quot;/libil2cpp.dbg.so&quot;, tofile: workingDir + &quot;/symbols/&quot; + abi + &quot;/libil2cpp.so&quot;)
&#125;
</code></pre><p>重新执行 AS 打包操作 —— 发现 jniLibs 根本没有生成对应的 <span class="exturl" data-url="aHR0cDovL2xpYmlsMmNwcC5zbw==">libil2cpp.so</span> 文件，导致最终出来的包还是有问题。</p><p>经过与 SDK 同学一块检查，发现我这边是出包的时候根本没执行 BuildIl2CppTask 代码：</p><p><img data-src="/blogimages/2022/2022-07-20/m_14c2730fb3ca0de83e909f8f7ae89491_r.png" alt=""></p><p>也就是说，就算如果增加了上述代码，要是按照正常流程打包，BuildIl2CppTask 会不执行，后边经过研究，只能手动执行 BuildIl2CppTask，手动执行输出也是正常的 (经过与 SDK 同学讨论，暂时也没发现为何没有自动执行的原因)。</p><p><img data-src="/blogimages/2022/2022-07-20/m_569e2fc7995ead8fe321bcc78db6033f_r.png" alt=""></p><p>这一步尝试成功后，就出了新包测试，确认无误后 —— 如此第一个能跑的包终于出来了！</p><h3 id="无法正常调用-buildil2cpp-编译-libil2cppso"><a class="anchor" href="#无法正常调用-buildil2cpp-编译-libil2cppso">#</a> 无法正常调用 BuildIl2Cpp 编译 <span class="exturl" data-url="aHR0cDovL2xpYmlsMmNwcC5zbw==">libil2cpp.so</span></h3><p>上文提到了直接出包，AS 根本没有执行附加的 BuildIl2CppTask 这条任务</p><p>这一步操作肯定不可能手动执行的，而且有时候涉及到旧资源出包，就算能够成功执行，反复编译也是费时间的麻烦事</p><p>于是向 SDK 同学要了命令『./gradlew BuildIl2CppTask』，修改了打包工具，直接在向 AS 复制资源之前，执行一次 il2cpp 的检查及编译的操作，并将生成的 <span class="exturl" data-url="aHR0cDovL2xpYmlsMmNwcC5zbw==">libil2cpp.so</span> 复制回来作资源缓存：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//===== 编译 il2cpp======</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> packil2CppSources <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>packResRootPath<span class="token punctuation">,</span> <span class="token string">"Il2CppOutputProject"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> packjniStaticLibsPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>packResRootPath<span class="token punctuation">,</span> <span class="token string">"jniStaticLibs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> sdkil2CppSources <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>sdkMainPath<span class="token punctuation">,</span> <span class="token string">"Il2CppOutputProject"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> sdkjniStaticLibsPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>sdkMainPath<span class="token punctuation">,</span> <span class="token string">"jniStaticLibs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//libil2cpp.so 文件</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> packIl2cppv8Files <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>packJniPath<span class="token punctuation">,</span> <span class="token string">"arm64-v8a/libil2cpp.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> packIl2cppv7Files <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>packJniPath<span class="token punctuation">,</span> <span class="token string">"armeabi-v7a/libil2cpp.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> sdkIl2cppv8Files <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>sdkJniPath<span class="token punctuation">,</span> <span class="token string">"arm64-v8a/libil2cpp.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> sdkIl2cppv7Files <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>sdkJniPath<span class="token punctuation">,</span> <span class="token string">"armeabi-v7a/libil2cpp.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>sdkIl2cppv8Files<span class="token punctuation">)</span><span class="token punctuation">)</span> File<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>sdkIl2cppv8Files<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>sdkIl2cppv7Files<span class="token punctuation">)</span><span class="token punctuation">)</span> File<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>sdkIl2cppv7Files<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 不存在，编译</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>packIl2cppv8Files<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>packIl2cppv7Files<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 清理可能存在的旧文件</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>sdkil2CppSources<span class="token punctuation">)</span><span class="token punctuation">)</span> Directory<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>sdkil2CppSources<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>sdkjniStaticLibsPath<span class="token punctuation">)</span><span class="token punctuation">)</span> Directory<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>sdkjniStaticLibsPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 复制 il2cpp 源码过去</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    FileCompare<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>packil2CppSources<span class="token punctuation">,</span> sdkil2CppSources<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    FileCompare<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>packjniStaticLibsPath<span class="token punctuation">,</span> sdkjniStaticLibsPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 正式编译</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token class-name"><span class="token keyword">string</span></span> rootSdkDir <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">GetDirectoryName</span><span class="token punctuation">(</span>Info<span class="token punctuation">.</span>AndroidSDKPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 刷新</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">DoCmd</span><span class="token punctuation">(</span>rootSdkDir<span class="token punctuation">,</span> <span class="token string">"gradlew"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 编译</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">DoCmd</span><span class="token punctuation">(</span>rootSdkDir<span class="token punctuation">,</span> <span class="token string">"gradlew"</span><span class="token punctuation">,</span> <span class="token string">"BuildIl2CppTask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 复制回来，避免第二次复用时打包重复编译</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>sdkIl2cppv8Files<span class="token punctuation">)</span><span class="token punctuation">)</span> FileCompare<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>sdkIl2cppv8Files<span class="token punctuation">,</span> packIl2cppv8Files<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>sdkIl2cppv7Files<span class="token punctuation">)</span><span class="token punctuation">)</span> FileCompare<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>sdkIl2cppv7Files<span class="token punctuation">,</span> packIl2cppv7Files<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">//================</span></pre></td></tr></table></figure><p>经测试新流程可以跑通。</p><p>注：此处调用的 AS 命令其实也是调用外部进程编译，所以不走 AS ，直接新开一个控制台命令也是可以的，这样还可以省下复制源码至 AS 的消耗，后边可以考虑优化。</p><h2 id="七-安卓加载-streamingasset-目录资源失败"><a class="anchor" href="#七-安卓加载-streamingasset-目录资源失败">#</a> 七、安卓加载 StreamingAsset 目录资源失败</h2><p><img data-src="/blogimages/2022/2022-07-20/m_8e73d862fa40a1c3bee9af2218e13568_r.png" alt=""></p><p>查询官方文档看到如下说明：</p><blockquote><p>Unity 会将放置在 Unity 项目中名为 StreamingAssets__（区分大小写）的文件夹中的所有文件逐字复制到目标计算机上的特定文件夹。要获取此文件夹，请使用 Application.streamingAssetsPath 属性。在任何情况下，最好使用 Application.streamingAssetsPath 来获取 StreamingAssets__ 文件夹的位置，因为它总是指向运行应用程序的平台上的正确位置。</p></blockquote><blockquote><p>Application.streamingAssetsPath 返回的位置因平台而异：</p></blockquote><ul><li>大多数平台（Unity Editor、Windows、Linux 播放器、PS4、Xbox One、Switch）使用 Application.dataPath + &quot;/StreamingAssets&quot;。</li><li>macOS 播放器使用 Application.dataPath + &quot;/Resources/Data/StreamingAssets&quot;。</li><li>iOS 使用 Application.dataPath + &quot;/Raw&quot;。</li><li>Android 使用经过压缩的 APK/JAR 文件中的文件：&quot;jar:file://&quot; + Application.dataPath + &quot;!/assets&quot;。</li></ul><p>其中安卓的路径，与日志输出并不一致，怀疑是否此处引起了差异，于是查询我们项目内相关代码，发现对获取 StreamingAssets 有如下组合：</p><ul><li>FResourceCommon GetStreamingAssetsPath 方法</li><li>LauncherLoading GetStreamingAssetsPath 方法</li></ul><p>原初始化 streamingAssetsPath 路径的代码，判断为安卓没有直接取系统 Application.streamingAssetsPath，而且自己组合的路径，新版 Unity 可能不再对此作兼容性判断，导致无法再使用。</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>Application<span class="token punctuation">.</span>platform <span class="token operator">==</span> RuntimePlatform<span class="token punctuation">.</span>Android<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    STREAMING_ASSET_PATH <span class="token operator">=</span> Application<span class="token punctuation">.</span>dataPath <span class="token operator">+</span> <span class="token string">"!assets"</span><span class="token punctuation">;</span>   <span class="token comment">// 安卓平台</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    STREAMING_ASSET_PATH <span class="token operator">=</span> Application<span class="token punctuation">.</span>streamingAssetsPath<span class="token punctuation">;</span>  <span class="token comment">// 其他平台</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>将其修改为直接取 Application.streamingAssetsPath 后，加载正常。</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>STREAMING_ASSET_PATH <span class="token operator">=</span> Application<span class="token punctuation">.</span>streamingAssetsPath<span class="token punctuation">;</span>  <span class="token comment">// 新版本所有平台均使用 streamingAssetsPath</span></pre></td></tr></table></figure><p><img data-src="/blogimages/2022/2022-07-20/m_61eb0f83a4730a6fbe37afb9aedcf0cd_r.png" alt=""></p><h2 id="八-无法调试问题"><a class="anchor" href="#八-无法调试问题">#</a> 八、无法调试问题</h2><p>将 DLL 设置中，高级生成设置 -&gt; 调试信息 设置为可移植，并删除项目中 DLL 已有的 MDB 文件，重新编译。</p><p><img data-src="/blogimages/2022/2022-07-20/m_1796df03e51bcdc557248e52a4afd5fe_r.png" alt=""></p><h2 id="九-google-包黑屏问题"><a class="anchor" href="#九-google-包黑屏问题">#</a> 九、Google 包黑屏问题</h2><p>表现为闪屏后黑屏，且有 Debug 且存在部分 Unity 输出</p><p><img data-src="/blogimages/2022/2022-07-20/m_7691ecd1cd62499ab0bd4d3f7d6aaa78_r.png" alt=""></p><p>增加打印并检查日志：</p><p><img data-src="/blogimages/2022/2022-07-20/m_6da6afa2a09a767f8f68adf0363529e2_r.png" alt=""></p><p>从日志中及对应代码推测，可以推测主要有两个问题：</p><ul><li><h3 id="打-google-包-useobb选项未生效"><a class="anchor" href="#打-google-包-useobb选项未生效">#</a> 打 Google 包 UseOBB 选项未生效</h3></li></ul><p>其中涉及代码如下：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"Launcher Awake + "</span><span class="token operator">+</span> UseOBB<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token preprocessor property">#<span class="token directive keyword">if</span> UNITY_ANDROID &amp;&amp; !</span><span class="token return-type class-name">UNITY_EDITOR</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        SDKManager<span class="token punctuation">.</span>Inst<span class="token punctuation">.</span><span class="token function">SendMsg</span><span class="token punctuation">(</span>SDKManager<span class="token punctuation">.</span>SEND_HAVE_CUTOUT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>UseOBB<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"Launcher Awake + UseOBB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token function">InitGoogleOBBResources</span><span class="token punctuation">(</span>ShowUI<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#125;</span>                </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token preprocessor property">#<span class="token directive keyword">elif</span> UNITY_IPHONE &amp;&amp; !</span><span class="token return-type class-name">UNITY_EDITOR</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        SDKManager<span class="token punctuation">.</span>Inst<span class="token punctuation">.</span><span class="token function">AddEvent</span><span class="token punctuation">(</span>eSDKMngEvent<span class="token punctuation">.</span>GetDynamicUpdateStateSuccess<span class="token punctuation">,</span> OnGetDynamicUpdateStateSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        SDKManager<span class="token punctuation">.</span>Inst<span class="token punctuation">.</span><span class="token function">SendMsg</span><span class="token punctuation">(</span>SDKManager<span class="token punctuation">.</span>SEND_GET_DYNAMIC_UPDATE_NO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token preprocessor property">#<span class="token directive keyword">endif</span></span></pre></td></tr></table></figure><p>在场景的 Launcher 上，就有 UseOBB 这个选项，用于控制我们游戏内是否能够正确识别为 Google 包</p><p><img data-src="/blogimages/2022/2022-07-20/m_c7e9f51fd6518929d6a9a8174df05d06_r.png" alt=""></p><p>增加打印后，此处开始为 false（<font color="red">注：上述日志截图为解决后的表现，因此显示为 true</font>）</p><p>这个 UseOBB 选项，之前是在出 Google 包时，通过代码直接设置的。</p><p>但是经过个人反复测试，发现新版 Unity 在代码设置场景物体属性后，该项不会正常生效！</p><p>最简单的重现方式为：代码修改场景物体属性后，重启 Unity，物体属性被还原 (即使修改后调用保存场景及资源的接口，依然无效)。</p><p>解决方式为：将出包时自动设置 UseOBB 属性处修改为一个判断，若出包类型为 Google OBB 模式，且 UseOBB 未勾选，弹出提示需要手动勾选保存。</p><ul><li><h3 id="obb-无法被主应用正确识别"><a class="anchor" href="#obb-无法被主应用正确识别">#</a> OBB 无法被主应用正确识别</h3></li></ul><p>还是根据上述日志分析，看着像是没有正确识别 OBB，导致资源未能成功加载而报空。</p><p>在之前我们 Unity2017 出包的时候，导出的 AS 项目资源中，其中 AndroidManifest.xml 文件存在一个 build-id 的字段。</p><p>不过新版 Unity 导出资源中，AndroidManifest.xml 已经没有了，所以开始是直接打的包。</p><p>2021 升级文档： <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UpgradeGuide2021LTS.html#Android">Upgrading to Unity 2021 LTS<br></a></p><p>其中有这么一个描述：</p><blockquote><p>Changed how Unity checks to see if an obb is compatible with an apk<br>. Both the apk and obb now have unity_obb_guid file inside them and if the contents match between them, Unity treats them as being compatible.</p></blockquote><p>意思是现在 Unity 通过 APK 及 OBB 包中的一个名为 unity_obb_guid 文件来确认 APK 与 OBB 是否一致。</p><p>也就是说，从 Unity2021 开始，OBB 识别机制不走 build-id ，而是走另外文件对比了。</p><p>解包 OBB 后，果然发现了这个东西：</p><p><img data-src="/blogimages/2022/2022-07-20/m_f2c167f2345b8c1745c81e089d5570bd_r.png" alt=""></p><p>同时检查打包出来的 APK，发现缺失，通过搜索 Unity 导出资源目录，可发现 APK 中该文件位于 unityLibrary\src\main\assets\unity_obb_guid</p><p>在之前我们的打包工具中，对 assets 目录的内容只复制其子目录，导致缺了文件，修改打包工具代码：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>assetPaths <span class="token operator">=</span> Directory<span class="token punctuation">.</span><span class="token function">GetDirectories</span><span class="token punctuation">(</span>packAssetsPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> assetPaths<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    FileCompare<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>assetPaths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sdkAssetsPath <span class="token operator">+</span> assetPaths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>packAssetsPath<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 复制 unity_obb_guid 文件</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> packObbGuidFile <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>packAssetsPath<span class="token punctuation">,</span> <span class="token string">"unity_obb_guid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name"><span class="token keyword">string</span></span> sdkObbGuidFile <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>sdkAssetsPath<span class="token punctuation">,</span> <span class="token string">"unity_obb_guid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>FileCompare<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>packObbGuidFile<span class="token punctuation">,</span> sdkObbGuidFile<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这时候果然就可以了：</p><p><img data-src="/blogimages/2022/2022-07-20/m_410dbb6736ddf63920ea3aa14242adb1_r.png" alt=""></p><h2 id="十-进出战斗崩溃"><a class="anchor" href="#十-进出战斗崩溃">#</a> 十、进出战斗崩溃</h2><p>最初表现为打开引导时，概率发生于进入战斗时崩溃。</p><p>第一次查询的崩溃日志如下：</p><pre><code>Received signal SIGSEGV
Obtained 50 stack frames
0x00007ff7b5c0aceb (Unity) GameObject::SendMessageAny
0x00007ff7b607e835 (Unity) Transform::BroadcastMessageAny
0x00007ff7b607e899 (Unity) Transform::BroadcastMessageAny
0x00007ff7b607e899 (Unity) Transform::BroadcastMessageAny
0x00007ff7b688d7f6 (Unity) UI::Canvas::WillDestroyComponent
0x00007ff7b5c0d3a1 (Unity) GameObject::WillDestroyGameObject
0x00007ff7b5f18901 (Unity) PreDestroyRecursive
0x00007ff7b5f16927 (Unity) DestroyObjectHighLevel_Internal
0x00007ff7b5f16564 (Unity) DestroyObjectHighLevel
0x00007ff7b626638f (Unity) Scripting::DestroyObjectFromScriptingImmediate
0x00007ff7b54dd663 (Unity) Object_CUSTOM_DestroyImmediate
0x0000018b373dcb35 (Mono JIT Code) (wrapper managed-to-native) UnityEngine.Object:DestroyImmediate (UnityEngine.Object,bool)
0x0000018b373dca53 (Mono JIT Code) UnityEngine.Object:DestroyImmediate (UnityEngine.Object)
0x0000018c1010bae3 (Mono JIT Code) YoukiaUnity.Resource.PoolManager:CleanPool (string)
0x0000018c1219f07b (Mono JIT Code) [BattleStage.cs:85] Demo.Stage.BattleStage:CleanPool () 
0x0000018c100fabab (Mono JIT Code) [BattleStage.cs:79] Demo.Stage.BattleStage:OnAsyncHandle () 
0x0000018c1219efbb (Mono JIT Code) [BattleStage.cs:116] Demo.Stage.BattleStage:&lt;OnSceneLoaded&gt;b__10_0 () 
0x0000018c1219ef76 (Mono JIT Code) [BattleManager.cs:1798] BattleManager:_onCreateFinish () 
0x0000018b3af83c05 (Mono JIT Code) YoukiaCore.AsyncCombiner:RefreshAsyncHandles ()
0x0000018b3af8d2c3 (Mono JIT Code) YoukiaCore.AsyncCombiner/AsyncHandle:Finish ()
0x0000018c1011fbdb (Mono JIT Code) [BattleManager.cs:2004] BattleManager/&lt;&gt;c__DisplayClass139_0:&lt;_onRoleAdd&gt;b__0 () 
0x0000018c1219dd26 (Mono JIT Code) [ModelChiefView.cs:147] Demo.ModelChiefView/&lt;&gt;c__DisplayClass10_0:&lt;Create&gt;b__2 () 
0x0000018c1219db21 (Mono JIT Code) [ModelChiefView.cs:193] Demo.ModelChiefView/&lt;&gt;c__DisplayClass13_0:&lt;AddMountSkillClip&gt;b__0 (object) 
0x0000018b3af41b1c (Mono JIT Code) FrameWork.FProcess:allDone ()
0x0000018b3af41573 (Mono JIT Code) FrameWork.FProcess:AssetLoaded (object[])
0x0000018b3af40fff (Mono JIT Code) FrameWork.FGameEvent:DispatchEvent (System.Enum,object[])
0x0000018b3af40e43 (Mono JIT Code) FrameWork.FEventManager:DispatchEvent (System.Enum,object[])
0x0000018b3af40d33 (Mono JIT Code) FrameWork.FProcess:ProcessComplete ()
0x0000018b3af3a9ab (Mono JIT Code) FrameWork.FProcess/&lt;_load&gt;d__18:MoveNext ()
0x0000018b3862cff0 (Mono JIT Code) UnityEngine.SetupCoroutine:InvokeMoveNext (System.Collections.IEnumerator,intptr)
0x0000018b3862d11f (Mono JIT Code) (wrapper runtime-invoke) &lt;Module&gt;:runtime_invoke_void_object_intptr (object,intptr,intptr,intptr)
0x00007ffdf5e6e4b4 (mono-2.0-bdwgc) [mini-runtime.c:3445] mono_jit_runtime_invoke 
0x00007ffdf5dae764 (mono-2.0-bdwgc) [object.c:3066] do_runtime_invoke 
0x00007ffdf5dae8fc (mono-2.0-bdwgc) [object.c:3113] mono_runtime_invoke 
0x00007ff7b626dac4 (Unity) scripting_method_invoke
0x00007ff7b6268644 (Unity) ScriptingInvocation::Invoke
0x00007ff7b621a1df (Unity) Coroutine::Run
0x00007ff7b6217c1c (Unity) Coroutine::ContinueCoroutine
0x00007ff7b5d35344 (Unity) DelayedCallManager::Update
0x00007ff7b5f45d29 (Unity) `InitPlayerLoopCallbacks'::`2'::UpdateScriptRunDelayedDynamicFrameRateRegistrator::Forward
0x00007ff7b5f2c89c (Unity) ExecutePlayerLoop
0x00007ff7b5f2c973 (Unity) ExecutePlayerLoop
0x00007ff7b5f325d9 (Unity) PlayerLoop
0x00007ff7b6e7993f (Unity) PlayerLoopController::UpdateScene
0x00007ff7b6e77bdf (Unity) Application::TickTimer
0x00007ff7b72c37aa (Unity) MainMessageLoop
0x00007ff7b72c805b (Unity) WinMain
0x00007ff7b864b42e (Unity) __scrt_common_main_seh
0x00007ffe3a797034 (KERNEL32) BaseThreadInitThunk
0x00007ffe3b5c2651 (ntdll) RtlUserThreadStart
</code></pre><p>对比代码发现，我们游戏在进入战斗时，会强制清理一次对象池，而清理方式则是直接调用 <code>GameObject.DestroyImmediate</code></p><p>GameObject.DestroyImmediate 和 GameObject.Destroy 一直是有区别的，记得很早以前官方都推荐正式环境用 Destroy 而非 DestroyImmediate。</p><p>为了确认看了下文档：</p><blockquote><p>立即销毁对象 /obj/。强烈建议您改用 Destroy。</p></blockquote><blockquote><p>该函数应只在编写 Editor 代码时使用，因为在编辑模式下， 永远不会调用延迟销毁。 在游戏代码中，您应该改用 Object.Destroy。Destroy 始终延迟进行 （但在同一帧内执行）。 使用该函数时要务必小心，因为它可以永久销毁资源！ 另请注意，切勿循环访问数组并销毁正在迭代的元素。这会导致严重的问题（这是一条通用的编程实践，而不仅仅是在 Unity 中）。</p></blockquote><p>说明 DestroyImmediate 肯定是有一定风险的，特别是 CleanPool 中的代码，还正好是一个循环调用的 DestroyImmediate。</p><p>于是怀疑是否这里的影响，尝试将其修改为 Destroy。</p><p>如此之后 ———— 还是崩溃了，日志变成如下：</p><pre><code>Asset Pipeline Refresh: Total: 0.027 seconds - Initiated by RefreshV2(AllowForceSynchronousImport)
Received signal SIGSEGV
Obtained 22 stack frames
0x00007ff7b5c0aceb (Unity) GameObject::SendMessageAny
0x00007ff7b607e835 (Unity) Transform::BroadcastMessageAny
0x00007ff7b607e899 (Unity) Transform::BroadcastMessageAny
0x00007ff7b607e899 (Unity) Transform::BroadcastMessageAny
0x00007ff7b688d7f6 (Unity) UI::Canvas::WillDestroyComponent
0x00007ff7b5c0d3a1 (Unity) GameObject::WillDestroyGameObject
0x00007ff7b5f18901 (Unity) PreDestroyRecursive
0x00007ff7b5f16927 (Unity) DestroyObjectHighLevel_Internal
0x00007ff7b5f16564 (Unity) DestroyObjectHighLevel
0x00007ff7b5d3345b (Unity) DelayedDestroyCallback
0x00007ff7b5d35344 (Unity) DelayedCallManager::Update
0x00007ff7b5f457b9 (Unity) `InitPlayerLoopCallbacks'::`2'::PostLateUpdateScriptRunDelayedDynamicFrameRateRegistrator::Forward
0x00007ff7b5f2c89c (Unity) ExecutePlayerLoop
0x00007ff7b5f2c973 (Unity) ExecutePlayerLoop
0x00007ff7b5f325d9 (Unity) PlayerLoop
0x00007ff7b6e7993f (Unity) PlayerLoopController::UpdateScene
0x00007ff7b6e77bdf (Unity) Application::TickTimer
0x00007ff7b72c37aa (Unity) MainMessageLoop
0x00007ff7b72c805b (Unity) WinMain
0x00007ff7b864b42e (Unity) __scrt_common_main_seh
0x00007ffe3a797034 (KERNEL32) BaseThreadInitThunk
0x00007ffe3b5c2651 (ntdll) RtlUserThreadStart
</code></pre><p>由于这次属于延时销毁，所以不再有实际调用销毁的堆栈打印，不过最终走到的崩溃位置还是一样: <code>GameObject::SendMessageAny</code></p><p>在此处增加对应销毁物体打印，只看到一个 TS_MainButtomView</p><pre><code>&lt;color=lightblue&gt;1660365391&lt;/color&gt; Debug:销毁：TS_MainButtomView 
</code></pre><p>造成崩溃对象可能就是这个 Prefab，在我们项目是一个 UI 组件。</p><p>并且后续经过尝试，若不销毁该对象，同样有可能崩溃，且会发生于退出战斗时也可能崩溃。</p><p>这时候基本上已经相当怀疑这个对象了，只是由于每次碰到的崩溃最终堆栈信息都还不尽相同，所以无法定性，常见有：</p><ul><li>销毁</li><li>创建</li><li>刷新精灵 Sprite<blockquote><p>tlsf_free<br>DynamicHeapAllocator::Deallocate</p></blockquote></li></ul><p>正准备试试官方文档介绍的 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnVuaXR5M2QuY29tL01hbnVhbC9XaW5kb3dzRGVidWdnaW5nLmh0bWw=">Debug 方式</span> 的时候，后续测试同学竟还找到了一个稳定复现之处，再经个人反复尝试和查询，最终得到如下指向比较清晰一点日志：</p><pre><code>Received signal SIGSEGV
Obtained 51 stack frames
0x00007ff7e8a5f2a4 (Unity) UI::CanvasManager::AddCanvas
0x00007ff7e8a73633 (Unity) UI::Canvas::AddToManager
0x00007ff7e8a73c65 (Unity) UI::Canvas::AwakeFromLoad
0x00007ff7e8512fe7 (Unity) AwakeFromLoadQueue::InvokeAwakeFromLoad
0x00007ff7e850e003 (Unity) AwakeFromLoadQueue::AwakeFromLoadAllQueues
0x00007ff7e7df417a (Unity) GameObject::ActivateAwakeRecursively
0x00007ff7e7dfb719 (Unity) GameObject::SetSelfActive
0x00007ff7e767fd9b (Unity) GameObject_CUSTOM_SetActive
0x00000126e405c104 (Mono JIT Code) (wrapper managed-to-native) UnityEngine.GameObject:SetActive (UnityEngine.GameObject,bool)
0x00000126f84444fb (Mono JIT Code) [MainButtomView.cs:1442] MainButtomView/&lt;&gt;c__DisplayClass115_0:&lt;OpenView&gt;b__0 (object) 
</code></pre><p>崩溃结果指向，界面的子节点挂载的 Canvas，该对象 (TS_MainButtomView) 属于主界面 Aorpage 的一个 子节点 Prefab，且自身挂载了 Canvas。</p><p>这里经过尝试，表明该组件并非是必须的。</p><p>于是移除之后就真的好了..</p><h2 id="十一-重打图集混乱"><a class="anchor" href="#十一-重打图集混乱">#</a> 十一、重打图集混乱</h2><p>例如，更改图集大小，最明显的一个错误表现如下：</p><p><img data-src="/blogimages/2022/2022-07-20/m_3dc46ec72951416efa3db5e39d72cf52_r.png" alt=""></p><p>如果现在点击提交，发现 meta 文件都未被修改：</p><p><img data-src="/blogimages/2022/2022-07-20/m_1a847eda1a12e0c8d768a4f928876577_r.png" alt=""></p><p>而且编辑器中也可以明显看出 Position 依然是旧的 —— 经过分析调试，在编辑器工具生成新的图集数据时，确实也是赋值了新的数据的：</p><p><img data-src="/blogimages/2022/2022-07-20/m_37d6afb2f1f694e23da5f116b33d1fb9_r.png" alt=""></p><p>于怀疑是不是 Unity 内部又出啥事了。</p><p>经过查询关键字 textureImporter.spritesheet，有找到一篇可能有所关联的博客 <a target="_blank" rel="noopener" href="https://blog.csdn.net/rcfalcon/article/details/49743715">unity 2D Sprite 网格 Slice 工具<br></a></p><p>这篇文章描述了 Unity 的 textureImporter.spritesheet 大约存在一个 BUG，当图集中图片未被修改，仅发生位置表动时，将导致其数据无法正常更新。虽然这篇博文已经早是 2015 年的东西了，不过本着尝试一下的感觉，没成想真是这个问题！</p><p>末尾给加上</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>textureImporter<span class="token punctuation">.</span>mipmapEnabled <span class="token operator">=</span> <span class="token operator">!</span>textureImporter<span class="token punctuation">.</span>mipmapEnabled<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>textureImporter<span class="token punctuation">.</span><span class="token function">SaveAndReimport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>textureImporter<span class="token punctuation">.</span>mipmapEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>textureImporter<span class="token punctuation">.</span><span class="token function">SaveAndReimport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>就正常了，关键是这个在之前 Unity2017 还能正常工作的。</p><h2 id="十二-正式包"><a class="anchor" href="#十二-正式包">#</a> 十二、正式包</h2><p>其它比较简单一点、或者一些功能上的的升级问题，这里就不作记录了，最终正式包如下：</p><p><img data-src="/blogimages/2022/2022-07-20/m_01c6a4b39b61c4c75075e6451fd2968e_r.png" alt=""></p><div class="tags"><a href="/tags/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/" rel="tag"><i class="ic i-tag"></i> 问题记录</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-12-22 11:29:48" itemprop="dateModified" datetime="2022-12-22T11:29:48+08:00">2022-12-22</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>CWHISME <i class="ic i-at"><em>@</em></i>WangJiaYing</li><li class="link"><strong>本文链接：</strong> <a href="https://cwhisme.github.io/2022/07/20/%E5%85%B3%E4%BA%8E%E6%B1%89%E5%AE%A4%E5%A4%8D%E5%85%B4%E5%8D%87%E7%BA%A7Unity2021%E7%9A%84%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/" title="关于汉室复兴升级 Unity2021 的问题记录">https://cwhisme.github.io/2022/07/20/关于汉室复兴升级Unity2021的问题记录/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/07/01/%E5%88%A9%E7%94%A8JIRA%E7%9A%84RichFilterStatistics%E7%BB%9F%E8%AE%A1BUG%E7%8E%87%E7%AD%89%E4%BF%A1%E6%81%AF/" itemprop="url" rel="prev" data-background-image="&#x2F;images&#x2F;coverimages&#x2F;mw690&#x2F;deef1a0cly8gy0wt2eo0lj21hc0u0qb4.webp" title="利用JIRA的RichFilterStatistics统计BUG率等信息"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 其它</span><h3>利用JIRA的RichFilterStatistics统计BUG率等信息</h3></a></div><div class="item right"><a href="/2022/07/21/%E5%A4%84%E7%90%86Unity2019%E7%9A%84UGUI%E9%A1%B6%E7%82%B9%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E5%90%8E%E7%9A%84%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E9%97%AE%E9%A2%98/" itemprop="url" rel="next" data-background-image="&#x2F;images&#x2F;coverimages&#x2F;mw690&#x2F;6833939bly1gicit4jrvuj20zk0m8785.webp" title="处理Unity2019的UGUI顶点数据更新后的图文混排问题"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 问题</span><h3>处理Unity2019的UGUI顶点数据更新后的图文混排问题</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-ugui"><span class="toc-number">1.</span> <span class="toc-text">一、UGUI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E9%93%BE%E6%8E%A5"><span class="toc-number">1.1.</span> <span class="toc-text">超链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92"><span class="toc-number">1.2.</span> <span class="toc-text">图文混排</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%96%E8%A1%8C%E6%8E%92%E7%89%88"><span class="toc-number">1.3.</span> <span class="toc-text">竖行排版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aortextincsprites-%E7%BC%BA%E5%B0%91%E6%9C%80%E5%90%8E%E4%B8%80%E4%BD%8D%E5%86%85%E5%AE%B9"><span class="toc-number">1.4.</span> <span class="toc-text">AorTextIncSprites 缺少最后一位内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%8C%E5%86%9B%E7%BA%BF%E7%BB%98%E5%88%B6"><span class="toc-number">1.5.</span> <span class="toc-text">行军线绘制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aoruistage-%E8%87%AA%E9%80%82%E5%BA%94%E5%AD%90%E8%8A%82%E7%82%B9%E9%95%BF%E5%AE%BD%E4%B8%BA-nan"><span class="toc-number">1.6.</span> <span class="toc-text">AorUIStage# 自适应子节点长宽为 NaN</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-socket-%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.</span> <span class="toc-text">二、Socket 连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E8%87%AA%E5%AE%9A%E4%B9%89dll%E7%9A%84%E5%BA%93%E6%96%87%E4%BB%B6%E5%BC%95%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">三、自定义 DLL 的库文件引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E6%89%93-assetbundle-%E5%8C%85%E5%87%BA%E7%8E%B0%E8%B5%84%E6%BA%90%E5%8F%8D%E5%A4%8Dimport%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">四、打 Assetbundle 包出现资源反复 Import 问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E6%89%93-assetbundle-%E5%8C%85%E5%B4%A9%E6%BA%83"><span class="toc-number">5.</span> <span class="toc-text">五、打 Assetbundle 包崩溃</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%8A%A5-load-il2cpp-%E5%A4%B1%E8%B4%A5"><span class="toc-number">6.</span> <span class="toc-text">六、报 load IL2CPP 失败</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E8%B0%83%E7%94%A8-buildil2cpp-%E7%BC%96%E8%AF%91-libil2cppso"><span class="toc-number">6.1.</span> <span class="toc-text">无法正常调用 BuildIl2Cpp 编译 libil2cpp.so</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E5%AE%89%E5%8D%93%E5%8A%A0%E8%BD%BD-streamingasset-%E7%9B%AE%E5%BD%95%E8%B5%84%E6%BA%90%E5%A4%B1%E8%B4%A5"><span class="toc-number">7.</span> <span class="toc-text">七、安卓加载 StreamingAsset 目录资源失败</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-%E6%97%A0%E6%B3%95%E8%B0%83%E8%AF%95%E9%97%AE%E9%A2%98"><span class="toc-number">8.</span> <span class="toc-text">八、无法调试问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-google-%E5%8C%85%E9%BB%91%E5%B1%8F%E9%97%AE%E9%A2%98"><span class="toc-number">9.</span> <span class="toc-text">九、Google 包黑屏问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93-google-%E5%8C%85-useobb%E9%80%89%E9%A1%B9%E6%9C%AA%E7%94%9F%E6%95%88"><span class="toc-number">9.1.</span> <span class="toc-text">打 Google 包 UseOBB 选项未生效</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#obb-%E6%97%A0%E6%B3%95%E8%A2%AB%E4%B8%BB%E5%BA%94%E7%94%A8%E6%AD%A3%E7%A1%AE%E8%AF%86%E5%88%AB"><span class="toc-number">9.2.</span> <span class="toc-text">OBB 无法被主应用正确识别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81-%E8%BF%9B%E5%87%BA%E6%88%98%E6%96%97%E5%B4%A9%E6%BA%83"><span class="toc-number">10.</span> <span class="toc-text">十、进出战斗崩溃</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80-%E9%87%8D%E6%89%93%E5%9B%BE%E9%9B%86%E6%B7%B7%E4%B9%B1"><span class="toc-number">11.</span> <span class="toc-text">十一、重打图集混乱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C-%E6%AD%A3%E5%BC%8F%E5%8C%85"><span class="toc-number">12.</span> <span class="toc-text">十二、正式包</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/10/25/%E4%B8%8A%E6%9E%B6%E6%A3%80%E6%B5%8B%E6%8F%90%E7%A4%BA%E6%9C%89Unity%E5%B9%BF%E5%91%8A%E6%9C%8D%E5%8A%A1/" rel="bookmark" title="上架检测提示有Unity广告服务">上架检测提示有Unity广告服务</a></li><li class="active"><a href="/2022/07/20/%E5%85%B3%E4%BA%8E%E6%B1%89%E5%AE%A4%E5%A4%8D%E5%85%B4%E5%8D%87%E7%BA%A7Unity2021%E7%9A%84%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/" rel="bookmark" title="关于汉室复兴升级Unity2021的问题记录">关于汉室复兴升级Unity2021的问题记录</a></li><li><a href="/2022/07/21/%E5%A4%84%E7%90%86Unity2019%E7%9A%84UGUI%E9%A1%B6%E7%82%B9%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E5%90%8E%E7%9A%84%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E9%97%AE%E9%A2%98/" rel="bookmark" title="处理Unity2019的UGUI顶点数据更新后的图文混排问题">处理Unity2019的UGUI顶点数据更新后的图文混排问题</a></li><li><a href="/2022/08/31/%E5%85%B3%E4%BA%8E%E4%BB%8EUnity2021%E9%99%8D%E7%BA%A7%E4%B8%BAUnity2018%E7%9A%84%E9%97%AE%E9%A2%98/" rel="bookmark" title="关于从Unity2021降级为Unity2018的问题">关于从Unity2021降级为Unity2018的问题</a></li><li><a href="/2022/09/28/%E8%A7%A3%E5%86%B3%E5%AE%88%E6%9C%9B%E9%A1%B9%E7%9B%AE%E5%88%98%E6%B5%B7%E5%B1%8F%E7%9C%9F%E6%9C%BA%E7%99%BD%E5%B1%8F%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/" rel="bookmark" title="解决守望项目刘海屏真机白屏问题记录">解决守望项目刘海屏真机白屏问题记录</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="CWHISME" data-src="/images/../img/avator"><p class="name" itemprop="name">CWHISME</p><div class="description" itemprop="description">✧⁺˚⁺ପ(๑･ω･)੭ु⁾⁾ 好好学习天天向上</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">87</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">19</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">26</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2N3aGlzbWU=" title="https:&#x2F;&#x2F;github.com&#x2F;cwhisme"><i class="ic i-github"></i></span> <span class="exturl item email" data-url="bWFpbHRvOmN3aGlzbWVAMTI2LmNvbQ==" title="mailto:cwhisme@126.com"><i class="ic i-envelope"></i></span> <a href="/atom.xml" title="&#x2F;atom.xml" class="item feedback"><i class="ic i-heart"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/bookmark/" rel="section"><i class="ic i-tag"></i>书签</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-magic"></i>链接</a><ul class="submenu"><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友達</a></li></ul></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/07/01/%E5%88%A9%E7%94%A8JIRA%E7%9A%84RichFilterStatistics%E7%BB%9F%E8%AE%A1BUG%E7%8E%87%E7%AD%89%E4%BF%A1%E6%81%AF/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/07/21/%E5%A4%84%E7%90%86Unity2019%E7%9A%84UGUI%E9%A1%B6%E7%82%B9%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E5%90%8E%E7%9A%84%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E9%97%AE%E9%A2%98/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E5%85%B6%E5%AE%83/" title="分类于 其它">其它</a></div><span><a href="/2016/07/03/2016-7-3/" title="2016.7.3">2016.7.3</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Unity3D/" title="分类于 Unity3D">Unity3D</a> <i class="ic i-angle-right"></i> <a href="/categories/Unity3D/%E5%85%B6%E5%AE%83/" title="分类于 其它">其它</a></div><span><a href="/2016/04/19/%E5%9C%A8Unity%E4%B8%AD%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BAMesh/" title="在Unity中动态创建Mesh">在Unity中动态创建Mesh</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%80%BB%E7%BB%93/" title="分类于 总结">总结</a></div><span><a href="/2016/04/18/2015%E5%B9%B4%E6%80%BB%E7%BB%93/" title="2015年总结">2015年总结</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment count_3"></ul></div></div><div class="status"><div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">CWHISME @ Jiaying's Note</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">414k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">6:17</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/07/20/关于汉室复兴升级Unity2021的问题记录/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/js/DateTimeAfeterCalc.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script data-pjax>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?62952472c154f9131a14a4ab57bfefec";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>