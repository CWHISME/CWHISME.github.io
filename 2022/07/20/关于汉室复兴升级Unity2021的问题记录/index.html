<!DOCTYPE html><meta name="viewport" content="height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cwhisme"><meta name="author" content="CWHISME"><meta property="og:title" content="关于汉室复兴升级Unity2021的问题记录"><meta property="og:description" content="cwhisme"><meta property="og:site_name" content="WangJiaYing"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>关于汉室复兴升级Unity2021的问题记录 - WangJiaYing</title><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/DateTimeAfeterCalc.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/particles-bg.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/script.js"></script><link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/css/style.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="WangJiaYing" type="application/atom+xml">
</head><body><canvas id="hackEffectCanvas" style="position:fixed;z-index:-1;pointer-events:none"></canvas><canvas class="fireworks" style="position:fixed;z-index:10;pointer-events:none"></canvas><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="WangJiaYing"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/logo.svg" class="dib h3" alt="WangJiaYing"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags" title="Tags">Tags </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/categories" title="Categories">Categories </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/bookmark" title="Bookmark">Bookmark </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="About">About</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">关于汉室复兴升级Unity2021的问题记录</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2022-07-20&nbsp&nbsp <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="dateTimeAfter">2022-07-20</span></p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-snowflake-o"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><div class="tags-container-vertical"><div class="tags-sub-container"><a class="fw3 ph1 dib" href="/tags/问题解决记录/">#问题解决记录</a></div></div><h2 id="一、UGUI"><a href="#一、UGUI" class="headerlink" title="一、UGUI"></a>一、UGUI</h2><ol><li><h3 id="超链接"><a href="#超链接" class="headerlink" title="超链接"></a>超链接</h3><p><font color="blue">已解决</font>，超链接点击返回剔除富文本信息</p><p>详细可见另一篇文档：<a href="">处理Unity2019的UGUI顶点数据更新后的图文混排问题</a></p></li><li><h3 id="图文混排"><a href="#图文混排" class="headerlink" title="图文混排"></a>图文混排</h3><p><font color="blue">已解决</font>，计算表情绘制下标时剔除表情标签、剔除富文本信息</p><p>详细可见另一篇文档：<a href="">处理Unity2019的UGUI顶点数据更新后的图文混排问题</a></p></li><li><h3 id="竖行排版"><a href="#竖行排版" class="headerlink" title="竖行排版"></a>竖行排版</h3><p>由于Unity本身提供的 UILineInfo 包含了换行符信息、而顶点数据并不包括导致。</p><p><font color="blue">已解决</font>，自行通过『\n』 分割文本，并剔除富文本信息再作计算。</p><p>详细可见另一篇文档：<a href="">处理Unity2019的UGUI顶点数据更新后的图文混排问题</a></p></li><li><h3 id="AorTextIncSprites-缺少最后一位内容"><a href="#AorTextIncSprites-缺少最后一位内容" class="headerlink" title="AorTextIncSprites 缺少最后一位内容"></a>AorTextIncSprites 缺少最后一位内容</h3><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_439c7a477ded75b326cac421a41d65fd_r.png"></p><p>查看代码，并经过调试，最后发现是因为绘制时手动减掉了最后4位顶点，关键代码如下：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Last 4 verts are always a new line...</span></span><br><span class="line"><span class="built_in">int</span> vertCount = verts.Count<span class="number">-4</span>;</span><br></pre></td></tr></table></figure><p>这里根据注释，就可以明白了，最后一位以前是当换行符去掉了，新版顶点并无这些信息，不再减去4个顶点即可。</p></li><li><h3 id="行军线绘制"><a href="#行军线绘制" class="headerlink" title="行军线绘制"></a>行军线绘制</h3><p>使用 UGUI+自定义Shader实现</p><p>由于自定义 UGUI 顶点绘制，新版 Unity无法正常工作，通过禁用 raycastTarget 可以避免报错，走上正常逻辑，但不可见。</p><ul><li>2022.7.22 打出来真机包可见，此时暂时可排除顶点绘制函数本身逻辑不兼容嫌疑</li><li>后进行调试，发现新新军线绘制代码 OnPopulateMesh 无调用</li><li>后查询 UGUI Graphic 源码，得知更新条件需要 CanvasRender<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_d50be37f3cd0c49e815f66e70b787669_r.png"></li><li>并经调试查询，发现内部有缺失 CanvasRender 报错<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_c943e0bf3357ca87f645cd426145353d_r.png"></li><li>由此可知 CanvasRender 是一个关键点</li><li>尝试运行时手动添加，无效</li><li>尝试按照源码规则调用，发现获取失败<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_7ecd4aafe84f4752c9fe73b537f8d171_r.png"></li><li>且修改调用方式 <code>gameObject.GetComponent&lt;CanvasRenderer&gt;()</code> 可以获取<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_d85b58ad27084a3c2efae6d069e95f63_r.png"></li><li>该类直接放置于另一个类脚本中，按理说挂载的脚本都是单独一个类，且类名需与代码文件名一致，怀疑是否因此问题导致(<font color="red">尝试后表明于此无关</font>)</li><li>试图添加此绘制组件前，先添加 CanvasRender，cull 置为false<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj.AddComponent&lt;CanvasRenderer&gt;().cull = <span class="literal">false</span></span><br></pre></td></tr></table></figure><font color="blue">已解决</font><br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_33c2313e54dd4d1f7cb1dc921dec1a06_r.png"></li></ul><p>注：其实 UGUI 源代码中，对于 CanvasRenderer 的获取，也是做了额外判断的，若获取空则会添加，不清楚是什么条件造成了添加代码无效的。<br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_b47fe4fe20e60f187a188c892533a313_r.png"></p></li><li><h3 id="AorUIStage-自适应子节点长宽为-NaN"><a href="#AorUIStage-自适应子节点长宽为-NaN" class="headerlink" title="AorUIStage# 自适应子节点长宽为 NaN"></a>AorUIStage# 自适应子节点长宽为 NaN</h3><p>可确定由 AorUiRuntimeUtility 动态创建 AorUIStage# 后，再动态创建可自适应大小的 MainLayer 子容器导致</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AorUIStage</span></span><br><span class="line">GameObject stage = CreatePrefab_UIBase(canv.transform, <span class="number">0</span>, <span class="number">0</span>, <span class="number">512f</span>, <span class="number">512f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>);</span><br><span class="line">stage.name = <span class="string">&quot;AorUIStage#&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//AorUIStage.mainLayer</span></span><br><span class="line">GameObject ml = CreatePrefab_UIBase(stage.transform);</span><br><span class="line">ml.name = <span class="string">&quot;MainLayer&quot;</span>;</span><br><span class="line"></span><br><span class="line">GameObject tl = CreatePrefab_UIBase(stage.transform);</span><br><span class="line">tl.name = <span class="string">&quot;TopLayer&quot;</span>;</span><br></pre></td></tr></table></figure><p>修改 AorUIManager updateStageSize 方法，增加重置计算</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateStageSize</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (Application.isEditor &amp;&amp; !Application.isPlaying)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isAwakeInit || !isInit)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (_scaleMode)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> ScaleModeType.widthBase:</span><br><span class="line">			set2WidthBaseMode();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ScaleModeType.heightBase:</span><br><span class="line">			set2HeightBaseMode();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ScaleModeType.fitScreen:</span><br><span class="line">			set2FitScreenMode();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ScaleModeType.envelopeScreen:</span><br><span class="line">			set2EnvelopeScreenMode();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="literal">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//升级2019后，自适应子节点会出现问题，这里强制重设一次</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Stage.childCount; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		RectTransform rt = Stage.GetChild(i) <span class="keyword">as</span> RectTransform;</span><br><span class="line">		rt.anchoredPosition = Vector2.zero;</span><br><span class="line">		rt.sizeDelta = Vector2.zero;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><font color="blue">已解决</font><br>注：解决方式应当不止这种。</p></li></ol><h2 id="二、Socket-连接"><a href="#二、Socket-连接" class="headerlink" title="二、Socket 连接"></a>二、Socket 连接</h2><p>在编辑器/真机包 返回登录界面时触发。</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_ed85e95c10d4bbb8684ab4b6b7720062_r.png"></p><p>查询是由于调用 <code>socket.Disconnect(true);</code> 导致，估计是以前想复用 Socket 实例，不过查了下代码，每次 open 实际上都是重新创建的一个，将 Disconnect 的调用替换为如下代码解决：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    socket.Shutdown(SocketShutdown.Both);</span><br><span class="line">&#125;</span><br><span class="line">catch (Exception)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Do Nothing</span></span><br><span class="line">&#125;</span><br><span class="line">socket.Close();</span><br><span class="line">socket = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><h2 id="三、自定义DLL的库文件引用"><a href="#三、自定义DLL的库文件引用" class="headerlink" title="三、自定义DLL的库文件引用"></a>三、自定义DLL的库文件引用</h2><p><font color="blue">已解决</font></p><p>DLL 框架版本设置为 4.0 以上(我是 4.5)</p><p>并重新分散引用 Unity 内部 DLL，路径位于对应Unity安装目录</p><p><a href="">Unity 2021.3.0f1\Editor\Data\Managed\UnityEngine</a></p><p>注：重新引用后注意修改 DLL 复制本地 为 false</p><h2 id="四、打-Assetbundle-包出现资源反复Import问题"><a href="#四、打-Assetbundle-包出现资源反复Import问题" class="headerlink" title="四、打 Assetbundle 包出现资源反复Import问题"></a>四、打 Assetbundle 包出现资源反复Import问题</h2><p>表现为初始化环境时，还没轮到正式打 Assetbundle，每个prefab皆出现 Import 提示</p><p>经过调试，发现新版 Unity 在每次打包之前重设标签时，都会导致重新导入一次资源，增加大量额外时间消耗。</p><p>例如：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_84ff6d5065eaba746ae2036b355a1e39_r.png"></p><p><font color="blue">已解决</font>，重设标签时，判断旧标签是否与新标签一致。</p><p>代码位于 AssetBundleTool AddLabel</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddLabel</span>(<span class="params">Object obj, <span class="built_in">string</span> label</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//ClearLabel(obj);</span></span><br><span class="line">    UnityEngine.Object _object = obj;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != _object)</span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;<span class="built_in">string</span>&gt; _labelList = AssetDatabase.GetLabels(obj).ToList();</span><br><span class="line">        <span class="comment">//对象目前已有标签与设置标签不一致，或者对象拥有多个标签(不合法)，则重设标签</span></span><br><span class="line">        <span class="keyword">if</span> (!_labelList.Contains(label) || _labelList.Count &gt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ClearLabel(obj);</span><br><span class="line">            AssetDatabase.SetLabels(obj, <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; label &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果这个物体本来就有指定的label，就不需要重复处理了</span></span><br><span class="line">        <span class="comment">//AssetDatabase.SetLabels(obj, _labelList.ToArray());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注：方法开口有调用 ClearLabel，可知一个对象只会存在一个标签，因此此处直接判断设置标签是否相等即可。</p><h2 id="五、打-Assetbundle-包崩溃"><a href="#五、打-Assetbundle-包崩溃" class="headerlink" title="五、打 Assetbundle 包崩溃"></a>五、打 Assetbundle 包崩溃</h2><p>查询日志得出为栈溢出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Couldn&#x27;t extract exception string from exception of type StackOverflowException (another exception of class &#x27;StackOverflowException&#x27; was thrown while processing the stack trace)</span><br><span class="line"></span><br><span class="line">StackOverflowException: The requested operation caused a stack overflow.</span><br><span class="line">  at (wrapper managed-to-native) System.String.FastAllocateString(int)</span><br><span class="line">  at System.String.CreateStringFromEncoding (System.Byte* bytes, System.Int32 byteLength, System.Text.Encoding encoding) [0x00013] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 </span><br><span class="line">  at System.Text.Encoding.GetString (System.Byte* bytes, System.Int32 byteCount) [0x00033] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 </span><br><span class="line">  at System.Text.Encoding.GetString (System.ReadOnlySpan`1[T] bytes) [0x00013] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 </span><br><span class="line">  at System.String.Ctor (System.SByte* value, System.Int32 startIndex, System.Int32 length, System.Text.Encoding enc) [0x0006d] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 </span><br><span class="line">  at System.String.CreateString (System.SByte* value, System.Int32 startIndex, System.Int32 length, System.Text.Encoding enc) [0x00000] in &lt;6073cf49ed704e958b8a66d540dea948&gt;:0 </span><br><span class="line">  at (wrapper managed-to-managed) System.String..ctor(sbyte*,int,int,System.Text.Encoding)</span><br><span class="line">  at UnityEngine.StackTraceUtility.ExtractStackTrace () [0x0002c] in &lt;1332c534a8a44623b2e5cc943a0b790e&gt;:0 </span><br><span class="line">  at (wrapper managed-to-native) UnityEngine.DebugLogHandler.Internal_Log(UnityEngine.LogType,UnityEngine.LogOption,string,UnityEngine.Object)</span><br><span class="line">  at UnityEngine.DebugLogHandler.LogFormat (UnityEngine.LogType logType, UnityEngine.Object context, System.String format, System.Object[] args) [0x0000b] in &lt;1332c534a8a44623b2e5cc943a0b790e&gt;:0 </span><br><span class="line">  at UnityEngine.Logger.Log (UnityEngine.LogType logType, System.Object message) [0x00027] in &lt;1332c534a8a44623b2e5cc943a0b790e&gt;:0 </span><br><span class="line">  at UnityEngine.Debug.Log (System.Object message) [0x00006] in &lt;1332c534a8a44623b2e5cc943a0b790e&gt;:0 </span><br><span class="line">  at EditorAssetData.caculateTop () [0x00123] in D:\[Works]\sanguo_release\Unity\Assets\Scripts\Editor\AssetBundleTool\EditorAssetData.cs:184 </span><br><span class="line">  at EditorAssetData.caculateTop () [0x0013a] in D:\[Works]\sanguo_release\Unity\Assets\Scripts\Editor\AssetBundleTool\EditorAssetData.cs:185 </span><br><span class="line">  at EditorAssetData.caculateTop () [0x0013a] in D:\[Works]\sanguo_release\Unity\Assets\Scripts\Editor\AssetBundleTool\EditorAssetData.cs:185 </span><br><span class="line">//余下省略========================================================</span><br><span class="line">//余下省略========================================================</span><br><span class="line">//余下省略========================================================</span><br></pre></td></tr></table></figure><p>查询代码可知为递归获取上级引用问题。</p><p>经过调试可发现出现问题者，皆为名称与本身不一致的对象。</p><p>如图所示：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_139eb538f8271f47380e2d84617d883e_r.png"></p><p>出现问题的原因，多为美术(特效)，原因想来很简单，美术直接单纯复制对象，未做正确操作。</p><p>由此可以得出结论，老版本 Unity 可能直接有一套兼容机制处理，新版 Unity 直接崩掉了。</p><p><font color="blue">已解决</font>，通过检测递归层数，人为限制，数量超出上限则打印错误信息，以便修复：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">int</span> _stackOverflowCheck = <span class="number">0</span>;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 一直向上递归，直到上级资源的上级资源数为0或上级资源为BuildSingle</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;EditorAssetData&gt; <span class="title">caculateTop</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    _stackOverflowCheck++;</span><br><span class="line">    <span class="keyword">if</span> (_stackOverflowCheck &gt; <span class="number">50</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(LoadPath+ <span class="string">&quot; 超出递归限制上限，可能已经出现了问题！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> TopUpDependenceList;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>效果：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_bf2570478c346c0d6c1a2d47ee5f736b_r.png"></p><h2 id="六、报-load-IL2CPP-失败"><a href="#六、报-load-IL2CPP-失败" class="headerlink" title="六、报 load IL2CPP 失败"></a>六、报 load IL2CPP 失败</h2><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_8762aae7da2cb29ab3583dabea704121_r.png"></p><p>通过 ADB 拉取的日志查看，一堆 Could not load symbol XXX 的错误</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_e8ed695b5fa9785369ba71cb85935c29_r.png"></p><p>经过对 Unity 导出资源的目录的对比，发现新版资源路径都已经不一样了，多了为两个目录 『Il2CppOutputProject』、『jniStaticLibs』,且 jniLibs 目录中少了 libil2cpp.so，</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_96b794a490972af66945b171a97c4079_r.png"><br><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_549ebbffb5d4210739a18c17ccf60f91_r.png"></p><p>经过查询信息表示，新版 Unity 导出的 AndroidStudio 工程，不再编译 libil2cpp.so ，而是直接提供源码，得自己处理编译的功能。</p><p>打开导出的资源 unityLibrary 目录下的 build.gradle，其中就有编译的代码：</p><p>//省略</p><p>将其复制到我们的 SDK 下 build.gradle 中对应位置，并依照我们项目作出部分修改：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">	//已有代码</span><br><span class="line">	//省略</span><br><span class="line">	//省略</span><br><span class="line"></span><br><span class="line">    aaptOptions &#123;</span><br><span class="line">        noCompress = [&#x27;.unity3d&#x27;, &#x27;.ress&#x27;, &#x27;.resource&#x27;, &#x27;.obb&#x27;, &#x27;.bundle&#x27;, &#x27;.unityexp&#x27;,&#x27;.assetbundle&#x27;]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    packagingOptions &#123;</span><br><span class="line">        doNotStrip &#x27;*/armeabi-v7a/*.so&#x27;</span><br><span class="line">        doNotStrip &#x27;*/arm64-v8a/*.so&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    task BuildIl2CppTask &#123;</span><br><span class="line">        doLast &#123;</span><br><span class="line">            BuildIl2Cpp(project(&#x27;:UnitySdk&#x27;).projectDir.toString().replaceAll(&#x27;\\\\&#x27;, &#x27;/&#x27;), &#x27;Release&#x27;, &#x27;armv7&#x27;, &#x27;armeabi-v7a&#x27;, [  ] as String[]);</span><br><span class="line">            BuildIl2Cpp(project(&#x27;:UnitySdk&#x27;).projectDir.toString().replaceAll(&#x27;\\\\&#x27;, &#x27;/&#x27;), &#x27;Release&#x27;, &#x27;arm64&#x27;, &#x27;arm64-v8a&#x27;, [  ] as String[]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    afterEvaluate &#123;</span><br><span class="line">        if (project(&#x27;:UnitySdk&#x27;).tasks.findByName(&#x27;mergeDebugJniLibFolders&#x27;))</span><br><span class="line">            project(&#x27;:UnitySdk&#x27;).mergeDebugJniLibFolders.dependsOn BuildIl2CppTask</span><br><span class="line">        if (project(&#x27;:UnitySdk&#x27;).tasks.findByName(&#x27;mergeReleaseJniLibFolders&#x27;))</span><br><span class="line">            project(&#x27;:UnitySdk&#x27;).mergeReleaseJniLibFolders.dependsOn BuildIl2CppTask</span><br><span class="line">    &#125;</span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        main &#123;</span><br><span class="line">            jni.srcDirs = [&quot;src/main/Il2CppOutputProject&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def getSdkDir() &#123;</span><br><span class="line">    Properties local = new Properties()</span><br><span class="line">    local.load(new FileInputStream(&quot;$&#123;rootDir&#125;/local.properties&quot;))</span><br><span class="line">    return local.getProperty(&#x27;sdk.dir&#x27;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def BuildIl2Cpp(String workingDir, String configuration, String architecture, String abi, String[] staticLibraries) &#123;</span><br><span class="line">    def commandLineArgs = []</span><br><span class="line">    commandLineArgs.add(&quot;--compile-cpp&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--platform=Android&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--architecture=&quot; + architecture)</span><br><span class="line">    commandLineArgs.add(&quot;--outputpath=&quot; + workingDir + &quot;/src/main/jniLibs/&quot; + abi + &quot;/libil2cpp.so&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--libil2cpp-static&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--baselib-directory=&quot; + workingDir + &quot;/src/main/jniStaticLibs/&quot; + abi)</span><br><span class="line">    commandLineArgs.add(&quot;--incremental-g-c-time-slice=3&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--configuration=&quot; + configuration)</span><br><span class="line">    commandLineArgs.add(&quot;--dotnetprofile=unityaot-linux&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--profiler-report&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--profiler-output-file=&quot; + workingDir + &quot;/build/il2cpp_&quot;+ abi + &quot;_&quot; + configuration + &quot;/il2cpp_conv.traceevents&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--print-command-line&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--generatedcppdir=&quot; + workingDir + &quot;/src/main/Il2CppOutputProject/Source/il2cppOutput&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--cachedirectory=&quot; + workingDir + &quot;/build/il2cpp_&quot;+ abi + &quot;_&quot; + configuration + &quot;/il2cpp_cache&quot;)</span><br><span class="line">    commandLineArgs.add(&quot;--tool-chain-path=&quot; + android.ndkDirectory)</span><br><span class="line">    staticLibraries.eachWithIndex &#123;fileName, i-&gt;</span><br><span class="line">        commandLineArgs.add(&quot;--additional-libraries=&quot; + workingDir + &quot;/src/main/jniStaticLibs/&quot; + abi + &quot;/&quot; + fileName)</span><br><span class="line">    &#125;</span><br><span class="line">    def executableExtension = &quot;&quot;</span><br><span class="line">    if (org.gradle.internal.os.OperatingSystem.current().isWindows())</span><br><span class="line">        executableExtension = &quot;.exe&quot;</span><br><span class="line">    exec &#123;</span><br><span class="line">        executable workingDir + &quot;/src/main/Il2CppOutputProject/IL2CPP/build/deploy/il2cpp&quot; + executableExtension</span><br><span class="line">        args commandLineArgs</span><br><span class="line">        environment &quot;ANDROID_SDK_ROOT&quot;, getSdkDir()</span><br><span class="line">    &#125;</span><br><span class="line">    delete workingDir + &quot;/src/main/jniLibs/&quot; + abi + &quot;/libil2cpp.sym.so&quot;</span><br><span class="line">    ant.move(file: workingDir + &quot;/src/main/jniLibs/&quot; + abi + &quot;/libil2cpp.dbg.so&quot;, tofile: workingDir + &quot;/symbols/&quot; + abi + &quot;/libil2cpp.so&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新执行 AS 打包操作——发现 jniLibs 根本没有生成对应的 libil2cpp.so 文件，导致最终出来的包还是有问题。</p><p>经过与SDK同学一块检查，发现我这边是出包的时候根本没执行 BuildIl2CppTask 代码：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_14c2730fb3ca0de83e909f8f7ae89491_r.png"></p><p>也就是说，就算如果增加了上述代码，要是按照正常流程打包，BuildIl2CppTask会不执行，后边经过研究，只能手动执行 BuildIl2CppTask，手动执行输出也是正常的(经过与SDK同学讨论，暂时也没发现为何没有自动执行的原因)。</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_569e2fc7995ead8fe321bcc78db6033f_r.png"></p><p>这一步尝试成功后，就出了新包测试，确认无误后——如此第一个能跑的包终于出来了!</p><h3 id="无法正常调用-BuildIl2Cpp-编译-libil2cpp-so"><a href="#无法正常调用-BuildIl2Cpp-编译-libil2cpp-so" class="headerlink" title="无法正常调用 BuildIl2Cpp 编译 libil2cpp.so"></a>无法正常调用 BuildIl2Cpp 编译 libil2cpp.so</h3><p>上文提到了直接出包，AS 根本没有执行附加的 BuildIl2CppTask 这条任务</p><p>这一步操作肯定不可能手动执行的，而且有时候涉及到旧资源出包，就算能够成功执行，反复编译也是费时间的麻烦事</p><p>于是向 SDK 同学要了命令『./gradlew BuildIl2CppTask』，修改了打包工具，直接在向 AS 复制资源之前，执行一次 il2cpp 的检查及编译的操作，并将生成的 libil2cpp.so 复制回来作资源缓存：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//=====编译il2cpp======</span></span><br><span class="line"><span class="built_in">string</span> packil2CppSources = Path.Combine(packResRootPath, <span class="string">&quot;Il2CppOutputProject&quot;</span>);</span><br><span class="line"><span class="built_in">string</span> packjniStaticLibsPath = Path.Combine(packResRootPath, <span class="string">&quot;jniStaticLibs&quot;</span>);</span><br><span class="line"><span class="built_in">string</span> sdkil2CppSources = Path.Combine(sdkMainPath, <span class="string">&quot;Il2CppOutputProject&quot;</span>);</span><br><span class="line"><span class="built_in">string</span> sdkjniStaticLibsPath = Path.Combine(sdkMainPath, <span class="string">&quot;jniStaticLibs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//libil2cpp.so 文件</span></span><br><span class="line"><span class="built_in">string</span> packIl2cppv8Files = Path.Combine(packJniPath, <span class="string">&quot;arm64-v8a/libil2cpp.so&quot;</span>);</span><br><span class="line"><span class="built_in">string</span> packIl2cppv7Files = Path.Combine(packJniPath, <span class="string">&quot;armeabi-v7a/libil2cpp.so&quot;</span>);</span><br><span class="line"><span class="built_in">string</span> sdkIl2cppv8Files = Path.Combine(sdkJniPath, <span class="string">&quot;arm64-v8a/libil2cpp.so&quot;</span>);</span><br><span class="line"><span class="built_in">string</span> sdkIl2cppv7Files = Path.Combine(sdkJniPath, <span class="string">&quot;armeabi-v7a/libil2cpp.so&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (File.Exists(sdkIl2cppv8Files)) File.Delete(sdkIl2cppv8Files);</span><br><span class="line"><span class="keyword">if</span> (File.Exists(sdkIl2cppv7Files)) File.Delete(sdkIl2cppv7Files);</span><br><span class="line"><span class="comment">//不存在，编译</span></span><br><span class="line"><span class="keyword">if</span> (!File.Exists(packIl2cppv8Files) || !File.Exists(packIl2cppv7Files))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//清理可能存在的旧文件</span></span><br><span class="line">    <span class="keyword">if</span> (Directory.Exists(sdkil2CppSources)) Directory.Delete(sdkil2CppSources, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (Directory.Exists(sdkjniStaticLibsPath)) Directory.Delete(sdkjniStaticLibsPath, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//复制 il2cpp 源码过去</span></span><br><span class="line">    FileCompare.Copy(packil2CppSources, sdkil2CppSources);</span><br><span class="line">    FileCompare.Copy(packjniStaticLibsPath, sdkjniStaticLibsPath);</span><br><span class="line">    <span class="comment">//正式编译</span></span><br><span class="line">    <span class="built_in">string</span> rootSdkDir = Path.GetDirectoryName(Info.AndroidSDKPath);</span><br><span class="line">    <span class="comment">//刷新</span></span><br><span class="line">    DoCmd(rootSdkDir, <span class="string">&quot;gradlew&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">//编译</span></span><br><span class="line">    DoCmd(rootSdkDir, <span class="string">&quot;gradlew&quot;</span>, <span class="string">&quot;BuildIl2CppTask&quot;</span>);</span><br><span class="line">    Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">//复制回来，避免第二次复用时打包重复编译</span></span><br><span class="line">    <span class="keyword">if</span> (File.Exists(sdkIl2cppv8Files)) FileCompare.Copy(sdkIl2cppv8Files, packIl2cppv8Files);</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(sdkIl2cppv7Files)) FileCompare.Copy(sdkIl2cppv7Files, packIl2cppv7Files);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//================</span></span><br></pre></td></tr></table></figure><p>经测试新流程可以跑通。</p><p>注：此处调用的 AS 命令其实也是调用外部进程编译，所以不走 AS ，直接新开一个控制台命令也是可以的，这样还可以省下复制源码至 AS 的消耗，后边可以考虑优化。</p><h2 id="七、安卓加载-StreamingAsset-目录资源失败"><a href="#七、安卓加载-StreamingAsset-目录资源失败" class="headerlink" title="七、安卓加载 StreamingAsset 目录资源失败"></a>七、安卓加载 StreamingAsset 目录资源失败</h2><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_8e73d862fa40a1c3bee9af2218e13568_r.png"></p><p>查询官方文档看到如下说明：</p><blockquote><p>Unity 会将放置在 Unity 项目中名为 StreamingAssets__（区分大小写）的文件夹中的所有文件逐字复制到目标计算机上的特定文件夹。要获取此文件夹，请使用 Application.streamingAssetsPath 属性。在任何情况下，最好使用 Application.streamingAssetsPath 来获取 StreamingAssets__ 文件夹的位置，因为它总是指向运行应用程序的平台上的正确位置。</p></blockquote><blockquote><p>Application.streamingAssetsPath 返回的位置因平台而异：</p></blockquote><ul><li>大多数平台（Unity Editor、Windows、Linux 播放器、PS4、Xbox One、Switch）使用 Application.dataPath + “/StreamingAssets”。</li><li>macOS 播放器使用 Application.dataPath + “/Resources/Data/StreamingAssets”。</li><li>iOS 使用 Application.dataPath + “/Raw”。</li><li>Android 使用经过压缩的 APK/JAR 文件中的文件：”jar:file://“ + Application.dataPath + “!/assets”。</li></ul><p>其中安卓的路径，与日志输出并不一致，怀疑是否此处引起了差异，于是查询我们项目内相关代码，发现对获取 StreamingAssets 有如下组合：</p><ul><li>FResourceCommon GetStreamingAssetsPath 方法</li><li>LauncherLoading GetStreamingAssetsPath 方法</li></ul><p>原初始化 streamingAssetsPath 路径的代码，判断为安卓没有直接取系统 Application.streamingAssetsPath，而且自己组合的路径，新版 Unity 可能不再对此作兼容性判断，导致无法再使用。</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Application.platform == RuntimePlatform.Android)</span><br><span class="line">&#123;</span><br><span class="line">    STREAMING_ASSET_PATH = Application.dataPath + <span class="string">&quot;!assets&quot;</span>;   <span class="comment">// 安卓平台</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    STREAMING_ASSET_PATH = Application.streamingAssetsPath;  <span class="comment">// 其他平台</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将其修改为直接取 Application.streamingAssetsPath 后，加载正常。</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STREAMING_ASSET_PATH = Application.streamingAssetsPath;  <span class="comment">//新版本所有平台均使用 streamingAssetsPath</span></span><br></pre></td></tr></table></figure><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_61eb0f83a4730a6fbe37afb9aedcf0cd_r.png"></p><h2 id="八、无法调试问题"><a href="#八、无法调试问题" class="headerlink" title="八、无法调试问题"></a>八、无法调试问题</h2><p>将 DLL 设置中，高级生成设置-&gt;调试信息 设置为可移植，并删除项目中 DLL 已有的 MDB 文件，重新编译。</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_1796df03e51bcdc557248e52a4afd5fe_r.png"></p><h2 id="九、Google-包黑屏问题"><a href="#九、Google-包黑屏问题" class="headerlink" title="九、Google 包黑屏问题"></a>九、Google 包黑屏问题</h2><p>表现为闪屏后黑屏，且有 Debug 且存在部分 Unity 输出</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_7691ecd1cd62499ab0bd4d3f7d6aaa78_r.png"></p><p>增加打印并检查日志：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_6da6afa2a09a767f8f68adf0363529e2_r.png"></p><p>从日志中及对应代码推测，可以推测主要有两个问题：</p><ul><li><h3 id="打-Google-包-UseOBB选项未生效"><a href="#打-Google-包-UseOBB选项未生效" class="headerlink" title="打 Google 包 UseOBB选项未生效"></a>打 Google 包 UseOBB选项未生效</h3></li></ul><p>其中涉及代码如下：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        Debug.Log(<span class="string">&quot;Launcher Awake + &quot;</span>+ UseOBB);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UNITY_ANDROID &amp;&amp; !UNITY_EDITOR</span></span><br><span class="line">        SDKManager.Inst.SendMsg(SDKManager.SEND_HAVE_CUTOUT);</span><br><span class="line">        <span class="keyword">if</span>(UseOBB)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Launcher Awake + UseOBB&quot;</span>);</span><br><span class="line">            InitGoogleOBBResources(ShowUI);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;                </span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> UNITY_IPHONE &amp;&amp; !UNITY_EDITOR</span></span><br><span class="line">        SDKManager.Inst.AddEvent(eSDKMngEvent.GetDynamicUpdateStateSuccess, OnGetDynamicUpdateStateSuccess);</span><br><span class="line">        SDKManager.Inst.SendMsg(SDKManager.SEND_GET_DYNAMIC_UPDATE_NO);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>在场景的 Launcher 上，就有 UseOBB 这个选项，用于控制我们游戏内是否能够正确识别为 Google 包</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_c7e9f51fd6518929d6a9a8174df05d06_r.png"></p><p>增加打印后，此处开始为 false（<font color="red">注：上述日志截图为解决后的表现，因此显示为 true</font>）</p><p>这个 UseOBB 选项，之前是在出 Google 包时，通过代码直接设置的。</p><p>但是经过个人反复测试，发现新版 Unity 在代码设置场景物体属性后，该项不会正常生效!</p><p>最简单的重现方式为：代码修改场景物体属性后，重启Unity，物体属性被还原(即使修改后调用保存场景及资源的接口，依然无效)。</p><p>解决方式为：将出包时自动设置 UseOBB 属性处修改为一个判断，若出包类型为 Google OBB模式，且 UseOBB 未勾选，弹出提示需要手动勾选保存。</p><ul><li><h3 id="OBB-无法被主应用正确识别"><a href="#OBB-无法被主应用正确识别" class="headerlink" title="OBB 无法被主应用正确识别"></a>OBB 无法被主应用正确识别</h3></li></ul><p>还是根据上述日志分析，看着像是没有正确识别 OBB，导致资源未能成功加载而报空。</p><p>在之前我们 Unity2017 出包的时候，导出的 AS 项目资源中，其中 AndroidManifest.xml 文件存在一个 build-id 的字段。</p><p>不过新版 Unity 导出资源中，AndroidManifest.xml 已经没有了，所以开始是直接打的包。</p><p>2021升级文档： <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UpgradeGuide2021LTS.html#Android">Upgrading to Unity 2021 LTS</a></p><p>其中有这么一个描述：</p><blockquote><p>Changed how Unity checks to see if an obb is compatible with an apk<br>. Both the apk and obb now have unity_obb_guid file inside them and if the contents match between them, Unity treats them as being compatible.</p></blockquote><p>意思是现在 Unity 通过 APK 及 OBB 包中的一个名为 unity_obb_guid 文件来确认 APK 与 OBB 是否一致。</p><p>也就是说，从 Unity2021 开始，OBB 识别机制不走 build-id ，而是走另外文件对比了。</p><p>解包 OBB 后，果然发现了这个东西：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_f2c167f2345b8c1745c81e089d5570bd_r.png"></p><p>同时检查打包出来的 APK，发现缺失，通过搜索 Unity 导出资源目录，可发现 APK 中该文件位于 unityLibrary\src\main\assets\unity_obb_guid</p><p>在之前我们的打包工具中，对 assets 目录的内容只复制其子目录，导致缺了文件，修改打包工具代码：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">assetPaths = Directory.GetDirectories(packAssetsPath);</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; assetPaths.Length; i++)</span><br><span class="line">&#123;</span><br><span class="line">    FileCompare.Copy(assetPaths[i], (sdkAssetsPath + assetPaths[i].Replace(packAssetsPath, <span class="string">&quot;&quot;</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//复制 unity_obb_guid 文件</span></span><br><span class="line"><span class="built_in">string</span> packObbGuidFile = Path.Combine(packAssetsPath, <span class="string">&quot;unity_obb_guid&quot;</span>);</span><br><span class="line"><span class="built_in">string</span> sdkObbGuidFile = Path.Combine(sdkAssetsPath, <span class="string">&quot;unity_obb_guid&quot;</span>);</span><br><span class="line">FileCompare.Copy(packObbGuidFile, sdkObbGuidFile);</span><br></pre></td></tr></table></figure><p>这时候果然就可以了：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_410dbb6736ddf63920ea3aa14242adb1_r.png"></p><h2 id="十、进出战斗崩溃"><a href="#十、进出战斗崩溃" class="headerlink" title="十、进出战斗崩溃"></a>十、进出战斗崩溃</h2><p>最初表现为打开引导时，概率发生于进入战斗时崩溃。</p><p>第一次查询的崩溃日志如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">Received signal SIGSEGV</span><br><span class="line">Obtained 50 stack frames</span><br><span class="line">0x00007ff7b5c0aceb (Unity) GameObject::SendMessageAny</span><br><span class="line">0x00007ff7b607e835 (Unity) Transform::BroadcastMessageAny</span><br><span class="line">0x00007ff7b607e899 (Unity) Transform::BroadcastMessageAny</span><br><span class="line">0x00007ff7b607e899 (Unity) Transform::BroadcastMessageAny</span><br><span class="line">0x00007ff7b688d7f6 (Unity) UI::Canvas::WillDestroyComponent</span><br><span class="line">0x00007ff7b5c0d3a1 (Unity) GameObject::WillDestroyGameObject</span><br><span class="line">0x00007ff7b5f18901 (Unity) PreDestroyRecursive</span><br><span class="line">0x00007ff7b5f16927 (Unity) DestroyObjectHighLevel_Internal</span><br><span class="line">0x00007ff7b5f16564 (Unity) DestroyObjectHighLevel</span><br><span class="line">0x00007ff7b626638f (Unity) Scripting::DestroyObjectFromScriptingImmediate</span><br><span class="line">0x00007ff7b54dd663 (Unity) Object_CUSTOM_DestroyImmediate</span><br><span class="line">0x0000018b373dcb35 (Mono JIT Code) (wrapper managed-to-native) UnityEngine.Object:DestroyImmediate (UnityEngine.Object,bool)</span><br><span class="line">0x0000018b373dca53 (Mono JIT Code) UnityEngine.Object:DestroyImmediate (UnityEngine.Object)</span><br><span class="line">0x0000018c1010bae3 (Mono JIT Code) YoukiaUnity.Resource.PoolManager:CleanPool (string)</span><br><span class="line">0x0000018c1219f07b (Mono JIT Code) [BattleStage.cs:85] Demo.Stage.BattleStage:CleanPool () </span><br><span class="line">0x0000018c100fabab (Mono JIT Code) [BattleStage.cs:79] Demo.Stage.BattleStage:OnAsyncHandle () </span><br><span class="line">0x0000018c1219efbb (Mono JIT Code) [BattleStage.cs:116] Demo.Stage.BattleStage:&lt;OnSceneLoaded&gt;b__10_0 () </span><br><span class="line">0x0000018c1219ef76 (Mono JIT Code) [BattleManager.cs:1798] BattleManager:_onCreateFinish () </span><br><span class="line">0x0000018b3af83c05 (Mono JIT Code) YoukiaCore.AsyncCombiner:RefreshAsyncHandles ()</span><br><span class="line">0x0000018b3af8d2c3 (Mono JIT Code) YoukiaCore.AsyncCombiner/AsyncHandle:Finish ()</span><br><span class="line">0x0000018c1011fbdb (Mono JIT Code) [BattleManager.cs:2004] BattleManager/&lt;&gt;c__DisplayClass139_0:&lt;_onRoleAdd&gt;b__0 () </span><br><span class="line">0x0000018c1219dd26 (Mono JIT Code) [ModelChiefView.cs:147] Demo.ModelChiefView/&lt;&gt;c__DisplayClass10_0:&lt;Create&gt;b__2 () </span><br><span class="line">0x0000018c1219db21 (Mono JIT Code) [ModelChiefView.cs:193] Demo.ModelChiefView/&lt;&gt;c__DisplayClass13_0:&lt;AddMountSkillClip&gt;b__0 (object) </span><br><span class="line">0x0000018b3af41b1c (Mono JIT Code) FrameWork.FProcess:allDone ()</span><br><span class="line">0x0000018b3af41573 (Mono JIT Code) FrameWork.FProcess:AssetLoaded (object[])</span><br><span class="line">0x0000018b3af40fff (Mono JIT Code) FrameWork.FGameEvent:DispatchEvent (System.Enum,object[])</span><br><span class="line">0x0000018b3af40e43 (Mono JIT Code) FrameWork.FEventManager:DispatchEvent (System.Enum,object[])</span><br><span class="line">0x0000018b3af40d33 (Mono JIT Code) FrameWork.FProcess:ProcessComplete ()</span><br><span class="line">0x0000018b3af3a9ab (Mono JIT Code) FrameWork.FProcess/&lt;_load&gt;d__18:MoveNext ()</span><br><span class="line">0x0000018b3862cff0 (Mono JIT Code) UnityEngine.SetupCoroutine:InvokeMoveNext (System.Collections.IEnumerator,intptr)</span><br><span class="line">0x0000018b3862d11f (Mono JIT Code) (wrapper runtime-invoke) &lt;Module&gt;:runtime_invoke_void_object_intptr (object,intptr,intptr,intptr)</span><br><span class="line">0x00007ffdf5e6e4b4 (mono-2.0-bdwgc) [mini-runtime.c:3445] mono_jit_runtime_invoke </span><br><span class="line">0x00007ffdf5dae764 (mono-2.0-bdwgc) [object.c:3066] do_runtime_invoke </span><br><span class="line">0x00007ffdf5dae8fc (mono-2.0-bdwgc) [object.c:3113] mono_runtime_invoke </span><br><span class="line">0x00007ff7b626dac4 (Unity) scripting_method_invoke</span><br><span class="line">0x00007ff7b6268644 (Unity) ScriptingInvocation::Invoke</span><br><span class="line">0x00007ff7b621a1df (Unity) Coroutine::Run</span><br><span class="line">0x00007ff7b6217c1c (Unity) Coroutine::ContinueCoroutine</span><br><span class="line">0x00007ff7b5d35344 (Unity) DelayedCallManager::Update</span><br><span class="line">0x00007ff7b5f45d29 (Unity) `InitPlayerLoopCallbacks&#x27;::`2&#x27;::UpdateScriptRunDelayedDynamicFrameRateRegistrator::Forward</span><br><span class="line">0x00007ff7b5f2c89c (Unity) ExecutePlayerLoop</span><br><span class="line">0x00007ff7b5f2c973 (Unity) ExecutePlayerLoop</span><br><span class="line">0x00007ff7b5f325d9 (Unity) PlayerLoop</span><br><span class="line">0x00007ff7b6e7993f (Unity) PlayerLoopController::UpdateScene</span><br><span class="line">0x00007ff7b6e77bdf (Unity) Application::TickTimer</span><br><span class="line">0x00007ff7b72c37aa (Unity) MainMessageLoop</span><br><span class="line">0x00007ff7b72c805b (Unity) WinMain</span><br><span class="line">0x00007ff7b864b42e (Unity) __scrt_common_main_seh</span><br><span class="line">0x00007ffe3a797034 (KERNEL32) BaseThreadInitThunk</span><br><span class="line">0x00007ffe3b5c2651 (ntdll) RtlUserThreadStart</span><br></pre></td></tr></table></figure><p>对比代码发现，我们游戏在进入战斗时，会强制清理一次对象池，而清理方式则是直接调用 <code>GameObject.DestroyImmediate</code></p><p>GameObject.DestroyImmediate 和 GameObject.Destroy 一直是有区别的，记得很早以前官方都推荐正式环境用 Destroy 而非 DestroyImmediate。</p><p>为了确认看了下文档：</p><blockquote><p>立即销毁对象 /obj/。强烈建议您改用 Destroy。</p></blockquote><blockquote><p>该函数应只在编写 Editor 代码时使用，因为在编辑模式下， 永远不会调用延迟销毁。 在游戏代码中，您应该改用 Object.Destroy。Destroy 始终延迟进行 （但在同一帧内执行）。 使用该函数时要务必小心，因为它可以永久销毁资源！ 另请注意，切勿循环访问数组并销毁正在迭代的元素。这会导致严重的问题（这是一条通用的编程实践，而不仅仅是在 Unity 中）。</p></blockquote><p>说明 DestroyImmediate 肯定是有一定风险的，特别是 CleanPool 中的代码，还正好是一个循环调用的 DestroyImmediate。</p><p>于是怀疑是否这里的影响，尝试将其修改为 Destroy。</p><p>如此之后————还是崩溃了，日志变成如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Asset Pipeline Refresh: Total: 0.027 seconds - Initiated by RefreshV2(AllowForceSynchronousImport)</span><br><span class="line">Received signal SIGSEGV</span><br><span class="line">Obtained 22 stack frames</span><br><span class="line">0x00007ff7b5c0aceb (Unity) GameObject::SendMessageAny</span><br><span class="line">0x00007ff7b607e835 (Unity) Transform::BroadcastMessageAny</span><br><span class="line">0x00007ff7b607e899 (Unity) Transform::BroadcastMessageAny</span><br><span class="line">0x00007ff7b607e899 (Unity) Transform::BroadcastMessageAny</span><br><span class="line">0x00007ff7b688d7f6 (Unity) UI::Canvas::WillDestroyComponent</span><br><span class="line">0x00007ff7b5c0d3a1 (Unity) GameObject::WillDestroyGameObject</span><br><span class="line">0x00007ff7b5f18901 (Unity) PreDestroyRecursive</span><br><span class="line">0x00007ff7b5f16927 (Unity) DestroyObjectHighLevel_Internal</span><br><span class="line">0x00007ff7b5f16564 (Unity) DestroyObjectHighLevel</span><br><span class="line">0x00007ff7b5d3345b (Unity) DelayedDestroyCallback</span><br><span class="line">0x00007ff7b5d35344 (Unity) DelayedCallManager::Update</span><br><span class="line">0x00007ff7b5f457b9 (Unity) `InitPlayerLoopCallbacks&#x27;::`2&#x27;::PostLateUpdateScriptRunDelayedDynamicFrameRateRegistrator::Forward</span><br><span class="line">0x00007ff7b5f2c89c (Unity) ExecutePlayerLoop</span><br><span class="line">0x00007ff7b5f2c973 (Unity) ExecutePlayerLoop</span><br><span class="line">0x00007ff7b5f325d9 (Unity) PlayerLoop</span><br><span class="line">0x00007ff7b6e7993f (Unity) PlayerLoopController::UpdateScene</span><br><span class="line">0x00007ff7b6e77bdf (Unity) Application::TickTimer</span><br><span class="line">0x00007ff7b72c37aa (Unity) MainMessageLoop</span><br><span class="line">0x00007ff7b72c805b (Unity) WinMain</span><br><span class="line">0x00007ff7b864b42e (Unity) __scrt_common_main_seh</span><br><span class="line">0x00007ffe3a797034 (KERNEL32) BaseThreadInitThunk</span><br><span class="line">0x00007ffe3b5c2651 (ntdll) RtlUserThreadStart</span><br></pre></td></tr></table></figure><p>由于这次属于延时销毁，所以不再有实际调用销毁的堆栈打印，不过最终走到的崩溃位置还是一样: <code>GameObject::SendMessageAny</code></p><p>在此处增加对应销毁物体打印，只看到一个 TS_MainButtomView</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;color=lightblue&gt;1660365391&lt;/color&gt; Debug:销毁：TS_MainButtomView </span><br></pre></td></tr></table></figure><p>造成崩溃对象可能就是这个 Prefab，在我们项目是一个 UI 组件。</p><p>并且后续经过尝试，若不销毁该对象，同样有可能崩溃，且会发生于退出战斗时也可能崩溃。</p><p>这时候基本上已经相当怀疑这个对象了，只是由于每次碰到的崩溃最终堆栈信息都还不尽相同，所以无法定性，常见有：</p><ul><li>销毁</li><li>创建</li><li>刷新精灵Sprite<blockquote><p>tlsf_free<br>DynamicHeapAllocator::Deallocate</p></blockquote></li></ul><p>正准备试试官方文档介绍的 <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/WindowsDebugging.html">Debug方式</a> 的时候，后续测试同学竟还找到了一个稳定复现之处，再经个人反复尝试和查询，最终得到如下指向比较清晰一点日志：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Received signal SIGSEGV</span><br><span class="line">Obtained 51 stack frames</span><br><span class="line">0x00007ff7e8a5f2a4 (Unity) UI::CanvasManager::AddCanvas</span><br><span class="line">0x00007ff7e8a73633 (Unity) UI::Canvas::AddToManager</span><br><span class="line">0x00007ff7e8a73c65 (Unity) UI::Canvas::AwakeFromLoad</span><br><span class="line">0x00007ff7e8512fe7 (Unity) AwakeFromLoadQueue::InvokeAwakeFromLoad</span><br><span class="line">0x00007ff7e850e003 (Unity) AwakeFromLoadQueue::AwakeFromLoadAllQueues</span><br><span class="line">0x00007ff7e7df417a (Unity) GameObject::ActivateAwakeRecursively</span><br><span class="line">0x00007ff7e7dfb719 (Unity) GameObject::SetSelfActive</span><br><span class="line">0x00007ff7e767fd9b (Unity) GameObject_CUSTOM_SetActive</span><br><span class="line">0x00000126e405c104 (Mono JIT Code) (wrapper managed-to-native) UnityEngine.GameObject:SetActive (UnityEngine.GameObject,bool)</span><br><span class="line">0x00000126f84444fb (Mono JIT Code) [MainButtomView.cs:1442] MainButtomView/&lt;&gt;c__DisplayClass115_0:&lt;OpenView&gt;b__0 (object) </span><br></pre></td></tr></table></figure><p>崩溃结果指向，界面的子节点挂载的 Canvas，该对象(TS_MainButtomView)属于主界面 Aorpage 的一个 子节点 Prefab，且自身挂载了 Canvas。</p><p>这里经过尝试，表明该组件并非是必须的。</p><p>于是移除之后就真的好了..</p><h2 id="十一、重打图集混乱"><a href="#十一、重打图集混乱" class="headerlink" title="十一、重打图集混乱"></a>十一、重打图集混乱</h2><p>例如，更改图集大小，最明显的一个错误表现如下：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_3dc46ec72951416efa3db5e39d72cf52_r.png"></p><p>如果现在点击提交，发现meta文件都未被修改：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_1a847eda1a12e0c8d768a4f928876577_r.png"></p><p>而且编辑器中也可以明显看出 Position 依然是旧的——经过分析调试，在编辑器工具生成新的图集数据时，确实也是赋值了新的数据的：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_37d6afb2f1f694e23da5f116b33d1fb9_r.png"></p><p>于怀疑是不是 Unity 内部又出啥事了。</p><p>经过查询关键字 textureImporter.spritesheet，有找到一篇可能有所关联的博客 <a target="_blank" rel="noopener" href="https://blog.csdn.net/rcfalcon/article/details/49743715">unity 2D Sprite网格Slice工具</a></p><p>这篇文章描述了 Unity 的 textureImporter.spritesheet 大约存在一个 BUG，当图集中图片未被修改，仅发生位置表动时，将导致其数据无法正常更新。虽然这篇博文已经早是 2015 年的东西了，不过本着尝试一下的感觉，没成想真是这个问题！</p><p>末尾给加上</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">textureImporter.mipmapEnabled = !textureImporter.mipmapEnabled;</span><br><span class="line">textureImporter.SaveAndReimport();</span><br><span class="line">textureImporter.mipmapEnabled = <span class="literal">false</span>;</span><br><span class="line">textureImporter.SaveAndReimport();</span><br></pre></td></tr></table></figure><p>就正常了，关键是这个在之前 Unity2017 还能正常工作的。</p><h2 id="十二、正式包"><a href="#十二、正式包" class="headerlink" title="十二、正式包"></a>十二、正式包</h2><p>其它比较简单一点、或者一些功能上的的升级问题，这里就不作记录了，最终正式包如下：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-20/m_01c6a4b39b61c4c75075e6451fd2968e_r.png"></p><div class="tags-container-bottom"><i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/问题解决记录/">#问题解决记录</a></div><br><br><hr><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MsaVbSzIr9cIfikihDExdun9-gzGzoHsz",appKey:"Bj6SEFUBomrLOTWx9B8S6zQH",placeholder:"请输入评论内容~",avatar:"mp",visitor:!1})</script></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l site-author"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/photo.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="CWHISME"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">悲观主义的末日</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>分类</h3><p><a href="/categories/Unity3D/">Unity3D</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>近期文章</h3><p><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/">协变和逆变</a></p><p><a href="/2022/12/06/Unity%E7%9A%84%E9%98%B4%E5%BD%B1%E4%B8%8E%E5%85%89%E7%85%A7%E7%83%98%E7%84%99/">Unity 的阴影与光照烘焙</a></p><p><a href="/2022/11/23/%E6%89%93%E5%8C%85AssetBundle%E5%9F%BA%E7%A1%80%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86/">打包 AssetBundle 的基础规则整理</a></p><p><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/">StringBuilder 扩容规则研究</a></p><p><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">简单测试手动垃圾回收</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/CWHISME" target="_blank"><i class="fa fa-github"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="mailto:cwhisme@126.com" target="_blank"><i class="fa fa-envelope"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">Copyright © 2021 | Design & Hexo <a class="link dim white" target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-anodyne/">Jonathan Klughertz</a> | Modify By CWHISME</div></div></div></body></html>