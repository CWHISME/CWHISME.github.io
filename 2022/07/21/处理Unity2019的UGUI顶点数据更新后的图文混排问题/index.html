<!DOCTYPE html><meta name="viewport" content="height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cwhisme"><meta name="author" content="CWHISME"><meta property="og:title" content="处理Unity2019的UGUI顶点数据更新后的图文混排问题"><meta property="og:description" content="cwhisme"><meta property="og:site_name" content="WangJiaYing"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>处理Unity2019的UGUI顶点数据更新后的图文混排问题 - WangJiaYing</title><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/DateTimeAfeterCalc.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/particles-bg.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/script.js"></script><link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/css/style.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="WangJiaYing" type="application/atom+xml">
</head><body><canvas id="hackEffectCanvas" style="position:fixed;z-index:-1;pointer-events:none"></canvas><canvas class="fireworks" style="position:fixed;z-index:10;pointer-events:none"></canvas><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="WangJiaYing"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/logo.svg" class="dib h3" alt="WangJiaYing"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags" title="Tags">Tags </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/categories" title="Categories">Categories </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/bookmark" title="Bookmark">Bookmark </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="About">About</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">处理Unity2019的UGUI顶点数据更新后的图文混排问题</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2022-07-21&nbsp&nbsp <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="dateTimeAfter">2022-07-21</span></p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-snowflake-o"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><div class="tags-container-vertical"><div class="tags-sub-container"><a class="fw3 ph1 dib" href="/tags/问题解决记录/">#问题解决记录</a></div></div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前听到运营那边报我们游戏可能会出现崩溃问题，主要是韩服，三星机器。</p><p>于是拿了日志来看，主要信息如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">2022-07-07 14:58:35.666 10105-11685/? E/Unity: Using memoryadresses from more that 16GB of memory</span><br><span class="line">     </span><br><span class="line">    (Filename:  Line: 120)</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH: signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 00000000005ce87f</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH: Build fingerprint: &#x27;samsung/d1xks/d1x:12/SP1A.210812.016/N971NKSU2HVE9:user/release-keys&#x27;</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH: Revision: &#x27;23&#x27;</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH: pid: 10105, tid: 11685, name: Thread-21  &gt;&gt;&gt; com.gamemorefun.sgztw &lt;&lt;&lt;</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH:     x0   0000000000000000  x1   000000715477cf1c  x2   0000006ec75ced60  x3   0000006d857acc28</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH:     x4   000000000000007c  x5   0000000000000000  x6   000000716ad1c000  x7   000000001fdcdd1e</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH:     x8   0000000000000000  x9   00000000ffffffff  x10  0000000000000090  x11  0000000000000008</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH:     x12  0000fffffffff3ff  x13  0000000000000020  x14  0000000000800000  x15  0000000000000001</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH:     x16  0000006dad6574b0  x17  00000071546e0b70  x18  0000006d857ad0c4  x19  0000006dad6ff8b0</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH:     x20  0000006cba745fe0  x21  0000006dad6ff8b0  x22  0000006dad6ff8e0  x23  000000000000005d</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH:     x24  0000006dad6fd050  x25  00000000005ce597  x26  0000000000000018  x27  3fd1d9b7b46c74bd</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH:     x28  00000000000027d4  x29  0000006d857ad000  x30  0000006dac83d4e4</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH:     sp   0000006d857acfb0  pc   0000006dac83d53c  pstate 0000000060000000</span><br><span class="line">2022-07-07 14:58:36.069 10105-11685/? E/CRASH: backtrace:</span><br></pre></td></tr></table></figure><p>其中关键字就是 『Using memoryadresses from more that 16GB of memory』，通过查询，可以找到一些，例如官方论坛：<a target="_blank" rel="noopener" href="https://developer.unity.cn/projects/622b33a7edbc2a001b6f7776">https://developer.unity.cn/projects/622b33a7edbc2a001b6f7776</a></p><p>这里解释得知，是由于安卓新版系统内存分配器更换导致 Unity 出现的BUG，并且 Unity 也在后续版本更新中同步解决了这个问题，然而修复版本并不包括2017：</p><ul><li>2018.4.30</li><li>2019.4.15</li><li>2020.1.14</li><li>2020.2.0b12</li><li>2021.1.0a4</li></ul><p>恰好我们项目使用的是 Unity2017，因此这种情况除更新 Unity之外恐怕也别无他法。</p><p>于是就想升级，个人就吭吭哧哧在自己电脑上进行版本升级的兼容性测试了，开始用 2018 打开瞧了瞧，并出了个PC包，感觉没啥大问题，后来索性又用 2019 打开了来看，点了点发现了这么个 UGUI 的图文混排以及超链接失效问题。</p><p>(注：开始还以为只2019被改了，事实证明，新版本Unity2018其实也有这问题，据说Unity2018从2018.4也改过了，Unity2019大概是从2019.2修改)</p><p>我们项目的图文混排以及超链接，都是通过一个叫 AorTextIncSprites 脚本实现，该脚本继承于 MaskableGraphic ，并复制了 Unity5.6 的 UGUI源码，在其基础上加入了超链接和表情的图文混排支持——相当古老的代码了，不过还能工作。</p><p>只是拿到 Unity2019 之后，这两个额外的功能都出现了些问题，例如超链接有的无法正确生成点击区域导致无法触发对应事件、图文混排直接糊掉——表现为绘制整个图集，大概就这么个样子：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-21/m_e7bf620f8dce19917458f506a2afeaa5_r.png"></p><h2 id="UGUI顶点数据"><a href="#UGUI顶点数据" class="headerlink" title="UGUI顶点数据"></a>UGUI顶点数据</h2><p>UGUI顶点数据中，据说从 2019.2、2018.4 开始，全都不再包含富文本数据，导致以往涉及到 UGUI顶点修改的相关代码，能够正常工作的都不再正常。</p><p>主要受影响的有：图文混排、超链接、竖行排行(VerticalText)</p><h2 id="超链接"><a href="#超链接" class="headerlink" title="超链接"></a>超链接</h2><p>超链接的问题，主要体现在聊天频道中，某些含有坐标的信息，无法点击坐标——经过检查，内部问题在于点击范围的错误处理，导致未能正确生成包围范围数据。</p><p>原代码如下：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取超链接解析后的最后输出文本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateHrefInfo</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    s_TextBuilder.Length = <span class="number">0</span>;</span><br><span class="line">    m_HrefInfos.Clear();</span><br><span class="line">    <span class="keyword">var</span> indexText = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (Match match <span class="keyword">in</span> s_HrefRegex.Matches(originalText))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> replaceText = originalText.Substring(indexText, match.Index - indexText);</span><br><span class="line">        s_TextBuilder.Append(replaceText);</span><br><span class="line">        <span class="comment">//s_TextBuilder.Append(string.Format(&quot;&lt;color=&#123;0&#125;&gt;&quot;, _href_Color)); // 超链接颜色</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">group</span> = match.Groups[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">var</span> hrefInfo = <span class="keyword">new</span> HrefInfo</span><br><span class="line">        &#123;</span><br><span class="line">            startIndex = s_TextBuilder.Length * <span class="number">4</span>, <span class="comment">// 超链接里的文本起始顶点索引</span></span><br><span class="line">            endIndex = (s_TextBuilder.Length + match.Groups[<span class="number">2</span>].Length - <span class="number">1</span>) * <span class="number">4</span> + <span class="number">3</span>,</span><br><span class="line">            name = <span class="keyword">group</span>.Value</span><br><span class="line">        &#125;;</span><br><span class="line">        m_HrefInfos.Add(hrefInfo);</span><br><span class="line"></span><br><span class="line">        s_TextBuilder.Append(match.Groups[<span class="number">2</span>].Value);</span><br><span class="line">        <span class="comment">//s_TextBuilder.Append(&quot;&lt;/color&gt;&quot;);</span></span><br><span class="line">        indexText = match.Index + match.Length;</span><br><span class="line">    &#125;</span><br><span class="line">    s_TextBuilder.Append(originalText.Substring(indexText, originalText.Length - indexText));</span><br><span class="line">    <span class="comment">//return s_TextBuilder.ToString();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要问题在于，其中计算 『超链接里的文本起始顶点索引』中，直接拿原文进行计算，没有忽略富文本信息，上边提到过，新版 UGUI 已经不再包含富文本数据。</p><p>因此超链接问题修改相对比较简单，在此处筛除掉富文本信息，然后再取长度即可。</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//省略=============</span></span><br><span class="line"><span class="built_in">int</span> length = ReplaceRichText(s_TextBuilder.ToString()).Length;</span><br><span class="line"><span class="keyword">var</span> hrefInfo = <span class="keyword">new</span> HrefInfo</span><br><span class="line">&#123;</span><br><span class="line">	startIndex = length * <span class="number">4</span>, <span class="comment">// 超链接里的文本起始顶点索引</span></span><br><span class="line">	endIndex = (length + match.Groups[<span class="number">2</span>].Length - <span class="number">1</span>) * <span class="number">4</span> + <span class="number">3</span>,</span><br><span class="line">	name = <span class="keyword">group</span>.Value</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//省略=============</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Unity2019富文本什么的顶点信息都没了，计算长度时剔除富文本</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">ReplaceRichText</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	str = Regex.Replace(str, <span class="string">@&quot;&lt;color=(.+?)&gt;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	str = str.Replace(<span class="string">&quot;&lt;/color&gt;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	str = str.Replace(<span class="string">&quot;&lt;b&gt;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	str = str.Replace(<span class="string">&quot;&lt;/b&gt;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	str = str.Replace(<span class="string">&quot;&lt;i&gt;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	str = str.Replace(<span class="string">&quot;&lt;/i&gt;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	str = str.Replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	str = str.Replace(<span class="string">&quot;\t&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	str = str.Replace(<span class="string">&quot;\r&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	str = str.Replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="图文混排"><a href="#图文混排" class="headerlink" title="图文混排"></a>图文混排</h2><p>这个问题跟超链接类似，都是由于 UGUI 不再记录富文本信息导致失效。</p><p>虽然知道了这点，但是由于图文混排操作更多，即使问题一样，修复图文混排还是要麻烦得多。</p><h3 id="基础修复"><a href="#基础修复" class="headerlink" title="基础修复"></a>基础修复</h3><p>来到绘制表情的方法，这儿位于 OnPopulateMesh，原本代码如下：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MatchCollection matches = Regex.Matches(text, <span class="string">&quot;&lt;quad.+?&gt;&quot;</span>);</span><br><span class="line"><span class="built_in">int</span> diff = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; matches.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">    EmojiInfo info;</span><br><span class="line">    Match numberMatch = Regex.Match(matches[i].Value, <span class="string">&quot;[0-9]+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (EmojiIndex.TryGetValue(numberMatch.Value, <span class="keyword">out</span> info))</span><br><span class="line">    &#123;</span><br><span class="line">        info.len = matches[i].Length;</span><br><span class="line">        emojiDic.Add(matches[i].Index, info);</span><br><span class="line">        diff += info.len - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        info.len = matches[i].Length;</span><br><span class="line">        emojiDic.Add(matches[i].Index, EmojiIndex[<span class="string">&quot;0&quot;</span>]);</span><br><span class="line">        diff += info.len - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处处在正式绘制之前，通过正则表达式，解析原本的文字内容，将表情标签剔出来，并生成对应对应表情数据放在一个字典中，以备后用。</p><p>出现问题的主要原因就在于原本的这个 <code>matches[i].Index</code>——既然是正则表达式，那么获取到的下标，自然是没有排除用于表情占位标签长度的，之前 UGUI同样存储了对这些标签的处理数据还没事，现在 UGUI 数据中不在包含，获取的数据就会有问题。</p><p>因此，我合计了一下 <code>&lt;quad name = XX&gt;</code>的长度，计算了一下各种组合可能的长度：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//仅表情标签，不算表情id的长度</span></span><br><span class="line"><span class="string">&quot;&lt;quad name = &gt;&quot;</span>.Length</span><br><span class="line"><span class="number">14</span></span><br><span class="line"><span class="comment">//1位表情id的表情标签长度</span></span><br><span class="line"><span class="string">&quot;&lt;quad name = 2&gt;&quot;</span>.Length</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="comment">//两个连续2位表情，总共长度</span></span><br><span class="line"><span class="string">&quot;&lt;quad name = 22&gt;&lt;quad name = 22&gt;&quot;</span>.Length</span><br><span class="line"><span class="number">32</span></span><br><span class="line"><span class="comment">//两个连续表情，第二个表情坐标</span></span><br><span class="line"><span class="string">&quot;&lt;quad name = 22&gt;&lt;quad name = 8&gt;&quot;</span>.IndexOf(<span class="string">&quot;&lt;quad name = 8&gt;&quot;</span>)</span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="comment">//一个2位表情标签长度</span></span><br><span class="line"><span class="string">&quot;&lt;quad name = 22&gt;&quot;</span>.Length</span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="comment">//一个1位表情标签长度</span></span><br><span class="line"><span class="string">&quot;&lt;quad name = 8&gt;&quot;</span>.Length</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="comment">//确认Unicode空格符长度</span></span><br><span class="line"><span class="string">&quot;\u3000\u3000\u3000\u3000&quot;</span>.Length</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="comment">//混合表情，剔除第一个表情标签长度</span></span><br><span class="line"><span class="string">&quot;bbbbb&lt;quad name = 22&gt;aaaaaa&lt;quad name = 8&gt;&quot;</span>.Length<span class="number">-16</span></span><br><span class="line"><span class="number">26</span></span><br><span class="line"><span class="comment">//混合表情，第二个表情标签坐标</span></span><br><span class="line"><span class="string">&quot;bbbbb&lt;quad name = 22&gt;aaaaaa&lt;quad name = 8&gt;&quot;</span>.IndexOf(<span class="string">&quot;&lt;quad name = 8&gt;&quot;</span>)<span class="number">-16</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="comment">//连续两个表情标签，剔除第一个表情标签后第二个表情标签坐标</span></span><br><span class="line"><span class="string">&quot;&lt;quad name = 22&gt;&lt;quad name = 8&gt;&quot;</span>.IndexOf(<span class="string">&quot;&lt;quad name = 8&gt;&quot;</span>)<span class="number">-16</span>  </span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure><p>如此，找出一个比较共性的一点，使得计算时剔除<code>&lt;quad name = XX&gt;</code>的长度之后进行尝试性修改：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">MatchCollection matches = Regex.Matches(ReplaceRichText(text), <span class="string">&quot;&lt;quad.+?&gt;&quot;</span>);</span><br><span class="line"><span class="built_in">int</span> diff = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//表情富文本的长度(除表情id)</span></span><br><span class="line"><span class="built_in">int</span> richMarkLength = <span class="number">14</span>;</span><br><span class="line"><span class="comment">//上一个表情index</span></span><br><span class="line"><span class="built_in">int</span> lastEmojiIndex = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; matches.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">	EmojiInfo info;</span><br><span class="line">	Match numberMatch = Regex.Match(matches[i].Value, <span class="string">&quot;[0-9]+&quot;</span>);</span><br><span class="line">    <span class="built_in">int</span> dicIndexId = matches[i].Index - lastEmojiIndex;</span><br><span class="line">    <span class="comment">//处理连续表情标签</span></span><br><span class="line">    <span class="keyword">while</span> (emojiDic.ContainsKey(dicIndexId)) dicIndexId += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (EmojiIndex.TryGetValue(numberMatch.Value, <span class="keyword">out</span> info))</span><br><span class="line">		emojiDic.Add(dicIndexId, info);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		emojiDic.Add(dicIndexId, EmojiIndex[<span class="string">&quot;0&quot;</span>]);</span><br><span class="line">    info.len = matches[i].Length;</span><br><span class="line">    diff += info.len - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//处理多个表情，由于Unity2019去掉了富文本顶点之类信息，后续表情需要减去之前表情标签长度</span></span><br><span class="line">    lastEmojiIndex += (richMarkLength+ numberMatch.Value.Length<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-21/m_e9d161e6ad216065fb732a400cee7a62_r.png"></p><h3 id="最后一位缺失"><a href="#最后一位缺失" class="headerlink" title="最后一位缺失"></a>最后一位缺失</h3><p>最后，可能会发现最后一个表情(/文字)无法显示，关键代码如下，根据注释意思，删除减掉的4个顶点代码即可。</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Last 4 verts are always a new line...</span></span><br><span class="line"><span class="built_in">int</span> vertCount = verts.Count<span class="number">-4</span>;</span><br></pre></td></tr></table></figure><p>按照上述规则，表现看起来貌似基本上正常了。</p><h3 id="包含额外富文本修复"><a href="#包含额外富文本修复" class="headerlink" title="包含额外富文本修复"></a>包含额外富文本修复</h3><p>但是后边发现，要是插入了其它富文本的信息，又会导致变成乱码了。</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-21/m_5a74fd06cdaf1fd35da83e7e9eed5227_r.png"></p><p>原因是上述方式虽然排除了表情标签的影响，但貌似并未剔除其它富文本标签影响——说起来这个我还是后边才发觉。</p><p>为此可以在正式使用正则表达式，筛选表情标签之前，剔除富文本信息：</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MatchCollection matches = Regex.Matches(ReplaceRichText(text), <span class="string">&quot;&lt;quad.+?&gt;&quot;</span>);</span><br></pre></td></tr></table></figure><p>由于剔除也包括空格，因此这儿需要重新计算</p><p>以三个连续的表情为例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//未剔除之前长度</span><br><span class="line">&quot;&lt;quad name = 21&gt;&lt;quad name = 22&gt;&lt;quad name = 23&gt;&quot;.Length  </span><br><span class="line">48</span><br><span class="line">//剔除所有富文本数据后内容</span><br><span class="line">ReplaceRichText(text) </span><br><span class="line">&quot;&lt;quadname=21&gt;&lt;quadname=22&gt;&lt;quadname=23&gt;&quot;</span><br><span class="line">//剔除所有富文本数据后长度</span><br><span class="line">ReplaceRichText(text).Length</span><br><span class="line">39</span><br><span class="line">//一个表情标签的长度</span><br><span class="line">&quot;&lt;quadname=23&gt;&quot;.Length</span><br><span class="line">13</span><br><span class="line">//取第二位表情坐标</span><br><span class="line">&quot;&lt;quadname=21&gt;&lt;quadname=22&gt;&lt;quadname=23&gt;&quot;.IndexOf(&quot;&lt;quadname=22&gt;&quot;)</span><br><span class="line">13</span><br><span class="line">//仅表情标签，不算表情id的长度</span><br><span class="line">&quot;&lt;quadname=&gt;&quot;.Length</span><br><span class="line">11</span><br></pre></td></tr></table></figure><p>可得出修改方式：</p><ul><li>将 text 进行正则表达式搜索之前，剔除富文本数据</li><li>将 richMarkLength 字段默认值改为 11</li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MatchCollection matches = Regex.Matches(ReplaceRichText(text), <span class="string">&quot;&lt;quad.+?&gt;&quot;</span>);</span><br><span class="line"><span class="built_in">int</span> diff = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//表情富文本的长度(除表情id)</span></span><br><span class="line"><span class="built_in">int</span> richMarkLength = <span class="number">11</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改代码后，以连续三个表情为例，正常聊天频道表现正常，主界面额外聊天信息展示文本内容为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&lt;color=#ffc800&gt;【世界】&lt;/color&gt;10:&lt;quad name = 21&gt;&lt;quad name = 22&gt;&lt;quad name = 23&gt;&quot;</span><br></pre></td></tr></table></figure><p>效果：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-21/m_da92c3ca6f573d9afc4a312cc15f2b9f_r.png"></p><h2 id="文字竖行排版功能问题"><a href="#文字竖行排版功能问题" class="headerlink" title="文字竖行排版功能问题"></a>文字竖行排版功能问题</h2><p>我们项目中叫做 『VirticalText』(感觉命名也错了，不是应该 VerticalText吗？)</p><p>这份代码是通过操作 Text 旋转顶点实现竖行排版的，这份代码直接没法跑，报错了。</p><p>经过检查，发现同样是新版Unity的 UGUI 顶点数据问题导致，而且虽然 UGUI内部不存储富文本数据了，但是这里非常不可思议的是，同样从 UGUI 系统内部获取的 UILineInfo 竟然包括了换行符!</p><p>然后使用 UILineInfo 给出的数据去调用 VertexHelper PopulateUIVertex 获取文字 UIVertex 就会报下标错误。</p><p>由于 UILineInfo 数据包括了换行符，顶点数据里边却不包括，就导致了最终的取值报错——都是 UGUI 的数据，这完全整得 UGUI 自己的内部数据都不一致了，不确定是 UGUI 更新漏了，还是故意这样设计。</p><p>反正我的处理方式是，直接把老的那坨以 UILineInfo 作为数据源的方法去掉，自己写了一块直接通过字符串解析来解决。</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-21/m_11e5f18549940abf2a4ab5c75fccdd77_r.png"></p><p>首先，直接通过 『\n』 这个通用换行符进行 Split 获取文字行数，理论上跟 UILineInfo 数量一致。</p><p>然后循环修改，注意在取每一行文字的时候，同样增加筛除富文本数据判断即可。</p><p>效果如下：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/2022/2022-07-21/m_6024846ceddaf0a1df8ca1aa026afa47_r.png"></p><div class="tags-container-bottom"><i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/问题解决记录/">#问题解决记录</a></div><br><br><hr><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MsaVbSzIr9cIfikihDExdun9-gzGzoHsz",appKey:"Bj6SEFUBomrLOTWx9B8S6zQH",placeholder:"请输入评论内容~",avatar:"mp",visitor:!1})</script></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l site-author"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/photo.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="CWHISME"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">悲观主义的末日</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>分类</h3><p><a href="/categories/Unity3D/">Unity3D</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>近期文章</h3><p><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/">协变和逆变</a></p><p><a href="/2022/12/06/Unity%E7%9A%84%E9%98%B4%E5%BD%B1%E4%B8%8E%E5%85%89%E7%85%A7%E7%83%98%E7%84%99/">Unity 的阴影与光照烘焙</a></p><p><a href="/2022/11/23/%E6%89%93%E5%8C%85AssetBundle%E5%9F%BA%E7%A1%80%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86/">打包 AssetBundle 的基础规则整理</a></p><p><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/">StringBuilder 扩容规则研究</a></p><p><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">简单测试手动垃圾回收</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/CWHISME" target="_blank"><i class="fa fa-github"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="mailto:cwhisme@126.com" target="_blank"><i class="fa fa-envelope"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">Copyright © 2021 | Design & Hexo <a class="link dim white" target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-anodyne/">Jonathan Klughertz</a> | Modify By CWHISME</div></div></div></body></html>