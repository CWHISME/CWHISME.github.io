<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="WangJiaYing" href="https://wangjiaying.top/rss.xml"><link rel="alternate" type="application/atom+xml" title="WangJiaYing" href="https://wangjiaying.top/atom.xml"><link rel="alternate" type="application/json" title="WangJiaYing" href="https://wangjiaying.top/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="性能优化,C#"><link rel="canonical" href="https://wangjiaying.top/2022/10/31/%E5%85%B3%E4%BA%8E%E5%AF%B9%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E7%9A%84%E4%BC%98%E5%8C%96/"><title>关于对项目字符串拼接的优化研究 - 理论研究 | Jiaying's Note = WangJiaYing = 人不能没有梦想，也要有足够的敬畏</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">关于对项目字符串拼接的优化研究</h1><div class="meta"><span class="item" title="创建时间：2022-10-31 10:17:26"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-10-31T10:17:26+08:00">2022-10-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>22k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>20 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Jiaying's Note</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="/images/coverimages/large/6833939bly1giclfdu6exj20zk0m87hw.webp"></li><li class="item" data-background-image="/images/coverimages/large/61621237_p0.webp"></li><li class="item" data-background-image="/images/coverimages/large/6833939bly1gicli9lfebj20zk0m84qp.webp"></li><li class="item" data-background-image="/images/coverimages/large/6833939bly1giclhpw3lwj20zk0m8gvw.webp"></li><li class="item" data-background-image="/images/coverimages/large/80228475_p0.webp"></li><li class="item" data-background-image="/images/coverimages/large/79834784_p0.webp"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E7%90%86%E8%AE%BA%E7%A0%94%E7%A9%B6/" itemprop="item" rel="index" title="分类于 理论研究"><span itemprop="name">理论研究</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://wangjiaying.top/2022/10/31/%E5%85%B3%E4%BA%8E%E5%AF%B9%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E7%9A%84%E4%BC%98%E5%8C%96/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/../img/avator"><meta itemprop="name" content="CWHISME"><meta itemprop="description" content="人不能没有梦想，也要有足够的敬畏, ✧⁺˚⁺ପ(๑･ω･)੭ु⁾⁾ 好好学习天天向上"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="WangJiaYing"></span><div class="body md" itemprop="articleBody"><h2 id="1-前言"><a class="anchor" href="#1-前言">#</a> 1. 前言</h2><p>在对组员代码进行审查时，经常碰到看着很不合理的字符串拼接操作，特别是对数组数据操作，也直接一个 for 循环，使用 + 号进行。</p><p>甚至有时候还是直接以 Text 作为主体，例如：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> soldierData<span class="token punctuation">.</span>Skills<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	m_soldiersDesc<span class="token punctuation">.</span>text <span class="token operator">+=</span> soldierData<span class="token punctuation">.</span>Skills<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">GetLvDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个地方，首先 m_soldiersDesc.text 是一个主体，『+=』操作相当于 取值 + 字符串拼接 + 赋值 + 重构 Text 数据，还是在循环中进行 —— 有多费就不用多说了。</p><p>再次对组员进行强调：使用对应指定方式拼接字符串。</p><p>项目中其实已有公共的采取 StringBuilder 拼接相关方法，例如：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/// 組合数组</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toString</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> split <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token class-name">StringBuilder</span> sbd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> sbd<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>Count <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">?</span> split <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">return</span> sbd<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>注：虽然该方法是已有的，但是使用的不多 (而且该方法使用 StringBuilder 方式也不大好，例如调用了 StringBuilder Append 还在用 + 号拼接小的)，大多都是在搞自我拼接。</p><p>所以虽然要求大家使用项目自定义的字符串拼接相关扩展方法，不过这边这块恐怕需要进行优化一下。</p><h2 id="2-第一版优化"><a class="anchor" href="#2-第一版优化">#</a> 2. 第一版优化</h2><p>为此我在这个基础上增加了一份扩展，优化主要有两点：使用 StringBuilder 拼接，且对其进行缓存，每次回收利用。</p><p>主要代码如下：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">StringBuilder</span> _stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token keyword">int</span></span> _stringCacheLength<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token keyword">int</span></span> _stringCacheTopIndex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">/// 将数组组合为字符串</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toString</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> split <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        _stringBuilder<span class="token punctuation">.</span>Length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        _stringCacheLength <span class="token operator">=</span> list<span class="token punctuation">.</span>Count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        _stringCacheTopIndex <span class="token operator">=</span> _stringCacheLength <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _stringCacheLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> _stringCacheTopIndex<span class="token punctuation">)</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/// 将列表组合为字符串</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toString</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name">RCallback<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> T<span class="token punctuation">></span></span> getStr<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> split <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        _stringBuilder<span class="token punctuation">.</span>Length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        _stringCacheLength <span class="token operator">=</span> list<span class="token punctuation">.</span>Count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        _stringCacheTopIndex <span class="token operator">=</span> _stringCacheLength <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _stringCacheLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">getStr</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> _stringCacheTopIndex<span class="token punctuation">)</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">return</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">/// 将字典组合为字符串</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toString</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span> dic<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> split <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dic<span class="token punctuation">.</span>Count <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        _stringBuilder<span class="token punctuation">.</span>Length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> dic<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>getStrCallback <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token keyword">else</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">getStrCallback</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> item<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        _stringBuilder<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>_stringBuilder<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">return</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">/// 将数组组合为字符串，换行分割</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toStringLine</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> arr<span class="token punctuation">,</span> <span class="token class-name">RCallback<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> T<span class="token punctuation">></span></span> getStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">,</span> getStrCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token comment">/// 将列表组合为字符串，换行分割</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toStringLine</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name">RCallback<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> T<span class="token punctuation">></span></span> getStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">,</span> getStrCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token comment">/// 将字典组合为字符串，换行分割</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toStringLine</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span> dic<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">return</span> dic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">,</span> getStrCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>主要提供有两种处理方式：一种直接将数组每个数据拼接，另一种会经过回调处理后再拼接。<br>并支持数组、列表、字典三个常用数据结构内容的拼接。</p><p>这里只使用一份 StringBuilder 缓存，是因为考虑到游戏中单线程模式即用就即时返回结果了，没有必要采用对象池模式去缓存多个。</p><h2 id="3-性能测试与优化"><a class="anchor" href="#3-性能测试与优化">#</a> 3. 性能测试与优化</h2><h3 id="四种拼接方式性能测试"><a class="anchor" href="#四种拼接方式性能测试">#</a> 四种拼接方式性能测试</h3><p>对于性能测试，这里首先以 100000 个放置于一个数组中的随机字符串的拼接为例，分别采用 + 号拼接、string.Join、自定义 StringBuilder、带回调自定义 StringBuilder 四种方式，测试其消耗时长：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> TestCount <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 纯字符串数组</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> _strArray<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// 初始化测试数据</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        _strArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span></span><span class="token punctuation">[</span>TestCount<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TestCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            _strArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">GetRandomStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 测试数据填充完毕</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">//==========</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">Stopwatch</span> stopwatch <span class="token operator">=</span> Stopwatch<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">//1. 测试直接拼接数组</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name"><span class="token keyword">string</span></span> finalStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _strArray<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            finalStr <span class="token operator">+=</span> <span class="token string">","</span> <span class="token operator">+</span> _strArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>finalStr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"直接拼接数组：&#123;0&#125;"</span><span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span>Elapsed<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">//2. 测试内部函数 join 拼接数组</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        finalStr <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> _strArray<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>finalStr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"string.Join 拼接数组：&#123;0&#125;"</span><span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span>Elapsed<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">//3. 测试自定义函数拼接数组</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        finalStr <span class="token operator">=</span> _strArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>finalStr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接数组：&#123;0&#125;"</span><span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span>Elapsed<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">//4. 测试带回调自定义函数拼接数组</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        finalStr <span class="token operator">=</span> _strArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> str <span class="token operator">=></span> str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>finalStr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"带回调自定义函数拼接数组：&#123;0&#125;"</span><span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span>Elapsed<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">/// 返回一个随机值字符串</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetRandomStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Intern</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/blogimages/2022/2022-10-31/m_58a128e53038c421467e1deabe1943b5_r.png" alt=""></p><p>如上图所示，可以看见直接使用 + 号进行拼接的方式，相比另外几种方式其消耗时间可以说是一骑绝尘：可以确定内部基本上没有什么优化的。</p><p>严格来说，上述测试方式并不准确，不过这里主要是因为 + 号拼接太过于消耗时间，数据大了电脑跑不动。因此我就仅执行一次大批量测试了 —— 确定这方式真可以丢一边了。</p><h3 id="平均性能测试"><a class="anchor" href="#平均性能测试">#</a> 平均性能测试</h3><p>接下来，剔除 + 号拼接方式，对比余下方式去取平均消耗时间。</p><p>join、concat、自定义函数、带回调自定义函数分别执行 100 次，取平均时间。<br>除此之外，增加对 列表、字典、类类型结构测试。</p><p>测试代码：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">StrClass</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> _desStr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token function">StrClass</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> str<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        _desStr <span class="token operator">=</span> str<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetDes</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> _desStr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// 数据长度</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> TestValueCount <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// 每一轮测试次数，取平均消耗时间</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> TestNum <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// 保存一下结果</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> _logPath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">// 纯字符串数组</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> _strArray<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">// 纯字符串列表</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> _strList<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">// 字典</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> _strDic<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">// 返回字符串的类结构</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">StrClass<span class="token punctuation">[</span><span class="token punctuation">]</span></span> _strClassArray<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">// 初始化测试数据</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    _strArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span></span><span class="token punctuation">[</span>TestValueCount<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    _strList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>TestValueCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    _strClassArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StrClass</span><span class="token punctuation">[</span>TestValueCount<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    _strDic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>TestValueCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TestValueCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        _strArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">GetRandomStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        _strList<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">GetRandomStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        _strClassArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StrClass</span><span class="token punctuation">(</span><span class="token function">GetRandomStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        _strDic<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">GetRandomStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">// 测试数据填充完毕</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">//==========</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">//Stopwatch stopwatch = Stopwatch.StartNew();</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">//1. 测试直接拼接数组</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">//stopwatch.Start();</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">//string finalStr = "";</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token comment">//for (int i = 0; i &lt; _strArray.Length; i++)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">//&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">//    finalStr += "," + _strArray[i];</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">//&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">//stopwatch.Stop();</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">//UnityEngine.Debug.Log(finalStr);</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token comment">//UnityEngine.Debug.LogWarning (string.Format ("直接拼接数组：&#123;0&#125;", stopwatch.Elapsed.ToString ()));</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token comment">// 清空日志</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    _logPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>Application<span class="token punctuation">.</span>dataPath<span class="token punctuation">,</span> <span class="token string">"TestLog.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    File<span class="token punctuation">.</span><span class="token function">WriteAllText</span><span class="token punctuation">(</span>_logPath<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token comment">// 测试内部函数 concat 拼接数组</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"string.concat 拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Concat</span><span class="token punctuation">(</span>_strArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token comment">//2. 测试内部函数 join 拼接数组</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"string.Join 拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> _strArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token comment">//3. 测试自定义函数拼接数组</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">//4. 测试带回调自定义函数拼接数组</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"带回调自定义函数拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> str <span class="token operator">=></span> str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token comment">//5. 测试 join 函数拼接列表</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"string.Join 拼接列表"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strList<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">//6. 测试自定义函数拼接列表</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接列表"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strList<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">//7. 测试带回调自定义函数拼接列表</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"带回调自定义函数拼接列表"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strList<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token comment">//8. 测试自定义函数拼接类类型</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接类类型"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strClassArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> data <span class="token operator">=></span> data<span class="token punctuation">.</span><span class="token function">GetDes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token comment">//9. 测试自定义函数拼接字典</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接字典"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">//10. 测试自定义函数拼接字典</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接字典(带回调操作)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">=></span> k <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token comment">/// 执行一轮对 callback 运行测试</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">,</span> <span class="token class-name">Action</span> callback<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token class-name">Stopwatch</span> stopwatch <span class="token operator">=</span> Stopwatch<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token class-name"><span class="token keyword">long</span></span> totalTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TestNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        totalTime <span class="token operator">+=</span> stopwatch<span class="token punctuation">.</span>ElapsedTicks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token class-name">TimeSpan</span> span <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TimeSpan</span><span class="token punctuation">(</span>totalTime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token class-name"><span class="token keyword">string</span></span> log <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"* &#123;0&#125;：&#123;1&#125;秒&#123;2&#125;毫秒\n"</span><span class="token punctuation">,</span> title<span class="token punctuation">,</span> span<span class="token punctuation">.</span>Seconds<span class="token punctuation">,</span> span<span class="token punctuation">.</span>Milliseconds<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    File<span class="token punctuation">.</span><span class="token function">AppendAllText</span><span class="token punctuation">(</span>_logPath<span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token comment">/// 返回一个随机值字符串</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetRandomStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Intern</span><span class="token punctuation">(</span>UnityEngine<span class="token punctuation">.</span>Random<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>结果如下：</p><ul><li>string.concat 拼接数组：00:00:00.0099083</li><li>string.Join 拼接数组：00:00:00.0132115</li><li>自定义函数拼接数组：00:00:00.0179701</li><li>带回调自定义函数拼接数组：00:00:00.0175816</li><li>string.Join 拼接列表：00:00:00.0184016</li><li>自定义函数拼接列表：00:00:00.0185559</li><li>带回调自定义函数拼接列表：00:00:00.0180418</li><li>自定义函数拼接类类型：00:00:00.1013892</li><li>自定义函数拼接字典：00:00:00.0224806</li><li>自定义函数拼接字典 (带回调操作)：00:00:00.0983786</li></ul><p>有点奇怪的是，在数组结构上，带回调自定义函数时间消耗反而比不带回调的低一点？</p><p>所以可以确定一下性能排序分别为：</p><blockquote><p>string.concat-&gt;string.Join-&gt;StringBuilder 自定义拼接 -&gt;+ 号拼接</p></blockquote><p>(其中 concat 之所以性能更高，除了因为少了一位『分隔符』的插入，看源码似乎还利用了创建一个最终大小字符串，通过内存拷贝方式复制进去实现)</p><p>这么看起来，还是内置拼接函数性能比较高。</p><p>不过 concat、Join 的局限性在于：只能用于数组类型，且只处理字符串 —— 如果对象不是字符串，则直接通过 ToString 强转为字符串进行拼接。(要是有某个非字符串数组类型对象重载过 ToString 输出正确值也不是不能用)</p><h2 id="4-第二版优化"><a class="anchor" href="#4-第二版优化">#</a> 4. 第二版优化</h2><p>经过测试之后，大概性能也有点数了。</p><p>于是就有一些新的想法：例如无回调需求时使用 join 拼接、分隔符为空则采用 concat 拼接 —— 虽然会增加一点判断，但是性能该是可以提升一点的。</p><p>另外在目前自定义扩展函数的使用方式上，感觉也还有点缺点：比如字典类型，如果别人想把 k、v 结构也拼接在一块，那么这里就不大好办了，让调用者在回调方法用 + 号拼接一次？这样可就又冗余了。所以最好也提供一个重载使其作为可选项。</p><p>最终形成以下方法：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">StringBuilder</span> _stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token keyword">int</span></span> _stringCacheLength<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token keyword">int</span></span> _stringCacheTopIndex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">/// 将数组组合为字符串</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toString</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> arr<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> separator <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>separator<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> getStrCallback <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Concat</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">//if (getStrCallback == null) return string.Join(separator, arr);</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> arr<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        _stringBuilder<span class="token punctuation">.</span>Length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        _stringCacheLength <span class="token operator">=</span> arr<span class="token punctuation">.</span>Length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        _stringCacheTopIndex <span class="token operator">=</span> _stringCacheLength <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _stringCacheLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">CheckDeliverValue</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> getStrCallback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> _stringCacheTopIndex<span class="token punctuation">)</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">/// 将列表组合为字符串</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toString</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> separator <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>separator<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> getStrCallback <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Concat</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">//if (getStrCallback == null) return string.Join(separator, list);</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        _stringBuilder<span class="token punctuation">.</span>Length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        _stringCacheLength <span class="token operator">=</span> list<span class="token punctuation">.</span>Count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        _stringCacheTopIndex <span class="token operator">=</span> _stringCacheLength <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _stringCacheLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">CheckDeliverValue</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> getStrCallback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> _stringCacheTopIndex<span class="token punctuation">)</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">return</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">/// 将字典的所有 value 组合为字符串，忽略字典的 Key 值</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">/// &lt;param name="separator"> 分隔符 & lt;/param></span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">/// &lt;param name="getValueStrCallback"> 如果 value 转化为字符串需要其它接口，可使用回调返回调用后的值 & lt;/param></span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token comment">/// &lt;returns>value,value,value,value,value......&lt;/returns></span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toString</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span> dic<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> separator <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>V<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getValueStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">toString</span><span class="token punctuation">(</span>dic<span class="token punctuation">,</span> separator<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> getValueStrCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">/// 将字典 key 和 value 成对组合为字符串，需要传入对应的分隔符</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">/// &lt;param name="separator"> 每个对象之间分割符 & lt;/param></span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">/// &lt;param name="separatorKV">key 和 value 分隔符，传入空值拼接时将忽略 key 值 & lt;/param></span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">/// &lt;param name="getKeyStrCallback"> 如果 key 转化为字符串需要其它接口，可使用回调返回调用后的值 & lt;/param></span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token comment">/// &lt;param name="getValueStrCallback"> 如果 value 转化为字符串需要其它接口，可使用回调返回调用后的值 & lt;/param></span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">/// &lt;returns > 默认：key:value,key:value,key:value......&lt;/returns></span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toString</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span> dic<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> separator<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> separatorKV<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getKeyStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>V<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getValueStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dic <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> dic<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        _stringBuilder<span class="token punctuation">.</span>Length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token comment">//kv 分隔符为空，则当做表示不拼接 key</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token class-name"><span class="token keyword">bool</span></span> appendKey <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>separatorKV<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> dic<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token comment">// 附加字典 key</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendKey<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">CheckDeliverValue</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> getKeyStrCallback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>separatorKV<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token comment">// 附加字典值</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">CheckDeliverValue</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> getValueStrCallback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token comment">// 分隔符</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            _stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        _stringBuilder<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>_stringBuilder<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token keyword">return</span> _stringBuilder<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token comment">/// 将数组组合为字符串，换行分割</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toStringLine</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> arr<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">,</span> getStrCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token comment">/// 将列表组合为字符串，换行分割</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toStringLine</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">,</span> getStrCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token comment">/// 将字典组合为字符串，换行分割 (忽略 key 值)</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">toStringLine</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>K<span class="token punctuation">,</span> V<span class="token punctuation">></span></span> dic<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>V<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getStrCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token keyword">return</span> dic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">,</span> getStrCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token comment">/// &lt;summary></span></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token comment">/// 检查是否对值进行回调处理（若 getValueStrCallback 不为空则返回调用后结果，参数为 value）</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token comment">/// &lt;/summary></span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">CheckDeliverValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> <span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> getValueStrCallback<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>getValueStrCallback <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">value</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">getValueStrCallback</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="性能测试"><a class="anchor" href="#性能测试">#</a> 性能测试：</h4><p>依然是 100000 个随机字符串，循环一百次拼接。</p><p>测试代码：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 测试内部函数 concat 拼接数组</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"string.concat 拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Concat</span><span class="token punctuation">(</span>_strArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//2. 测试内部函数 join 拼接数组</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"string.Join 拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> _strArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//3. 测试自定义函数拼接数组</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//4. 测试带回调自定义函数拼接数组</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"带回调自定义函数拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> str <span class="token operator">=></span> str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">//5. 测试 join 函数拼接列表</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"string.Join 拼接列表"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strList<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">//6. 测试自定义函数拼接列表</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接列表"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strList<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">//7. 测试带回调自定义函数拼接列表</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"带回调自定义函数拼接列表"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strList<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//8. 测试自定义函数拼接类类型</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接类类型"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strClassArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> data <span class="token operator">=></span> data<span class="token punctuation">.</span><span class="token function">GetDes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">//9. 测试自定义函数拼接字典</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"自定义函数拼接字典"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">//10. 测试自定义函数拼接字典</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">//DoTest ("自定义函数拼接字典 (带回调操作)", () => _strDic.toString (",");</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"string.concat 拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Concat</span><span class="token punctuation">(</span>_strArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"string.join 拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> _strArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接数组(无分隔符)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接数组"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接数组(带回调)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strArray<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> str <span class="token operator">=></span> str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接字典 Value"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接字典(带 Value 回调)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> v <span class="token operator">=></span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接字典 K、V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接字典 K、V(带 Key 回调)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">,</span> k <span class="token operator">=></span> k<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接字典 K、V(带 Key、Value 回调)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">,</span> k <span class="token operator">=></span> k<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v <span class="token operator">=></span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接字典(字典转数组拼接)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token function">DoTest</span><span class="token punctuation">(</span><span class="token string">"拼接字典(字典转列表拼接)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _strDic<span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul><li>string.concat 拼接数组：0 秒 937 毫秒</li><li>string.Join 拼接数组：1 秒 282 毫秒</li><li>自定义函数拼接数组：1 秒 837 毫秒</li><li>带回调自定义函数拼接数组：1 秒 809 毫秒</li><li>string.Join 拼接列表：1 秒 858 毫秒</li><li>自定义函数拼接列表：1 秒 916 毫秒</li><li>带回调自定义函数拼接列表：1 秒 847 毫秒</li><li>自定义函数拼接类类型：10 秒 400 毫秒</li><li>自定义函数拼接类类型 (GetDes () 无计算)：1 秒 870 毫秒</li><li>自定义函数拼接字典：2 秒 316 毫秒</li><li>string.concat 拼接数组：0 秒 910 毫秒</li><li>string.join 拼接数组：1 秒 253 毫秒</li><li>拼接数组 (无分隔符)：1 秒 638 毫秒</li><li>拼接数组：1 秒 764 毫秒</li><li>拼接数组 (带回调)：1 秒 794 毫秒</li><li>拼接字典 Value：2 秒 332 毫秒</li><li>拼接字典 (带 Value 回调)：2 秒 356 毫秒</li><li>拼接字典 K、V：8 秒 121 毫秒</li><li>拼接字典 K、V (带 Key 回调)：8 秒 111 毫秒</li><li>拼接字典 K、V (带 Key、Value 回调)：8 秒 335 毫秒</li><li>拼接字典 (字典转数组拼接)：14 秒 391 毫秒</li><li>拼接字典 (字典转列表拼接)：15 秒 655 毫秒</li></ul><p>(低版本 C# 的 string.concat、string.Join 连列表都不支持，甚至只能用在字符串数组上，所以上边说检测到对应情况 (没有分隔符或纯字符串数组) 后执行系统拼接函数只能在高版本下使用)</p><blockquote><p>[concat 由于低版本 C# 不支持除纯字符串数组之外的对象且有 object 重载，泛型数组也是可以直接丢进去的，然而直接当做 object.ToString 返回了，测试时发现消耗时间短得不可思议，仔细看才发现不对，例如上述『拼接列表 (无分隔符)』就是走进这个分支判断的情况，只能先注释掉]</p></blockquote><h2 id="5-stringbuilder-源码"><a class="anchor" href="#5-stringbuilder-源码">#</a> 5. StringBuilder 源码</h2><p>另外稍微看了下源码，StringBuilder 默认初始化 16 个字符大小的数组：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Token: 0x060065BB RID: 26043 RVA: 0x00155704 File Offset: 0x00153904</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>__DynamicallyInvokable<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// Token: 0x060065BC RID: 26044 RVA: 0x0015570E File Offset: 0x0015390E</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>__DynamicallyInvokable<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> capacity<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// Token: 0x060065D7 RID: 26071 RVA: 0x001561B8 File Offset: 0x001543B8</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span><span class="token function">ComVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">__DynamicallyInvokable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">public</span> <span class="token return-type class-name">StringBuilder</span> <span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> <span class="token keyword">value</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>容量足够的情况下，通过 unsafe 方法进行指针及直接内存操作：</p><ol><li>获取添加的字符串指针</li><li>获取字符数组待添加下标指针</li><li>调用 Buffer.Memcpy 进行内存拷贝进字符数组</li></ol><p>如果后续容量不够，则进行动态扩容：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Token: 0x060065D1 RID: 26065 RVA: 0x0015603C File Offset: 0x0015423C</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>SecuritySafeCritical<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">__DynamicallyInvokable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name">StringBuilder</span> <span class="token function">Append</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> <span class="token keyword">value</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name"><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> chunkChars <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>m_ChunkChars<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name"><span class="token keyword">int</span></span> chunkLength <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>m_ChunkLength<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name"><span class="token keyword">int</span></span> length <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">.</span>Length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name"><span class="token keyword">int</span></span> num <span class="token operator">=</span> chunkLength <span class="token operator">+</span> length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;</span> chunkChars<span class="token punctuation">.</span>Length<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token comment">// 容量足够</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>			<span class="token comment">// 走扩容</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">AppendHelper</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>不过动态扩容不是直接扩容字符数组，而是通过单向链表的方式：</p><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Token: 0x06006615 RID: 26133 RVA: 0x0015730C File Offset: 0x0015550C</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ExpandByABlock</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> minBlockCharCount<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>minBlockCharCount <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> minBlockCharCount <span class="token operator">||</span> minBlockCharCount <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Length <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>m_MaxCapacity<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentOutOfRangeException</span><span class="token punctuation">(</span><span class="token string">"requiredLength"</span><span class="token punctuation">,</span> Environment<span class="token punctuation">.</span><span class="token function">GetResourceString</span><span class="token punctuation">(</span><span class="token string">"ArgumentOutOfRange_SmallCapacity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name"><span class="token keyword">int</span></span> num <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">Max</span><span class="token punctuation">(</span>minBlockCharCount<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">Min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>m_ChunkPrevious <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>m_ChunkOffset <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>m_ChunkLength<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>m_ChunkLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>m_ChunkOffset <span class="token operator">+</span> num <span class="token operator">&lt;</span> num<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>m_ChunkChars <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OutOfMemoryException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>m_ChunkChars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">char</span></span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>将当前数据全部转移至『上一个』节点，然后自己创建一个新的字符数组进行处理。</p><p>除 StringBuilder 本身外，string 类提供的一些静态操作方法也再次利用 StringBuilder 对性能进行优化，如 join、format 底层都会调到那边去，还采用了 StringBuilderCache 对象池。</p><h2 id="6-join-部分源码"><a class="anchor" href="#6-join-部分源码">#</a> 6. Join 部分源码</h2><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Token: 0x060004B8 RID: 1208 RVA: 0x00010B4C File Offset: 0x0000ED4C</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>SecuritySafeCritical<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">__DynamicallyInvokable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">unsafe</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Join</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> separator<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> startIndex<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token comment">//======= 省略判断 ================</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 字符串类型数组，直接通过分配一大块字符串内存，通过 unsafe 内存拷贝实现</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name"><span class="token keyword">string</span></span> text <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">FastAllocateString</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">fixed</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>text<span class="token punctuation">.</span>m_firstChar<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">UnSafeCharBuffer</span> unSafeCharBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UnSafeCharBuffer</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        unSafeCharBuffer<span class="token punctuation">.</span><span class="token function">AppendString</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">[</span>startIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> j <span class="token operator">=</span> startIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> num2<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            unSafeCharBuffer<span class="token punctuation">.</span><span class="token function">AppendString</span><span class="token punctuation">(</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            unSafeCharBuffer<span class="token punctuation">.</span><span class="token function">AppendString</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> text<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// 连接迭代器 (列表类型) 通过 StringBuilder 进行</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">// Token: 0x060004B5 RID: 1205 RVA: 0x000109C4 File Offset: 0x0000EBC4</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">[</span><span class="token function">ComVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">__DynamicallyInvokable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token generic-method"><span class="token function">Join</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> separator<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> values<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token comment">// 省略部分处理代码</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	result <span class="token operator">=</span> StringBuilderCache<span class="token punctuation">.</span><span class="token function">GetStringAndRelease</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">// 连接 object 数组类型，通过 StringBuilderCache 对象池取 StringBuilder 进行拼接</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">// Token: 0x060004B4 RID: 1204 RVA: 0x0001093C File Offset: 0x0000EB3C</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">[</span><span class="token function">ComVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">__DynamicallyInvokable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Join</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> separator<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> values<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>	<span class="token comment">// 省略</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">return</span> StringBuilderCache<span class="token punctuation">.</span><span class="token function">GetStringAndRelease</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="7-stringconcat"><a class="anchor" href="#7-stringconcat">#</a> 7. string.Concat</h2><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 当连接数量级比较低时，参数为 string 则直接通过创建最终字符串内存连接</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// Token: 0x06000556 RID: 1366 RVA: 0x00013524 File Offset: 0x00011724</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>SecuritySafeCritical<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">__DynamicallyInvokable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Concat</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> str0<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> str1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 部分判断代码省略 ===============</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token class-name"><span class="token keyword">int</span></span> length <span class="token operator">=</span> str0<span class="token punctuation">.</span>Length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token class-name"><span class="token keyword">string</span></span> text <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">FastAllocateString</span><span class="token punctuation">(</span>length <span class="token operator">+</span> str1<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">FillStringChecked</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> str0<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">FillStringChecked</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> length<span class="token punctuation">,</span> str1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">return</span> text<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// 连接迭代器 (列表类型) 通过 StringBuilder 进行</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// Token: 0x06000555 RID: 1365 RVA: 0x000134B8 File Offset: 0x000116B8</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span><span class="token function">ComVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">__DynamicallyInvokable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Concat</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> values<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token comment">// 省略</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">return</span> StringBuilderCache<span class="token punctuation">.</span><span class="token function">GetStringAndRelease</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">// 当连接数量级比较低时，参数为 object 则直接通过符号连接</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">// Token: 0x06000551 RID: 1361 RVA: 0x00013330 File Offset: 0x00011530</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>__DynamicallyInvokable<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Concat</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> arg0<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> arg1<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> arg2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token comment">// 判断省略 ==========</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">return</span> arg0<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> arg1<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> arg2<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">//ConcatArray (当 string.Concat 超过三个 object 对象时调用)</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">// 超出这个数量则通过内存分配进行</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">// Token: 0x06000559 RID: 1369 RVA: 0x000136AC File Offset: 0x000118AC</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">[</span>SecuritySafeCritical<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ConcatArray</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> values<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> totalLength<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token class-name"><span class="token keyword">string</span></span> text <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">FastAllocateString</span><span class="token punctuation">(</span>totalLength<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token class-name"><span class="token keyword">int</span></span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">FillStringChecked</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> num<span class="token punctuation">,</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        num <span class="token operator">+=</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">return</span> text<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>直接分配指定字符串数组所有字符串长度大小的大块字符串，然后通过 wstrcpy-&gt;Buffer.Memcpy 对内存直接进行拷贝操作。</p><h2 id="8-format"><a class="anchor" href="#8-format">#</a> 8. Format</h2><figure class="highlight cs"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">FormatHelper</span><span class="token punctuation">(</span><span class="token class-name">IFormatProvider</span> provider<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> format<span class="token punctuation">,</span> <span class="token class-name">ParamsArray</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>format <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">"format"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> StringBuilderCache<span class="token punctuation">.</span><span class="token function">GetStringAndRelease</span><span class="token punctuation">(</span>StringBuilderCache<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span>format<span class="token punctuation">.</span>Length <span class="token operator">+</span> args<span class="token punctuation">.</span>Length <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AppendFormatHelper</span><span class="token punctuation">(</span>provider<span class="token punctuation">,</span> format<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="对-stringformat-与普通拼接的性能测试"><a class="anchor" href="#对-stringformat-与普通拼接的性能测试">#</a> 对 string.Format 与普通拼接的性能测试</h3><p>除了对数组一类数据结构类型的拼接之外，常用的估计就 2~3 个带参数的简单字符串拼接了。</p><p>这种通常见到的还是直接 + 号进行，也有使用 string.Format 的。</p><p>为了评估以后究竟以使用哪种方式为准，我想再加一点测试，测一测使用 + 号与 string.Format 拼接简单字符串两者的性能。</p><p>每一项进行 10000 次操作，测试结果如下：</p><ul><li>简单拼接测试（X+1）：0 秒 3 毫秒</li><li>简单拼接测试（1+X）：0 秒 3 毫秒</li><li>简单拼接测试（X+1+Y）：0 秒 4 毫秒</li><li>简单拼接测试（X+1+Y+2）：0 秒 6 毫秒</li><li>简单拼接测试（X+1+Y+2+Z+3）：0 秒 11 毫秒</li><li>简单拼接测试（X+1+Y+2+Z+3+W+4）：0 秒 14 毫秒</li><li>string.concat（X+1）：0 秒 3 毫秒</li><li>string.concat（1+X）：0 秒 3 毫秒</li><li>string.concat（X+1+Y）：0 秒 4 毫秒</li><li>string.concat（X+1+Y+2）：0 秒 6 毫秒</li><li>string.concat（X+1+Y+2+Z+3）：0 秒 26 毫秒</li><li>string.concat（X+1+Y+2+Z+3+W+4）：0 秒 14 毫秒</li><li>string.format 拼接测试（X {0}）：0 秒 7 毫秒</li><li>string.format 拼接测试（{0} X）：0 秒 7 毫秒</li><li>string.format 拼接测试（X {0} Y）：0 秒 7 毫秒</li><li>string.format 拼接测试（X {0} Y {1}）：0 秒 11 毫秒</li><li>string.format 拼接测试（X {0} Y {1} Z {2}）：0 秒 16 毫秒</li><li>string.format 拼接测试（X {0} Y {1} Z {2} W {3}）：0 秒 35 毫秒</li><li>StringBuilder 拼接测试（X+1）：0 秒 4 毫秒</li><li>StringBuilder 拼接测试（1+X）：0 秒 4 毫秒</li><li>StringBuilder 拼接测试（X+1+Y）：0 秒 5 毫秒</li><li>StringBuilder 拼接测试（X+1+Y+2）：0 秒 8 毫秒</li><li>StringBuilder 拼接测试（X+1+Y+2+Z+3）：0 秒 11 毫秒</li><li>StringBuilder 拼接测试（X+1+Y+2+Z+3+W+4）：0 秒 14 毫秒</li></ul><p>每一项进行 100000 次操作，去除随机参数，测试结果如下：</p><ul><li>简单拼接测试（X+1）：0 秒 16 毫秒</li><li>简单拼接测试（1+X）：0 秒 15 毫秒</li><li>简单拼接测试（X+1+Y）：0 秒 20 毫秒</li><li>简单拼接测试（X+1+Y+2）：0 秒 25 毫秒</li><li>简单拼接测试（X+1+Y+2+Z+3）：0 秒 66 毫秒</li><li>简单拼接测试（X+1+Y+2+Z+3+W+4）：0 秒 77 毫秒</li><li>string.concat（X+1）：0 秒 17 毫秒</li><li>string.concat（1+X）：0 秒 16 毫秒</li><li>string.concat（X+1+Y）：0 秒 35 毫秒</li><li>string.concat（X+1+Y+2）：0 秒 24 毫秒</li><li>string.concat（X+1+Y+2+Z+3）：0 秒 65 毫秒</li><li>string.concat（X+1+Y+2+Z+3+W+4）：0 秒 64 毫秒</li><li>string.format 拼接测试（X {0}）：0 秒 60 毫秒</li><li>string.format 拼接测试（{0} X）：0 秒 66 毫秒</li><li>string.format 拼接测试（X {0} Y）：0 秒 68 毫秒</li><li>string.format 拼接测试（X {0} Y {1}）：0 秒 71 毫秒</li><li>string.format 拼接测试（X {0} Y {1} Z {2}）：0 秒 106 毫秒</li><li>string.format 拼接测试（X {0} Y {1} Z {2} W {3}）：0 秒 145 毫秒</li><li>StringBuilder 拼接测试（X+1）：0 秒 28 毫秒</li><li>StringBuilder 拼接测试（1+X）：0 秒 27 毫秒</li><li>StringBuilder 拼接测试（X+1+Y）：0 秒 33 毫秒</li><li>StringBuilder 拼接测试（X+1+Y+2）：0 秒 38 毫秒</li><li>StringBuilder 拼接测试（X+1+Y+2+Z+3）：0 秒 67 毫秒</li><li>StringBuilder 拼接测试（X+1+Y+2+Z+3+W+4）：0 秒 62 毫秒</li></ul><p>结果非常出乎意料，原以为 string.format 性能应该是比较好的，没成想竟然是最费的... 也许由于字符串内部占位符需要单独做解析，导致了大量消耗？</p><p>于是看了下源码，发现在 AppendFormatHelper 方法中，对整个字符串都做了一次遍历，去分析是否有 {} 这种占位符，这个确实是个会随字符串量级增加而增加消耗的一个操作 ——string.format 对于连接字符串存在多个参数的情况下，耗费时间也同样会随着参数增长而增加。</p><p>因此除了字符串数组类型拼接方法外，可以自己专门定义一个方法用于连接『散』字符串，以选择性能更好的拼接方式。</p><h2 id="总结"><a class="anchor" href="#总结">#</a> 总结</h2><p>根据上面的测试 —— 虽然这种测试不一定很准确 (毕竟 Unity 中 .Net 版本比较低)，以及对 string 源码本身的查看，基本上可以总结以下几个注意点：</p><p>连接纯字符串超过 3 个时，有分隔符可以选择 StringBuilder、string.join (数组)，否则使用 string.concat (数组)，至于 string.format—— 除了好看一点，能不用就不要用了，性能上完全没有优势。</p><p>其中 string.concat 及 string.join 的源码显示，其对不同类型选择了不同的处理方式。</p><p>共同点有：</p><ul><li>字符串类型数组，直接通过分配一大块字符串内存，通过 unsafe 内存拷贝实现</li><li>连接迭代器 (列表类型) 或者连接 object 数组均通过 StringBuilderCache 取 StringBuilder 进行</li></ul><p>string.Concat 特有：</p><ul><li>参数为 string，当连接数量级比较低时，直接通过分配一块最终字符串大小内存，通过 unsafe 内存拷贝实现</li><li>参数为 object，当连接数量级比较低时 (3 个以下)， 则直接通过符号连接，超过三个则创建临时数组变量将 object 转字符串，再走正常字符串数组连接方法</li></ul><h4 id="最终可以得出结论"><a class="anchor" href="#最终可以得出结论">#</a> 最终可以得出结论：</h4><p>拼接数量在 2 个：可以使用 + 号<br>拼接数量在 4 个及以下：字符串可以使用 string.concat (非字符串 3 个或以下时直接 + 号拼接，4 个或以上时会生成临时数组变量将 object.tostring，然后调用字符串数组拼接函数处理 —— 调用不定参数方法时也是如此处理)，否则最好 StringBuilder<br>拼接数量在超过 4 个：StringBuilder (不推荐 string.concat 是因为通过可变参数传参它会生成额外临时字符串数组，直接拼接数组时更有优势)<br>连接字符串数组、字符串列表类型：可以用 string.join 或 string.concat (无分隔符)，有特殊回调需求则自定义 StringBuilder (注：内部实际上也是用 StringBuilder 拼接的，不过看 DotNetCore 的源码实现不一样，是创建一个结构体 ValueStringBuilder，通过 stackalloc 在栈上分配 char 数组 (Span) 结构进行拼接)<br>连接其它容器 (比如字典)：StringBuilder</p><p>再解释一下：</p><p>连接字符串在 4 个及以下时，可以通过 string.concat (强调：字符串类型，非字符串可以 toString 传入)<br>字符串数组和字符串列表都可以用 string.join 或 string.concat (内部 StringBuilder ，有对象池)<br>其它类型的数组、列表或字典容器以及超出 4 个单字符串的连接，采用自己 StringBuilder 进行，并且可以缓存这个 StringBuilder 进行重复使用。<br>只有两个字符串拼接，才允许使用符号 +</p><p>(注：上述均表示一次性拼接的前提，若连续多次连接，则 StringBuilder 无疑是最好选择)</p><div class="tags"><a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag"><i class="ic i-tag"></i> 性能优化</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C#</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-12-22 11:29:48" itemprop="dateModified" datetime="2022-12-22T11:29:48+08:00">2022-12-22</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>CWHISME <i class="ic i-at"><em>@</em></i>WangJiaYing</li><li class="link"><strong>本文链接：</strong> <a href="https://wangjiaying.top/2022/10/31/%E5%85%B3%E4%BA%8E%E5%AF%B9%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E7%9A%84%E4%BC%98%E5%8C%96/" title="关于对项目字符串拼接的优化研究">https://wangjiaying.top/2022/10/31/关于对字符串拼接的优化/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/10/26/%E5%9B%BE%E7%89%87%E8%B5%84%E6%BA%90%E6%A0%BC%E5%BC%8F%E8%AE%BE%E7%BD%AE%E6%B5%8B%E8%AF%95%E4%B8%8E%E6%80%BB%E7%BB%93/" itemprop="url" rel="prev" data-background-image="&#x2F;images&#x2F;coverimages&#x2F;large&#x2F;cbf1fb50eea6862a9486e491d9c95dcc_2_2_art.webp" title="图片资源格式设置测试与总结"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 资源设置</span><h3>图片资源格式设置测试与总结</h3></a></div><div class="item right"><a href="/2022/11/03/%E5%85%B3%E4%BA%8E%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E8%BD%AC%E5%8D%81%E8%BF%9B%E5%88%B6/" itemprop="url" rel="next" data-background-image="&#x2F;images&#x2F;coverimages&#x2F;large&#x2F;89342368_p0.webp" title="关于二进制十六进制转十进制与ARGB图片存储格式"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 理论研究</span><h3>关于二进制十六进制转十进制与ARGB图片存储格式</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">1. 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%AC%AC%E4%B8%80%E7%89%88%E4%BC%98%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">2. 第一版优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">3. 性能测试与优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E7%A7%8D%E6%8B%BC%E6%8E%A5%E6%96%B9%E5%BC%8F%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">3.1.</span> <span class="toc-text">四种拼接方式性能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">3.2.</span> <span class="toc-text">平均性能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%AC%AC%E4%BA%8C%E7%89%88%E4%BC%98%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">4. 第二版优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">4.0.1.</span> <span class="toc-text">性能测试：</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#5-stringbuilder-%E6%BA%90%E7%A0%81"><span class="toc-number">5.</span> <span class="toc-text">5. StringBuilder 源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-join-%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81"><span class="toc-number">6.</span> <span class="toc-text">6. Join 部分源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-stringconcat"><span class="toc-number">7.</span> <span class="toc-text">7. string.Concat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-format"><span class="toc-number">8.</span> <span class="toc-text">8. Format</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9-stringformat-%E4%B8%8E%E6%99%AE%E9%80%9A%E6%8B%BC%E6%8E%A5%E7%9A%84%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">8.1.</span> <span class="toc-text">对 string.Format 与普通拼接的性能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">9.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E5%8F%AF%E4%BB%A5%E5%BE%97%E5%87%BA%E7%BB%93%E8%AE%BA"><span class="toc-number">9.0.1.</span> <span class="toc-text">最终可以得出结论：</span></a></li></ol></li></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2017/02/17/%E5%AF%BB%E8%B7%AF%E7%AE%97%E6%B3%95/" rel="bookmark" title="【工具】寻路算法[A*的简析与实现]">【工具】寻路算法[A*的简析与实现]</a></li><li><a href="/2017/02/20/%E6%8A%95%E5%BD%B1%E5%85%AC%E5%BC%8F%E7%9A%84%E6%8E%A8%E5%AF%BC/" rel="bookmark" title="投影公式的推导">投影公式的推导</a></li><li><a href="/2021/03/25/%E5%85%B3%E4%BA%8ESynchronizationContext/" rel="bookmark" title="关于SynchronizationContext的使用">关于SynchronizationContext的使用</a></li><li><a href="/2021/04/15/%E5%B8%A7%E5%90%8C%E6%AD%A5%E6%A6%82%E5%BF%B5/" rel="bookmark" title="帧同步概念">帧同步概念</a></li><li><a href="/2021/04/28/Ado.Net%E4%B8%8EEF6.X%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" rel="bookmark" title="Ado.Net与EF6.X的简单使用">Ado.Net与EF6.X的简单使用</a></li><li><a href="/2021/07/07/%E6%88%98%E6%96%97%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" rel="bookmark" title="关于手游战斗系统">关于手游战斗系统</a></li><li class="active"><a href="/2022/10/31/%E5%85%B3%E4%BA%8E%E5%AF%B9%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E7%9A%84%E4%BC%98%E5%8C%96/" rel="bookmark" title="关于对项目字符串拼接的优化研究">关于对项目字符串拼接的优化研究</a></li><li><a href="/2022/11/03/%E5%85%B3%E4%BA%8E%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E8%BD%AC%E5%8D%81%E8%BF%9B%E5%88%B6/" rel="bookmark" title="关于二进制十六进制转十进制与ARGB图片存储格式">关于二进制十六进制转十进制与ARGB图片存储格式</a></li><li><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" rel="bookmark" title="简单测试手动垃圾回收">简单测试手动垃圾回收</a></li><li><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/" rel="bookmark" title="StringBuilder 扩容规则研究">StringBuilder 扩容规则研究</a></li><li><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/" rel="bookmark" title="协变和逆变">协变和逆变</a></li><li><a href="/2023/02/01/CS-%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" rel="bookmark" title="C#协程的底层原理">C#协程的底层原理</a></li><li><a href="/2023/02/08/%E4%BB%8EIL%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90C-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0%E7%9A%84%E5%8E%9F%E7%90%86/" rel="bookmark" title="从IL代码分析C#匿名函数的原理">从IL代码分析C#匿名函数的原理</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="CWHISME" data-src="/images/../img/avator"><p class="name" itemprop="name">CWHISME</p><div class="description" itemprop="description">✧⁺˚⁺ପ(๑･ω･)੭ु⁾⁾ 好好学习天天向上</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">95</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">20</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">27</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2N3aGlzbWU=" title="https:&#x2F;&#x2F;github.com&#x2F;cwhisme"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9jd2hpc21lLTMzL3Bvc3Rz" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;cwhisme-33&#x2F;posts"><i class="ic i-zhihu"></i></span> <span class="exturl item email" data-url="bWFpbHRvOmN3aGlzbWVAMTI2LmNvbQ==" title="mailto:cwhisme@126.com"><i class="ic i-envelope"></i></span> <a href="/atom.xml" title="&#x2F;atom.xml" class="item feedback"><i class="ic i-heart"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/bookmark/" rel="section"><i class="ic i-tag"></i>书签</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-magic"></i>链接</a><ul class="submenu"><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友達</a></li></ul></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/10/26/%E5%9B%BE%E7%89%87%E8%B5%84%E6%BA%90%E6%A0%BC%E5%BC%8F%E8%AE%BE%E7%BD%AE%E6%B5%8B%E8%AF%95%E4%B8%8E%E6%80%BB%E7%BB%93/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/11/03/%E5%85%B3%E4%BA%8E%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E8%BD%AC%E5%8D%81%E8%BF%9B%E5%88%B6/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Unity3D/" title="分类于 Unity3D">Unity3D</a> <i class="ic i-angle-right"></i> <a href="/categories/Unity3D/%E5%85%B6%E5%AE%83/" title="分类于 其它">其它</a></div><span><a href="/2016/07/01/%E6%A0%B9%E6%8D%AE%E5%9C%B0%E5%BD%A2%E8%B4%B4%E5%9B%BE%E5%AE%9E%E7%8E%B0%E8%84%9A%E5%8D%B0%E5%8F%8A%E7%9B%B8%E5%BA%94%E6%95%88%E6%9E%9C/" title="根据所在地形贴图实现脚印等效果">根据所在地形贴图实现脚印等效果</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%90%86%E8%AE%BA%E7%A0%94%E7%A9%B6/" title="分类于 理论研究">理论研究</a></div><span><a href="/2023/02/01/CS-%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" title="C#协程的底层原理">C#协程的底层原理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%85%B6%E5%AE%83/" title="分类于 其它">其它</a></div><span><a href="/2017/02/08/Git-log%E6%98%BE%E7%A4%BA%E6%A0%BC%E5%BC%8F%E7%9A%84%E4%BF%AE%E6%94%B9/" title="Git log显示格式的修改">Git log显示格式的修改</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment count_3"></ul></div></div><div class="status"><div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">CWHISME @ Jiaying's Note</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">474k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">7:11</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/10/31/关于对字符串拼接的优化/",favicon:{show:"（●´3｀●）",hide:"(´Д｀)"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/js/DateTimeAfeterCalc.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script data-pjax>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?62952472c154f9131a14a4ab57bfefec";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>