<!DOCTYPE html><meta name="viewport" content="height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="cwhisme"><meta name="author" content="CWHISME"><meta property="og:title" content="基本光照模型简析"><meta property="og:description" content="cwhisme"><meta property="og:site_name" content="WangJiaYing"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>基本光照模型简析 - WangJiaYing</title><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/DateTimeAfeterCalc.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/particles-bg.js"></script><script src="https://fastly.jsdelivr.net/gh/CWHISME/live2d_api_models@master/autoload.js"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script type="text/javascript" src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/js/script.js"></script><link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/css/style.css"><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script id="MathJax-script" src="https://fastly.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/tachyons@4.12.0/css/tachyons.min.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="WangJiaYing" type="application/atom+xml">
</head><body><canvas id="hackEffectCanvas" style="position:fixed;z-index:-1;pointer-events:none"></canvas><canvas class="fireworks" style="position:fixed;z-index:10;pointer-events:none"></canvas><div class="w-100 bg-1 ph5-ns ph3 text-light"><nav class="db dt-l w-100 mw8 center border-box pv3"><a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="WangJiaYing"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/logo.svg" class="dib h3" alt="WangJiaYing"></a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">Home </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">Archives </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags" title="Tags">Tags </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/categories" title="Categories">Categories </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/bookmark" title="Bookmark">Bookmark </a><a class="link dim f6 f5-l dib mr3 mr4-l white" href="/about" title="About">About</a></div></nav><div class="w-100 mw8 center vh-40 dt"><div class="dtc v-mid white"><h1 class="f1-l f2-m tc tc-m tl-ns">基本光照模型简析</h1><p class="f4 fw3 pab-100px tc tc-m tl-ns"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2016-05-22&nbsp&nbsp <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="dateTimeAfter">2016-05-22</span></p></div></div><div class="relative w-100 mw8 center white dn dn-m db-ns"><i class="header-icon fa fa-snowflake-o"></i></div></div><div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l"><div class="content"><div class="mw8 center"><div class="cf"><div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content"><div class="tags-container-vertical"><div class="tags-sub-container"><a class="fw3 ph1 dib" href="/tags/Shader/">#Shader</a></div></div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这周被项目主管拉过去谈了一次话，提到这一年多的的进步之类的问题，说我算是进步很大的了——顿时感觉心情UPUP的，相比之前被老板说的没进步之类的话打击后，觉得平复多了。另外还谈到了Shader之类的问题，还问我感不感兴趣之类的？这当然回答“是”了，毕竟现在至少一般应用的话，自我感觉都是没问题的了，不过，我依然没有自大地说：我已经会了，有什么需要的吗？</p><p>毕竟，我目前只是算会用了而已，高级点的，恐怕也依然不足。而且最主要是，不清楚究竟会有什么样的要求？万一刚说自己会，然后叫你实现什么却又不行，那就尴尬了….所以保险起见，想想还是大成之后再透露吧。</p><p>最近一直在研究数学，于是决定暂且回到Shader上，这儿，就回顾一下基础，分析一下基本光照模型。</p><p>基本光照模型，一般由三种颜色合成：环境光、漫反射及镜面高光。</p><p>所以公式一般为：$Color_{final}=Color_{ambient}+Color_{diffuse}+Color_{specialer}$<br>下面会一个个解释。</p><h2 id="环境光"><a href="#环境光" class="headerlink" title="环境光"></a>环境光</h2><h3 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h3><p>这里指的环境光并非物理意义上的那种(因为目前而言，实时处理是一个几乎不可能的任务)，而是指模仿这样的效果，简单使用一个设定好的固定颜色，并让所有物体都被它进行“照明”，所以也被称作“全局漫反射”。一般来说，都是直接将颜色与物体本身的颜色进行混合产生。</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>而在Unity的Shader中，则是提供了一个内置变量UNITY_LIGHTMODEL_AMBIENT作为环境光颜色。而且这个颜色可以在Unity的编辑器-&gt;Lighting中配置。<br>代码如下所示(默认物体颜色为白色)：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fixed4 frag (v2f i) : SV_Target</span><br><span class="line">&#123;</span><br><span class="line">	float4 color=float4(1,1,1,1);</span><br><span class="line">	float4 ambColor=color*UNITY_LIGHTMODEL_AMBIENT;</span><br><span class="line"></span><br><span class="line">	float4 finalColor=ambColor;	</span><br><span class="line">	UNITY_APPLY_FOG(i.fogCoord, finalColor);	</span><br><span class="line">	return finalColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>![效果](https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/oldpictures/2016.5.22-1_Ambient Color.JPG)</p><h2 id="漫反射"><a href="#漫反射" class="headerlink" title="漫反射"></a>漫反射</h2><h3 id="简述-1"><a href="#简述-1" class="headerlink" title="简述"></a>简述</h3><p>漫反射计算了光线与物体顶点的角度，然后对物体颜色做相应的衰减。</p><p>简单来说，它的概念就是：顶点法线与入射光线越角度越一致，那么颜色就越亮，反之则越暗。这个功能简单依靠点积实现，如果结果为负，则将其置为0，即背光面的最终颜色将会变成0(所以如果只有漫反射的话，背光面就只会是黑的，因此才会有前面的环境光)。</p><p>公式也是很简单：</p><p>$$Color_{diff}=max(0,(N \cdot L)) \times Color_o$$</p><h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>在Shader中，因为需要用到法线，因此我们必须在定义的结构体上加上法线相关的语义绑定：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct appdata</span><br><span class="line">&#123;</span><br><span class="line">	float4 vertex : POSITION;</span><br><span class="line">	float4 normal:NORMAL;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>然后在顶点程序中，还需要将法线及顶点坐标转换至世界空间，并将其传入片段程序进行计算。当然这儿直接在顶点程序计算，然后通过插值获得最后结果也是可以的，不过从理论上来说，效果会比在片段中进行计算要差那么一点点(如果是低模的，那就不止差一丁半点了)…所以这儿我选择将数据传入片段程序，然后再行计算。</p><p>所以首先在传入片段程序的结构体v2f中添加两个参数，用于存放法线及光源方向：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float3 N:TEXCOORD0;</span><br><span class="line">float3 L:TEXCOORD1;</span><br></pre></td></tr></table></figure><p>然后在顶点计算中进行赋值：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">float3 wPos=mul(_Object2World,v.vertex).xyz;</span><br><span class="line">			</span><br><span class="line">o.N=mul(float4(v.normal,0),_World2Object).xyz;</span><br><span class="line">o.L=_WorldSpaceLightPos0.xyz;</span><br></pre></td></tr></table></figure><p>需要注意的是对法线的转换，因为对法线的转换时不能使用与顶点一样的矩阵进行的，而是使用世界矩阵转置的逆矩阵进行，我们通过右乘世界矩阵的逆矩阵实现。至于原因的话，百度一下应该就可以找到比较详细解释，这只是提示一下而已。</p><p>然后在片段程序中，使用法线与光源方向计算漫反射，并添加到最后的颜色贡献中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">float4 diffColor=color*max(0,dot(normalize(i.N),normalize(i.L)))*_LightColor0;</span><br><span class="line">			</span><br><span class="line">float4 finalColor=ambColor+diffColor;	</span><br></pre></td></tr></table></figure><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/oldpictures/2016.5.22-2_Diffuse_Color.JPG" alt="效果(左边是Unity自带的Shader，左边是我们自定义的)"></p><h2 id="镜面反射"><a href="#镜面反射" class="headerlink" title="镜面反射"></a>镜面反射</h2><h3 id="简述-2"><a href="#简述-2" class="headerlink" title="简述"></a>简述</h3><p>一般在比较光滑的表面，我们都会注意到一些高光，并且随着我们视线角度的不同，都会产生一定的变化，而且，几乎所有物体都是具有这个属性的。比如说，现在盯着你的键盘看一下，每个按键上边，是不是都有一点油亮的感觉呢？而且低一下头、转一下头，这些发亮区域还会发生变化。</p><p>这就是镜面反射。</p><p>由此我们也可以清楚地知道，首先它肯定是与我们视线相关，其次，与物体表面的光滑程度相关，最后，当然就是与光线相关了。这东西其实也是属于经验公式，即并不完全符合物理，但却可以带来相似的视觉效果。刚才我们通过“体验”，应当大约明白这是个什么样子了吧？</p><h3 id="推导"><a href="#推导" class="headerlink" title="推导"></a>推导</h3><p>先看一下图(手绘的，不要在意细节)：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/oldpictures/2016.5.22-7_Specialer_Dec.jpg" alt="镜面反射"></p><p>相比其它的计算方式，镜面反射主要就是反射向量R计算起来比较麻烦一点。<br>因为很久以前听说，市面上挺流行考这个问题的，所以当年还是仔细研究过的，毕竟背公式什么的，就太Low了，要画个草图，就明白过程才是。那么，让我们来仔细推导一下吧，要知道这算还算是图形学里边比较简单的了。</p><p>在上面的那个简图中，我们可以把这三个方向向量看作两个三角形提取出来，如图所示：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/oldpictures/2016.5.22-3_Reflect_Calc.jpg" alt="三角形"></p><p>那么，我们只需要先计算出这个“大三角形”的“底”的向量，无论是R到L还是L到R的方向，都可以通过L与其计算出最后的R。那么，这儿我就设L到R方向的“底”为K，那么$R=L+K$。<br>OK，大致方向就是这样了，那么第一个就是计算光源L在法线N上的投影(我们设其为M)，也就是这两个三角形的“高”，之后即可通过M-L计算出其中一个三角形的“底”向量，将这个“底”乘以2，就是光源到R的向量。首先，我们都知道$A \cdot B=|A||B|Cos\theta$，同时由于我们这儿计算的向量都是经过规范化的，如此$|A||B|=1$，就可以直接略过了。<br>剩下的$Cos\theta$就是M的长度，这时候，只需要再乘以法向量N，就计算出向量M了。<br>然后<br>$$(M-L) \times 2=K$$<br>$$K+L=R$$<br>即最终公式为：<br>$$((L \cdot N) \times N-L) \times 2+L=R$$<br>化简之后可得：<br>$$2N \times (L \cdot N)-L=R$$</p><p>这就是经典的Phong模型计算公式了——才怪——要知道我们这才刚计算出反射向量呢，接下来就是将反射R实际运用起来了。<br>刚开始我们就提到过，镜面反射肯定与视线也是相关的，也就是我们看过去的方向和反射光线的方向，即取决于反射向量R与视线V的夹角，跟上边的漫反射N与L的关系有点类似：当两者方向越接近时越亮，反之则越暗，不过多了一个高光指数用于控制高亮区域大小之类的。</p><p>公式如下：<br>$$Color_{specialer}=Color_{reflect}*(V \cdot R)^{power}$$</p><h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><h4 id="Phong模型"><a href="#Phong模型" class="headerlink" title="Phong模型"></a>Phong模型</h4><p>如果已经明白了原理的话，那么实现起来，就相当简单了。<br>上面实现漫反射过程中，已经将光源方向机法线方向都传入了片段程序，因为镜面高光的实现还需要一个“视线”，也就是相机的方向，在Unity中，则可由内置变量“_worldSpaceCameraPos”提供。</p><p>为了向片段程序再传入一个视线方向，所以得在结构体v2f中再加一个参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">float3 V:TEXCOORD2;</span><br></pre></td></tr></table></figure><p>然后在顶点程序中，因为主要计算在片段程序中，所以也是一句代码搞定：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">o.V=_WorldSpaceCameraPos-wPos;</span><br></pre></td></tr></table></figure><p>来到片段程序，首先将相机方向进行归一化处理，然后通过上述公式计算反射向量R，并通过Phong公式计算最终镜面高光。最后，将所有的颜色加上去：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">float3 V=normalize(i.V);</span><br><span class="line">float3 R=normalize(2*N*(dot(N,L))-L)</span><br><span class="line">float4 specColor=_SpColor*pow(saturate(dot(V,R)),_SpPower);</span><br><span class="line"></span><br><span class="line">float4 finalColor=ambColor+diffColor+specColor;	</span><br></pre></td></tr></table></figure><p>效果：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/oldpictures/2016.5.22-4_Specialer_Color.JPG" alt="镜面反射效果(左StandarShader，左边是我们自定义的)"></p><p>这个光似乎显得太“硬”了…所以可以在最后计算出来的镜面高光中，乘上一个值对其进行缩放：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">float4 specColor=_SpColor.a*_SpColor*pow(saturate(dot(V,R)),_SpPower);</span><br></pre></td></tr></table></figure><p>在这儿我使用了镜面颜色的Alpha值作为这个参数，之所以这样，跟Unity5内置的高光相比，显得太过难看，而且有些版本的镜面高光就有这个缩放参数。它可以将其柔和化。另外使用Alpha则是因为它在整个计算中根本没用，本着性能和废物利用的想法，就把它当作缩放参数来调整了。</p><p>效果：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/oldpictures/2016.5.22-5_Specialer_Color2.JPG" alt="镜面反射效果2(左StandarShader，左边是我们自定义的)"></p><p>另外，其实计算反射的方法，CG中就已经内置了函数“reflect(R,N)”进行计算，主要注意传入的光源参数是指光源到顶点的方向就可以了。</p><h4 id="Blinn模型"><a href="#Blinn模型" class="headerlink" title="Blinn模型"></a>Blinn模型</h4><p>上面的是Phong模型，另外还有一个Blinn模型也是用来计算镜面高光的，公式如下：<br>$$H=L+V$$<br>$$Color_{specialer}=Color_{reflect}*(H \cdot N)^{power}$$</p><p>可以稍微看看在下的拙图：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/oldpictures/2016.5.22-8_Specialer_Dec_Blinn.jpg" alt="Blinn描绘"></p><p>其中H是半角向量，指的是光源方向和视线的中间向量，除了其中点乘的两个参数换了，其它的跟Phong模型基本一致。不过由于半角向量的计算比Phong模型的反射向量R计算少了些计算步骤，所以性能上会好些，另外的区别自己比较下就知道了(后面我会上源码，大家可以取消相应的注释进行测试)。</p><p>代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">float4 specColor=_SpColor.a*_SpColor*pow(saturate(dot(N,normalize(L+V))),_SpPower);</span><br></pre></td></tr></table></figure><p>其实我觉得Unity5内置的Standard Shader就是使用的Blinn模型，我还是上一张比较能看出区别的侧视图吧：</p><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/oldpictures/2016.5.22-6_Specialer_Color3.JPG" alt="Phong模型与Blinn模型比较(左StandarShader，左边是我们自定义的)"></p><p>看出区别了吗？</p><h2 id="点光源处理"><a href="#点光源处理" class="headerlink" title="点光源处理"></a>点光源处理</h2><p>最后的最后，就是对点光源的处理了。<br>之前那些处理过程，在Unity中都只针对第一个平行光源有效，所以为了支持点光源的话，还得多做一些处理。不过也都是些比较简单小改造。</p><p>在Unity中，点光源的渲染是通过在Shader中叫做“ForwardAdd”的第二个Pass进行，之前的我们的工作只能算是完成了第一个Pass，也就是“ForwardBase”。不过也不用担心，这两个Pass的内容区别也不是很大，只需要在前面的第一个Pass中进行些许修改，就可以挪到第二个Pass中了。这也是Unity的设定，而我们只需在Pass当先的LightModel设定好，那么它就可以工作了。</p><p>另外，我们要知道点光源与平行光源是不一样的！</p><ol><li><p>最大的不同就是：点光源是有距离，而平行光在游戏中，是不算距离的。那么在此，计算点光源的时候，就得通过计算点光源的距离，而对其照明进行衰减。我们可以直接通过计算光源的距离，然后传入片段程序：<br>结构体v2f加入衰减值：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">float atten:TEXCOORD3;</span><br></pre></td></tr></table></figure><p>计算衰减(注意与平行光计算的不同之处)：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">o.L=_WorldSpaceLightPos0.xyz-wPos;</span><br><span class="line">o.atten=1/length(o.L);</span><br></pre></td></tr></table></figure></li><li><p>还有一点需要注意的就是，第二个Pass当先还需要使用Blend命令使其与第一个Pass计算出来的结果混合。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Blend One One</span><br></pre></td></tr></table></figure><p>效果：</p></li></ol><p><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/blogimages/oldpictures/2016.5.22-9_Add_PointLight.JPG" alt="加入点光源支持效果(左StandarShader，左边是我们自定义的)"></p><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">//Author:CWHISME</span><br><span class="line">//Date:2016.5.22</span><br><span class="line">//Decription:基本光照模型</span><br><span class="line">Shader &quot;CWH/Base Light Model&quot;</span><br><span class="line">&#123;</span><br><span class="line">	Properties</span><br><span class="line">	&#123;</span><br><span class="line">		_SpColor (&quot;Specialer Color&quot;, COLOR) = (1,1,1,1)</span><br><span class="line">		_SpPower(&quot;Specialer Power&quot;,FLOAT)=1</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	SubShader</span><br><span class="line">	&#123;</span><br><span class="line">		Tags &#123; &quot;RenderType&quot;=&quot;Opaque&quot; &#125;</span><br><span class="line">		LOD 100</span><br><span class="line"></span><br><span class="line">		Pass</span><br><span class="line">		&#123;</span><br><span class="line">			Tags&#123;&quot;LightMode&quot;=&quot;ForwardBase&quot;&#125;</span><br><span class="line">			CGPROGRAM</span><br><span class="line">			#pragma vertex vert</span><br><span class="line">			#pragma fragment frag</span><br><span class="line">			// make fog work</span><br><span class="line">			#pragma multi_compile_fog</span><br><span class="line">			</span><br><span class="line">			#include &quot;UnityCG.cginc&quot;</span><br><span class="line">			#include &quot;Lighting.cginc&quot;</span><br><span class="line"></span><br><span class="line">			uniform float4 _SpColor;</span><br><span class="line">			uniform float _SpPower;</span><br><span class="line"></span><br><span class="line">			struct appdata</span><br><span class="line">			&#123;</span><br><span class="line">				float4 vertex : POSITION;</span><br><span class="line">				float3 normal:NORMAL;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			struct v2f</span><br><span class="line">			&#123;</span><br><span class="line">				UNITY_FOG_COORDS(1)</span><br><span class="line">				float4 vertex : SV_POSITION;</span><br><span class="line">				float3 N:TEXCOORD0;</span><br><span class="line">				float3 L:TEXCOORD1;</span><br><span class="line">				float3 V:TEXCOORD2;</span><br><span class="line">			&#125;;</span><br><span class="line">			</span><br><span class="line">			v2f vert (appdata v)</span><br><span class="line">			&#123;</span><br><span class="line">				v2f o;</span><br><span class="line">				o.vertex = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">				</span><br><span class="line">				float3 wPos=mul(_Object2World,v.vertex).xyz;</span><br><span class="line">				</span><br><span class="line">				o.N=mul(float4(v.normal,0),_World2Object).xyz;</span><br><span class="line">				o.L=_WorldSpaceLightPos0.xyz;</span><br><span class="line">				o.V=_WorldSpaceCameraPos-wPos;</span><br><span class="line">				</span><br><span class="line">				UNITY_TRANSFER_FOG(o,o.vertex);</span><br><span class="line">				return o;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			fixed4 frag (v2f i) : SV_Target</span><br><span class="line">			&#123;</span><br><span class="line">				float4 color=float4(1,1,1,1);</span><br><span class="line">				float4 ambColor=color*UNITY_LIGHTMODEL_AMBIENT;</span><br><span class="line">				</span><br><span class="line">				float3 N=normalize(i.N);</span><br><span class="line">				float3 L=normalize(i.L);</span><br><span class="line">				float3 V=normalize(i.V);</span><br><span class="line">				float4 diffColor=color*max(0,dot(N,L))*_LightColor0;</span><br><span class="line">				float3 R=normalize(2*N*(dot(N,L))-L);</span><br><span class="line">				//float4 specColor=_SpColor.a*_SpColor*pow(saturate(dot(N,normalize(L+V))),_SpPower);</span><br><span class="line">				float4 specColor=_SpColor.a*_SpColor*pow(saturate(dot(V,R)),_SpPower);</span><br><span class="line">				</span><br><span class="line">				float4 finalColor=ambColor+diffColor+specColor;	</span><br><span class="line">				UNITY_APPLY_FOG(i.fogCoord, finalColor);	</span><br><span class="line">				return finalColor;</span><br><span class="line">			&#125;</span><br><span class="line">			ENDCG</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		//计算点光源</span><br><span class="line">		Pass</span><br><span class="line">		&#123;</span><br><span class="line">			Tags&#123;&quot;LightMode&quot;=&quot;ForwardAdd&quot;&#125;</span><br><span class="line">			Blend One One</span><br><span class="line">			CGPROGRAM</span><br><span class="line">			#pragma vertex vert</span><br><span class="line">			#pragma fragment frag</span><br><span class="line">			</span><br><span class="line">			#include &quot;UnityCG.cginc&quot;</span><br><span class="line">			#include &quot;Lighting.cginc&quot;</span><br><span class="line"></span><br><span class="line">			uniform float4 _SpColor;</span><br><span class="line">			uniform float _SpPower;</span><br><span class="line"></span><br><span class="line">			struct appdata</span><br><span class="line">			&#123;</span><br><span class="line">				float4 vertex : POSITION;</span><br><span class="line">				float3 normal:NORMAL;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			struct v2f</span><br><span class="line">			&#123;</span><br><span class="line">				float4 vertex : SV_POSITION;</span><br><span class="line">				float3 N:TEXCOORD0;</span><br><span class="line">				float3 L:TEXCOORD1;</span><br><span class="line">				float3 V:TEXCOORD2;</span><br><span class="line">				float atten:TEXCOORD3;</span><br><span class="line">			&#125;;</span><br><span class="line">			</span><br><span class="line">			v2f vert (appdata v)</span><br><span class="line">			&#123;</span><br><span class="line">				v2f o;</span><br><span class="line">				o.vertex = mul(UNITY_MATRIX_MVP, v.vertex);</span><br><span class="line">				</span><br><span class="line">				float3 wPos=mul(_Object2World,v.vertex).xyz;</span><br><span class="line">				</span><br><span class="line">				o.N=mul(float4(v.normal,0),_World2Object).xyz;</span><br><span class="line">				o.L=_WorldSpaceLightPos0.xyz-wPos;</span><br><span class="line">				o.atten=1/length(o.L);</span><br><span class="line">				o.V=_WorldSpaceCameraPos-wPos;</span><br><span class="line">				</span><br><span class="line">				return o;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			fixed4 frag (v2f i) : SV_Target</span><br><span class="line">			&#123;</span><br><span class="line">				float4 color=float4(1,1,1,1);</span><br><span class="line">				float4 ambColor=color*UNITY_LIGHTMODEL_AMBIENT;</span><br><span class="line">				</span><br><span class="line">				float3 N=normalize(i.N);</span><br><span class="line">				float3 L=normalize(i.L);</span><br><span class="line">				float3 V=normalize(i.V);</span><br><span class="line">				float4 diffColor=color*max(0,dot(N,L))*_LightColor0*i.atten;</span><br><span class="line">				float3 R=normalize(2*N*(dot(N,L))-L);</span><br><span class="line">				//float4 specColor=_SpColor.a*_SpColor*pow(saturate(dot(N,normalize(L+V))),_SpPower);</span><br><span class="line">				float4 specColor=_SpColor.a*_SpColor*pow(saturate(dot(V,R)),_SpPower)*i.atten;</span><br><span class="line">				</span><br><span class="line">				float4 finalColor=ambColor+diffColor+specColor;	</span><br><span class="line">				return finalColor;</span><br><span class="line">			&#125;</span><br><span class="line">			ENDCG</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><p>好了，总算差不多完了！</p><p>写写停停，可不止花了一两天…唉~时间啊….</p><p>这就是目前多数游戏中使用的最基本的光照模型了，稍微分析了下，也算是复习下基础了。</p><div class="tags-container-bottom"><i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/Shader/">#Shader</a></div><br><br><hr><script type="text/javascript" src="https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MsaVbSzIr9cIfikihDExdun9-gzGzoHsz",appKey:"Bj6SEFUBomrLOTWx9B8S6zQH",placeholder:"请输入评论内容~",avatar:"mp",visitor:!1})</script></div><div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50"><hr class="dn-l mw4 black-50 mt5"><div class="mt5 mt0-l site-author"><article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3"><div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width:6rem"><img src="https://fastly.jsdelivr.net/gh/CWHISME/CWHISME.github.io@master/img/photo.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="CWHISME"></div><div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">悲观主义的末日</div></article></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>分类</h3><p><a href="/categories/图形学/">图形学</a></p></div><hr class="dn-l mw4 black-50 mt5"><div class="mt5 tc tl-l"><h3>近期文章</h3><p><a href="/2022/12/10/%E5%8D%8F%E5%8F%98%E5%92%8C%E9%80%86%E5%8F%98/">协变和逆变</a></p><p><a href="/2022/12/06/Unity%E7%9A%84%E9%98%B4%E5%BD%B1%E4%B8%8E%E5%85%89%E7%85%A7%E7%83%98%E7%84%99/">Unity 的阴影与光照烘焙</a></p><p><a href="/2022/11/23/%E6%89%93%E5%8C%85AssetBundle%E5%9F%BA%E7%A1%80%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86/">打包 AssetBundle 的基础规则整理</a></p><p><a href="/2022/11/18/StringBuilder%E6%89%A9%E5%AE%B9%E8%A7%84%E5%88%99%E7%A0%94%E7%A9%B6/">StringBuilder 扩容规则研究</a></p><p><a href="/2022/11/17/%E6%B5%8B%E8%AF%95%E6%89%8B%E5%8A%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">简单测试手动垃圾回收</a></p></div></div></div></div></div></div><div class="bg-1 ph2 ph5-ns pv5"><div class="mv8"><div class="center tc"><div class="dib mh3"><a class="f3 f2-ns white dim" href="https://github.com/CWHISME" target="_blank"><i class="fa fa-github"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="mailto:cwhisme@126.com" target="_blank"><i class="fa fa-envelope"></i></a></div><div class="dib mh3"><a class="f3 f2-ns white dim" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div><div class="f6 f5-ns center tc white pt5 fw3">Copyright © 2021 | Design & Hexo <a class="link dim white" target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-anodyne/">Jonathan Klughertz</a> | Modify By CWHISME</div></div></div></body></html>